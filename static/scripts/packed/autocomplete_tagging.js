function init_tag_click_function(b,a){$(b).find(".tag-name").each(function(){$(this).click(function(){var d=$(this).text();var c=d.split(":");a(c[0],c[1]);return true})})}jQuery.fn.autocomplete_tagging=function(p){var g={get_toggle_link_text_fn:function(q){var s="";var r=o(q);if(r!=0){s=r+(r!=0?" Tags":" Tag")}else{s="Add tags"}return s},tag_click_fn:function(q,r){},editable:true,input_size:20,in_form:false,tags:{},use_toggle_link:true,item_id:"",add_tag_img:"",add_tag_img_rollover:"",delete_tag_img:"",ajax_autocomplete_tag_url:"",ajax_retag_url:"",ajax_delete_tag_url:"",ajax_add_tag_url:""};var e=jQuery.extend(g,p);var o=function(q){if(q.length){return q.length}var r=0;for(element in q){r++}return r};var h=$(this);var c=h.find(".tag-area");var f=h.find(".toggle-link");var b=h.find(".tag-input");var n=h.find(".add-tag-button");f.click(function(){var q=(c.css("display")=="none");var r;if(q){r=function(){var s=$(this).find(".tag-button").length;if(s==0){c.click()}}}else{r=function(){c.blur()}}c.slideToggle("fast",r);return $(this)});if(e.editable){b.hide()}b.keyup(function(v){if(v.keyCode==27){$(this).trigger("blur")}else{if((v.keyCode==13)||(v.keyCode==188)||(v.keyCode==32)){new_value=this.value;if(return_key_pressed_for_autocomplete==true){return_key_pressed_for_autocomplete=false;return false}if(new_value.indexOf(": ",new_value.length-2)!=-1){this.value=new_value.substring(0,new_value.length-1);return false}if((v.keyCode==188)||(v.keyCode==32)){new_value=new_value.substring(0,new_value.length-1)}new_value=new_value.replace(/^\s+|\s+$/g,"");if(new_value.length<2){return false}this.value="";var s=k(new_value);var r=c.children(".tag-button");if(r.length!=0){var w=r.slice(r.length-1);w.after(s)}else{c.prepend(s)}var q=new_value.split(":");e.tags[q[0]]=q[1];var t=e.get_toggle_link_text_fn(e.tags);f.text(t);var u=$(this);$.ajax({url:e.ajax_add_tag_url,data:{new_tag:new_value},error:function(){s.remove();delete e.tags[q[0]];var x=e.get_toggle_link_text_fn(e.tags);f.text(x);alert("Add tag failed")},success:function(){u.flushCache()}});return false}}});var j=function(s,r,q,u,t){tag_name_and_value=u.split(":");return(tag_name_and_value.length==1?tag_name_and_value[0]:tag_name_and_value[1])};var i={selectFirst:false,formatItem:j,autoFill:false,highlight:false};b.autocomplete(e.ajax_autocomplete_tag_url,i);h.find(".delete-tag-img").each(function(){d($(this))});init_tag_click_function($(this),e.tag_click_fn);n.click(function(){$(this).hide();c.click();return false});if(e.editable){c.blur(function(q){num_tags=o(e.tags);if(num_tags!=0){n.show();b.hide();c.removeClass("active-tag-area");c.addClass("tooltip")}else{}});c.click(function(s){var r=$(this).hasClass("active-tag-area");if($(s.target).hasClass("delete-tag-img")&&!r){return false}if($(s.target).hasClass("tag-name")&&!r){return false}$(this).removeClass("tooltip");$(this).addClass("active-tag-area");n.hide();b.show();b.focus();var q=function(u){var t=c.attr("id");if(($(u.target).attr("id")!=t)&&($(u.target).parents().filter(t).length==0)){c.blur();$(document).unbind("click",q);$(this).addClass("tooltip")}};$(window).click(q);return false})}if(e.use_toggle_link){c.hide()}else{}function l(r,q){return r+((q!=""&&q)?":"+q:"")}function d(q){$(q).mouseenter(function(){$(this).attr("src",e.delete_tag_img_rollover)});$(q).mouseleave(function(){$(this).attr("src",e.delete_tag_img)});$(q).click(function(){var w=$(this).parent();var v=w.find(".tag-name").eq(0);var u=v.text();var s=m(u);var y=s[0];var r=s[1];var x=w.prev();w.remove();delete e.tags[y];var t=e.get_toggle_link_text_fn(e.tags);f.text(t);$.ajax({url:e.ajax_delete_tag_url,data:{tag_name:y},error:function(){e.tags[y]=r;if(x.hasClass("tag-button")){x.after(w)}else{c.prepend(w)}var z=e.get_toggle_link_text_fn(e.tags);alert("Remove tag failed");f.text(z);q.mouseenter(function(){$(this).attr("src",e.delete_tag_img_rollover)});q.mouseleave(function(){$(this).attr("src",e.delete_tag_img)})},success:function(){}});return true})}function a(q){var r=new Array();for(key in q){r[r.length]=key+"-->"+q[key]}return"{"+r.join(",")+"}"}function m(q){return q.split(":")}function k(q){var r=$("<img src='"+e.delete_tag_img+"'/>").addClass("delete-tag-img");d(r);var s=$("<span>").text(q).addClass("tag-name");s.click(function(){tag_name_and_value=q.split(":");e.tag_click_fn(tag_name_and_value[0],tag_name_and_value[1]);return true});var t=$("<span></span>").addClass("tag-button");t.append(s);if(e.editable){t.append(r)}return t}};