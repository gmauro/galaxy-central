define(["libs/underscore","libs/d3","viz/visualization"],function(g,j,h){var k=Backbone.Model.extend({is_visible:function(o,l){var m=o.getBoundingClientRect(),n=$("svg")[0].getBoundingClientRect();if(m.right<0||m.left>n.right||m.bottom<0||m.top>n.bottom){return false}return true}});var c=Backbone.Model.extend({defaults:{prefs:{color:"#ccc"}}});var a=Backbone.View.extend({className:"circster",initialize:function(l){this.total_gap=l.total_gap;this.genome=l.genome;this.dataset_arc_height=l.dataset_arc_height;this.track_gap=5;this.label_arc_height=20;this.scale=1;this.track_views=null;this.model.get("tracks").on("add",this.add_track,this);this.model.get("tracks").on("remove",this.remove_track,this)},get_tracks_bounds:function(){var n=this.dataset_arc_height,l=Math.min(this.$el.width(),this.$el.height()),p=l/2-this.model.get("tracks").length*(this.dataset_arc_height+this.track_gap)-(this.label_arc_height+this.track_gap),o=j.range(p,l/2,this.dataset_arc_height+this.track_gap);var m=this;return g.map(o,function(q){return[q,q+m.dataset_arc_height]})},render:function(){var o=this,q=this.dataset_arc_height,r=o.$el.width(),l=o.$el.height(),p=this.model.get("tracks"),s=this.get_tracks_bounds(),n=j.select(o.$el[0]).append("svg").attr("width",r).attr("height",l).attr("pointer-events","all").append("svg:g").call(j.behavior.zoom().on("zoom",function(){var t=j.event.scale;n.attr("transform","translate("+j.event.translate+") scale("+t+")");if(o.scale!==t){if(o.zoom_drag_timeout){clearTimeout(o.zoom_drag_timeout)}o.zoom_drag_timeout=setTimeout(function(){g.each(o.track_views,function(u){u.update_scale(t)})},400)}})).attr("transform","translate("+r/2+","+l/2+")").append("svg:g").attr("class","tracks");this.track_views=p.map(function(t,u){track_view_class=(t.get("track_type")==="LineTrack"?d:e);return new track_view_class({el:n.append("g")[0],track:t,radius_bounds:s[u],genome:o.genome,total_gap:o.total_gap})});g.each(this.track_views,function(t){t.render()});var m=s[p.length];m[1]=m[0];this.label_track_view=new b({el:n.append("g")[0],track:new c(),radius_bounds:m,genome:o.genome,total_gap:o.total_gap});this.label_track_view.render()},add_track:function(p){var o=this.get_tracks_bounds();g.each(this.track_views,function(r,s){r.update_radius_bounds(o[s])});var n=this.track_views.length,q=(p.get("track_type")==="LineTrack"?d:e),l=new q({el:j.select("g.tracks").append("g")[0],track:p,radius_bounds:o[n],genome:this.genome,total_gap:this.total_gap});l.render();this.track_views.push(l);var m=o[o.length-1];m[1]=m[0];this.label_track_view.update_radius_bounds(m)},remove_track:function(m,o,n){var l=this.track_views[n.index];this.track_views.splice(n.index,1);l.$el.remove();var p=this.get_tracks_bounds();g.each(this.track_views,function(q,r){q.update_radius_bounds(p[r])})}});var i=Backbone.View.extend({tagName:"g",initialize:function(l){this.bg_stroke="ccc";this.loading_bg_fill="000";this.bg_fill="ccc";this.total_gap=l.total_gap;this.track=l.track;this.radius_bounds=l.radius_bounds;this.genome=l.genome;this.chroms_layout=this._chroms_layout();this.data_bounds=[];this.scale=1;this.parent_elt=j.select(this.$el[0])},render:function(){var p=this.parent_elt;if(!p){console.log("no parent elt")}var o=this.chroms_layout,r=j.svg.arc().innerRadius(this.radius_bounds[0]).outerRadius(this.radius_bounds[1]),l=p.selectAll("g").data(o).enter().append("svg:g"),n=l.append("path").attr("d",r).attr("class","chrom-background").style("stroke",this.bg_stroke).style("fill",this.loading_bg_fill);n.append("title").text(function(t){return t.data.chrom});var m=this,q=m.track.get("data_manager"),s=(q?q.data_is_ready():true);$.when(s).then(function(){$.when(m._render_data(p)).then(function(){n.style("fill",m.bg_fill)})})},update_radius_bounds:function(m){this.radius_bounds=m;var l=j.svg.arc().innerRadius(this.radius_bounds[0]).outerRadius(this.radius_bounds[1]);this.parent_elt.selectAll("g>path.chrom-background").transition().duration(1000).attr("d",l);this._transition_chrom_data()},update_scale:function(o){var n=this.scale;this.scale=o;if(o<=n){return}var m=this,l=new k();this.parent_elt.selectAll("path.chrom-data").filter(function(q,p){return l.is_visible(this)}).each(function(v,r){var u=j.select(this),q=u.attr("chrom"),t=m.genome.get_chrom_region(q),s=m.track.get("data_manager"),p;if(!s.can_get_more_detailed_data(t)){return}p=m.track.get("data_manager").get_more_detailed_data(t,"Coverage",0,o);$.when(p).then(function(z){u.remove();m._update_data_bounds();var y=g.find(m.chroms_layout,function(A){return A.data.chrom===q});var w=m.track.get("prefs"),x=w.block_color;if(!x){x=w.color}m._render_chrom_data(m.parent_elt,y,z).style("stroke",x).style("fill",x)})});return m},_transition_chrom_data:function(){var m=this.track,o=this.chroms_layout,l=this.parent_elt.selectAll("g>path.chrom-data"),p=l[0].length;if(p>0){var n=this;$.when(m.get("data_manager").get_genome_wide_data(this.genome)).then(function(r){var q=g.reject(g.map(r,function(s,t){var u=null,v=n._get_path_function(o[t],s);if(v){u=v(s.data)}return u}),function(s){return s===null});l.each(function(t,s){j.select(this).transition().duration(1000).attr("d",q[s])})})}},_update_data_bounds:function(){var l=this.data_bounds;this.data_bounds=this.get_data_bounds(this.track.get("data_manager").get_genome_wide_data(this.genome));if(this.data_bounds[0]<l[0]||this.data_bounds[1]>l[1]){this._transition_chrom_data()}},_render_data:function(o){var n=this,m=this.chroms_layout,l=this.track,p=$.Deferred();$.when(l.get("data_manager").get_genome_wide_data(this.genome)).then(function(s){n.data_bounds=n.get_data_bounds(s);layout_and_data=g.zip(m,s),chroms_data_layout=g.map(layout_and_data,function(t){var u=t[0],v=t[1];return n._render_chrom_data(o,u,v)});var q=l.get("config"),r=q.get_value("block_color");if(!r){r=q.get_value("color")}n.parent_elt.selectAll("path.chrom-data").style("stroke",r).style("fill",r);p.resolve(o)});return p},_render_chrom_data:function(l,m,n){},_get_path_function:function(m,l){},_chroms_layout:function(){var m=this.genome.get_chroms_info(),o=j.layout.pie().value(function(q){return q.len}).sort(null),p=o(m),l=this.total_gap/m.length,n=g.map(p,function(s,r){var q=s.endAngle-l;s.endAngle=(q>s.startAngle?q:s.startAngle);return s});return n}});var b=i.extend({initialize:function(l){i.prototype.initialize.call(this,l);this.bg_stroke="fff";this.bg_fill="fff"},_render_data:function(m){var l=m.selectAll("g");l.selectAll("path").attr("id",function(n){return"label-"+n.data.chrom});l.append("svg:text").filter(function(n){return n.endAngle-n.startAngle>0.08}).attr("text-anchor","middle").append("svg:textPath").attr("xlink:href",function(n){return"#label-"+n.data.chrom}).attr("startOffset","25%").text(function(n){return n.data.chrom})}});var f=i.extend({_render_chrom_data:function(l,o,m){var p=this._get_path_function(o,m);if(!p){return null}var n=l.datum(m.data),q=n.append("path").attr("class","chrom-data").attr("chrom",o.data.chrom).attr("d",p);return q},_get_path_function:function(o,n){if(typeof n==="string"||!n.data||n.data.length===0){return null}var l=j.scale.linear().domain(this.data_bounds).range(this.radius_bounds);var p=j.scale.linear().domain([0,n.data.length]).range([o.startAngle,o.endAngle]);var m=j.svg.line.radial().interpolate("linear").radius(function(q){return l(q[1])}).angle(function(r,q){return p(q)});return j.svg.area.radial().interpolate(m.interpolate()).innerRadius(l(0)).outerRadius(m.radius()).angle(m.angle())},get_data_bounds:function(l){}});var e=f.extend({get_data_bounds:function(m){var l=g.map(m,function(n){if(typeof n==="string"||!n.max){return 0}return n.max});return[0,(l&&typeof l!=="string"?g.max(l):0)]}});var d=f.extend({get_data_bounds:function(m){var l=g.flatten(g.map(m,function(n){if(n){return g.map(n.data,function(o){return o[1]})}else{return 0}}));return[g.min(l),g.max(l)]}});return{CircsterView:a}});