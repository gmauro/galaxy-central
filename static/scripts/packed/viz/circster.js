define(["libs/d3","viz/visualization"],function(d,e){var c=function(){this.initialize&&this.initialize.apply(this,arguments)};c.extend=Backbone.Model.extend;var b=Backbone.View.extend({className:"circster",initialize:function(h){this.total_gap=h.total_gap;this.genome=h.genome;this.dataset_arc_height=h.dataset_arc_height;this.track_gap=5},render:function(){var j=this,l=this.dataset_arc_height,m=j.$el.width(),h=j.$el.height(),k=(Math.min(m,h)/2-this.model.get("tracks").length*(this.dataset_arc_height+this.track_gap));var i=d.select(j.$el[0]).append("svg").attr("width",m).attr("height",h).attr("pointer-events","all").append("svg:g").call(d.behavior.zoom().on("zoom",function(){i.attr("transform","translate("+d.event.translate+") scale("+d.event.scale+")")})).attr("transform","translate("+m/2+","+h/2+")").append("svg:g");this.model.get("tracks").each(function(n,p){var q=n.get("genome_wide_data"),r=k+p*(l+j.track_gap),o=(q instanceof e.GenomeWideBigWigData?f:CircsterSummaryTreeTrackRenderer);track_renderer=new o({track:n,radius_start:r,radius_end:r+l,genome:j.genome,total_gap:j.total_gap});track_renderer.render(i)})}});var a=c.extend({initialize:function(h){this.options=h},render:function(i){genome_arcs=this.chroms_layout(),chroms_arcs=this.genome_data_layout();var n=this.options.radius_start,l=this.options.radius_end,o=i.append("g").attr("id","inner-arc"),m=d.svg.arc().innerRadius(n).outerRadius(l),h=o.selectAll("#inner-arc>path").data(genome_arcs).enter().append("path").attr("d",m).style("stroke","#ccc").style("fill","#ccc").append("title").text(function(p){return p.data.chrom});var j=this.options.track.get("prefs"),k=j.block_color;_.each(chroms_arcs,function(p){if(!p){return}var s=i.append("g"),r=d.svg.arc().innerRadius(n),q=s.selectAll("path").data(p).enter();q.append("path").attr("d",r).style("stroke",k)})},chroms_layout:function(){var i=this.options.genome.get_chroms_info(),k=d.layout.pie().value(function(m){return m.len}).sort(null),l=k(i),h=this.options.total_gap/i.length,j=_.map(l,function(o,n){var m=o.endAngle-h;o.endAngle=(m>o.startAngle?m:o.startAngle);return o});return j},chrom_data_layout:function(k,j,i,l,h){},genome_data_layout:function(){var i=this,h=this.chroms_layout(),m=this.options.track.get("genome_wide_data"),l=this.options.radius_start,j=this.options.radius_end,k=_.zip(h,m.get("data")),n=_.map(k,function(p){var q=p[0],o=p[1];return i.chrom_data_layout(q,o,l,j,m.get("min"),m.get("max"))});return n}});var g=a.extend({chrom_data_layout:function(r,i,o,n,k,p){if(!i||typeof i==="string"){return null}var l=i[0],q=i[3],j=d.scale.linear().domain([k,p]).range([o,n]),m=d.layout.pie().value(function(s){return q}).startAngle(r.startAngle).endAngle(r.endAngle),h=m(l);_.each(l,function(s,t){h[t].outerRadius=j(s[1])});return h}});var f=a.extend({chrom_data_layout:function(q,i,o,n,k,p){var l=i.data;if(l.length===0){return}var j=d.scale.linear().domain([k,p]).range([o,n]),m=d.layout.pie().value(function(s,r){if(r+1===l.length){return 0}return l[r+1][0]-l[r][0]}).startAngle(q.startAngle).endAngle(q.endAngle),h=m(l);_.each(l,function(r,s){h[s].outerRadius=j(r[1])});return h}});return{CircsterView:b}});