define(["galaxy.modal","galaxy.master","utils/galaxy.uploadbox","libs/backbone/backbone-relational"],function(b,c){var a=Backbone.View.extend({modal:null,button_show:null,uploadbox:null,initialize:function(){if(!Galaxy.currHistoryPanel){var d=this;window.setTimeout(function(){d.initialize()},500);return}var d=this;this.button_show=new c.GalaxyMasterIcon({icon:"fa-icon-upload",tooltip:"Upload Files",on_click:function(f){d.event_show(f)},with_number:true});Galaxy.master.prepend(this.button_show)},events:{mouseover:"event_mouseover",mouseleave:"event_mouseleave"},event_mouseover:function(d){},event_mouseleave:function(d){},event_announce:function(e,f,h){this.uploadbox.info().hide();var i="#upload-"+e;$(this.el).append(this.template_file(i));$(this.el).scrollTop($(this.el).prop("scrollHeight"));var g=this.get_upload_item(e);g.fadeIn();g.find(".title").html(f.name);g.find("#extension").select2({placeholder:"Auto-detect",width:"copy",ajax:{url:"http://www.weighttraining.com/sm/search",dataType:"jsonp",quietMillis:100,data:function(j,k){return{types:["exercise"],limit:-1,term:j}},results:function(k,j){return{results:k.results.exercise}}},formatResult:function(j){return"<div class='select2-user-result'>"+j.term+"</div>"},formatSelection:function(j){return j.term},initSelection:function(j,l){var k=$(j).attr("data-init-text");l({term:k})}});var d=this;g.find(".remove").on("click",function(){d.event_remove(e)});this.event_progress(e,f,0);this.modal.enable("Upload");this.modal.enable("Reset")},event_initialize:function(d,e,g){this.button_show.number(g);var f=this.get_upload_item(d);var h={source:"upload",space_to_tabs:f.find("#space_to_tabs").is(":checked"),extension:f.find("#extension").val()};return h},event_progress:function(e,f,h){var g=this.get_upload_item(e);var d=parseInt(h);g.find(".progress-bar").css({width:d+"%"});g.find(".info").html(d+"% of "+this.size_to_string(f.size))},event_success:function(d,e,g){var f=this.get_upload_item(d);f.addClass("panel-success");f.removeClass("panel-default");Galaxy.currHistoryPanel.refresh();this.event_progress(d,e,100);this.button_show.number("")},event_error:function(d,e,g){var f=this.get_upload_item(d);f.addClass("panel-danger");f.removeClass("panel-default");f.find(".progress").remove();f.find(".error").html("<strong>Failed:</strong> "+g);this.event_progress(d,e,0);this.button_show.number("")},event_upload:function(){$(this.el).find(".panel-body").hide();$(this.el).find(".remove").each(function(){$(this).removeClass("fa-icon-trash");$(this).addClass("fa-icon-caret-down")});this.modal.disable("Upload");var d=Galaxy.currHistoryPanel.model.get("id");this.uploadbox.configure({url:galaxy_config.root+"api/histories/"+d+"/contents"});this.uploadbox.upload()},event_reset:function(){var e=$(this.el).find(".panel");var d=this;e.fadeOut({complete:function(){e.remove();d.uploadbox.info().fadeIn()}});this.modal.disable("Upload");this.modal.disable("Reset");this.uploadbox.reset()},event_remove:function(e){var d=this;var f=this.get_upload_item(e);f.fadeOut({complete:function(){f.remove();d.uploadbox.remove(e);if($(d.el).find(".panel").length>0){d.modal.enable("Reset")}else{d.modal.disable("Reset");d.uploadbox.info().fadeIn()}if(d.uploadbox.length()>0){d.modal.enable("Upload")}else{d.modal.disable("Upload")}}})},event_show:function(f){f.preventDefault();if(!this.modal){var d=this;this.modal=new b.GalaxyModal({title:"Upload files from your local drive",body:this.template("upload-box"),buttons:{Select:function(){d.uploadbox.select()},Upload:function(){d.event_upload()},Reset:function(){d.event_reset()},Close:function(){d.modal.hide()}}});this.setElement("#upload-box");var d=this;this.uploadbox=this.$el.uploadbox({dragover:d.event_mouseover,dragleave:d.event_mouseleave,announce:function(e,g,h){d.event_announce(e,g,h)},initialize:function(e,g,h){return d.event_initialize(e,g,h)},success:function(e,g,h){d.event_success(e,g,h)},progress:function(e,g,h){d.event_progress(e,g,h)},error:function(e,g,h){d.event_error(e,g,h)},});this.modal.disable("Upload");this.modal.disable("Reset")}this.modal.show()},get_upload_item:function(d){return $(this.el).find("#upload-"+d)},size_to_string:function(d){var e="";if(d>=100000000000){d=d/100000000000;e="TB"}else{if(d>=100000000){d=d/100000000;e="GB"}else{if(d>=100000){d=d/100000;e="MB"}else{if(d>=100){d=d/100;e="KB"}else{d=d*10;e="b"}}}}return"<strong>"+(Math.round(d)/10)+"</strong> "+e},template:function(d){return'<div id="'+d+'" class="upload-box"></div>'},template_file:function(d){return'<div id="'+d.substr(1)+'" class="panel panel-default"><div class="panel-heading"><h5 class="title"></h5><h5 class="info"></h5><div class="remove fa-icon-trash"></div></div><div class="panel-body"><div class="menu"><span><input id="space_to_tabs" type="checkbox">Convert spaces to tabs</input></span></div></div><div class="panel-footer"><div class="progress"><div class="progress-bar progress-bar-success"></div></div><h6 class="error"></h6></div></div>'}});return{GalaxyUpload:a}});