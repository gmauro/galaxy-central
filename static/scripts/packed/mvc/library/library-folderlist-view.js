define(["galaxy.masthead","utils/utils","libs/toastr","mvc/library/library-model"],function(a,c,d,b){var e=Backbone.View.extend({el:"#center",progress:0,progressStep:1,lastSelectedHistory:"",modal:null,folders:null,initialize:function(){this.folders=[];this.queue=jQuery.Deferred();this.queue.resolve()},templateFolder:function(){var f=[];f.push('<div class="library_container" style="width: 90%; margin: auto; margin-top: 2em; ">');f.push('<h3>Data Libraries Beta Test. This is work in progress. Please report problems & ideas via <a href="mailto:galaxy-bugs@bx.psu.edu?Subject=DataLibrariesBeta_Feedback" target="_blank">email</a> and <a href="https://trello.com/c/nwYQNFPK/56-data-library-ui-progressive-display-of-folders" target="_blank">Trello</a>.</h3>');f.push('<div id="library_folder_toolbar" >');f.push('   <button title="Create New Folder" id="toolbtn_create_folder" class="primary-button" type="button"><span class="fa fa-plus"></span> <span class="fa fa-folder-close"></span> folder</button>');f.push('   <button title="Import selected datasets into history" id="toolbtn_bulk_import" class="primary-button" style="display: none; margin-left: 0.5em;" type="button"><span class="fa fa-book"></span> to history</button>');f.push('   <div id="toolbtn_dl" class="btn-group" style="margin-left: 0.5em; display: none; ">');f.push('       <button title="Download selected datasets" id="drop_toggle" type="button" class="primary-button dropdown-toggle" data-toggle="dropdown">');f.push('       <span class="fa fa-download"></span> download <span class="caret"></span>');f.push("       </button>");f.push('       <ul class="dropdown-menu" role="menu">');f.push('          <li><a href="#/folders/<%= id %>/download/tgz">.tar.gz</a></li>');f.push('          <li><a href="#/folders/<%= id %>/download/tbz">.tar.bz</a></li>');f.push('          <li><a href="#/folders/<%= id %>/download/zip">.zip</a></li>');f.push("       </ul>");f.push("   </div>");f.push("</div>");f.push('<ol class="breadcrumb">');f.push('   <li><a title="Return to the list of libraries" href="#">Libraries</a></li>');f.push("   <% _.each(path, function(path_item) { %>");f.push("   <% if (path_item[0] != id) { %>");f.push('   <li><a title="Return to this folder" href="#/folders/<%- path_item[0] %>"><%- path_item[1] %></a> </li> ');f.push("<% } else { %>");f.push('   <li class="active"><span title="You are in this folder"><%- path_item[1] %></span></li>');f.push("   <% } %>");f.push("   <% }); %>");f.push("</ol>");f.push('<table id="folder_table" class="grid table table-condensed">');f.push("   <thead>");f.push('       <th class="button_heading"></th>');f.push('       <th style="text-align: center; width: 20px; "><input id="select-all-checkboxes" style="margin: 0;" type="checkbox"></th>');f.push("       <th>name</th>");f.push("       <th>data type</th>");f.push("       <th>size</th>");f.push("       <th>date (UTC)</th>");f.push("   </thead>");f.push("   <tbody>");f.push('       <td><a href="#<% if (upper_folder_id !== 0){ print("folders/" + upper_folder_id)} %>" title="Go to parent folder" class="btn_open_folder btn btn-default btn-xs">..<a></td>');f.push("       <td></td>");f.push("       <td></td>");f.push("       <td></td>");f.push("       <td></td>");f.push("       <td></td>");f.push("       </tr>");f.push("       <% _.each(items, function(content_item) { %>");f.push('           <% if (content_item.get("type") === "folder") { %>');f.push('               <tr class="folder_row light" id="<%- content_item.id %>">');f.push("                   <td>");f.push('                       <span title="Folder" class="fa fa-folder-o"></span>');f.push("                   </td>");f.push("                   <td></td>");f.push("                   <td>");f.push('                       <a href="#folders/<%- content_item.id %>"><%- content_item.get("name") %></a>');f.push('                       <% if (content_item.get("item_count") === 0) { %>');f.push('                           <span class="muted">(empty folder)</span>');f.push("                       <% } %>");f.push("                   </td>");f.push("                   <td>folder</td>");f.push('                   <td><%= _.escape(content_item.get("item_count")) %> item(s)</td>');f.push('                   <td><%= _.escape(content_item.get("time_updated")) %></td>');f.push("               </tr>");f.push("           <% } else {  %>");f.push('               <tr class="dataset_row light" id="<%- content_item.id %>">');f.push("                   <td>");f.push('                       <span title="Dataset" class="fa fa-file-o"></span>');f.push("                   </td>");f.push('                   <td style="text-align: center; "><input style="margin: 0;" type="checkbox"></td>');f.push('                   <td><a href="#" class="library-dataset"><%- content_item.get("name") %><a></td>');f.push('                   <td><%= _.escape(content_item.get("data_type")) %></td>');f.push('                   <td><%= _.escape(content_item.get("readable_size")) %></td>');f.push('                   <td><%= _.escape(content_item.get("time_updated")) %></td>');f.push("               </tr>");f.push("               <% } %>  ");f.push("       <% }); %>");f.push("       ");f.push("   </tbody>");f.push("</table>");f.push("</div>");return f.join("")},templateDatasetModal:function(){var f=[];f.push('<div class="modal_table">');f.push('   <table class="grid table table-striped table-condensed">');f.push("       <tr>");f.push('           <th scope="row" id="id_row" data-id="<%= _.escape(item.get("ldda_id")) %>">Name</th>');f.push('           <td><%= _.escape(item.get("name")) %></td>');f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Data type</th>');f.push('           <td><%= _.escape(item.get("data_type")) %></td>');f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Genome build</th>');f.push('           <td><%= _.escape(item.get("genome_build")) %></td>');f.push("       </tr>");f.push('           <th scope="row">Size</th>');f.push("           <td><%= _.escape(size) %></td>");f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Date uploaded (UTC)</th>');f.push('           <td><%= _.escape(item.get("date_uploaded")) %></td>');f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Uploaded by</th>');f.push('           <td><%= _.escape(item.get("uploaded_by")) %></td>');f.push("       </tr>");f.push('           <tr scope="row">');f.push('           <th scope="row">Data Lines</th>');f.push('           <td scope="row"><%= _.escape(item.get("metadata_data_lines")) %></td>');f.push("       </tr>");f.push('       <th scope="row">Comment Lines</th>');f.push('           <% if (item.get("metadata_comment_lines") === "") { %>');f.push('               <td scope="row"><%= _.escape(item.get("metadata_comment_lines")) %></td>');f.push("           <% } else { %>");f.push('               <td scope="row">unknown</td>');f.push("           <% } %>");f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Number of Columns</th>');f.push('           <td scope="row"><%= _.escape(item.get("metadata_columns")) %></td>');f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Column Types</th>');f.push('           <td scope="row"><%= _.escape(item.get("metadata_column_types")) %></td>');f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Miscellaneous information</th>');f.push('           <td scope="row"><%= _.escape(item.get("misc_blurb")) %></td>');f.push("       </tr>");f.push("   </table>");f.push('   <pre class="peek">');f.push("   </pre>");f.push("</div>");return f.join("")},templateHistorySelectInModal:function(){var f=[];f.push('<span id="history_modal_combo" style="width:100%; margin-left: 1em; margin-right: 1em; ">');f.push("Select history: ");f.push('<select id="dataset_import_single" name="dataset_import_single" style="width:40%; margin-bottom: 1em; "> ');f.push("   <% _.each(histories, function(history) { %>");f.push('       <option value="<%= _.escape(history.get("id")) %>"><%= _.escape(history.get("name")) %></option>');f.push("   <% }); %>");f.push("</select>");f.push("</span>");return f.join("")},templateBulkImportInModal:function(){var f=[];f.push('<span id="history_modal_combo_bulk" style="width:90%; margin-left: 1em; margin-right: 1em; ">');f.push("Select history: ");f.push('<select id="dataset_import_bulk" name="dataset_import_bulk" style="width:50%; margin-bottom: 1em; "> ');f.push("   <% _.each(histories, function(history) { %>");f.push('       <option value="<%= _.escape(history.get("id")) %>"><%= _.escape(history.get("name")) %></option>');f.push("   <% }); %>");f.push("</select>");f.push("</span>");return f.join("")},templateProgressBar:function(){var f=[];f.push('<div class="import_text">');f.push("Importing selected datasets to history <b><%= _.escape(history_name) %></b>");f.push("</div>");f.push('<div class="progress">');f.push('   <div class="progress-bar progress-bar-import" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 00%;">');f.push('       <span class="completion_span">0% Complete</span>');f.push("   </div>");f.push("</div>");f.push("");return f.join("")},templateNewFolderInModal:function(){tmpl_array=[];tmpl_array.push('<div id="new_folder_modal">');tmpl_array.push("<form>");tmpl_array.push('<input type="text" name="Name" value="" placeholder="Name">');tmpl_array.push('<input type="text" name="Description" value="" placeholder="Description">');tmpl_array.push("</form>");tmpl_array.push("</div>");return tmpl_array.join("")},events:{"click #select-all-checkboxes":"selectAll","click #toolbtn_bulk_import":"modalBulkImport","click #toolbtn_dl":"bulkDownload","click #toolbtn_create_folder":"createFolderFromModal","click .library-dataset":"showDatasetDetails","click .dataset_row":"selectClickedRow"},render:function(f){$("#center").css("overflow","auto");view=this;var h=this;var g=new b.FolderContainer({id:f.id});g.url=g.attributes.urlRoot+f.id+"/contents";g.fetch({success:function(j){for(var l=0;l<g.attributes.folder.models.length;l++){var k=g.attributes.folder.models[l];if(k.get("type")==="file"){k.set("readable_size",h.size_to_string(k.get("file_size")))}}var n=g.full_path;var o;if(n.length===1){o=0}else{o=n[n.length-2][0]}var m=_.template(h.templateFolder(),{path:g.full_path,items:g.attributes.folder.models,id:f.id,upper_folder_id:o});h.$el.html(m)},error:function(){d.error("An error occured :(")}})},size_to_string:function(f){var g="";if(f>=100000000000){f=f/100000000000;g="TB"}else{if(f>=100000000){f=f/100000000;g="GB"}else{if(f>=100000){f=f/100000;g="MB"}else{if(f>=100){f=f/100;g="KB"}else{f=f*10;g="b"}}}}return(Math.round(f)/10)+g},showDatasetDetails:function(i){i.preventDefault();var j=$(i.target).parent().parent().parent().attr("id");if(typeof j==="undefined"){j=$(i.target).parent().attr("id")}if(typeof j==="undefined"){j=$(i.target).parent().parent().attr("id")}var h=new b.Item();var g=new b.GalaxyHistories();h.id=j;var f=this;h.fetch({success:function(k){g.fetch({success:function(l){f.renderModalAfterFetch(k,l)},error:function(){d.error("An error occured during fetching histories:(");f.renderModalAfterFetch(k)}})},error:function(){d.error("An error occured during loading dataset details :(")}})},renderModalAfterFetch:function(k,h){var i=this.size_to_string(k.get("file_size"));var j=_.template(this.templateDatasetModal(),{item:k,size:i});var g=this;this.modal=Galaxy.modal;this.modal.show({closing_events:true,title:"Dataset Details",body:j,buttons:{Import:function(){g.importCurrentIntoHistory()},Download:function(){g.downloadCurrent()},Close:function(){g.modal.hide()}}});$(".peek").html("Peek:"+k.get("peek"));if(typeof history.models!==undefined){var f=_.template(this.templateHistorySelectInModal(),{histories:h.models});$(this.modal.elMain).find(".buttons").prepend(f);if(g.lastSelectedHistory.length>0){$(this.modal.elMain).find("#dataset_import_single").val(g.lastSelectedHistory)}}},downloadCurrent:function(){this.modal.disableButton("Import");this.modal.disableButton("Download");var f=[];f.push($("#id_row").attr("data-id"));var g="/api/libraries/datasets/download/uncompressed";var h={ldda_ids:f};folderContentView.processDownload(g,h);this.modal.enableButton("Import");this.modal.enableButton("Download")},importCurrentIntoHistory:function(){this.modal.disableButton("Import");this.modal.disableButton("Download");var h=$(this.modal.elMain).find("select[name=dataset_import_single] option:selected").val();this.lastSelectedHistory=h;var f=$("#id_row").attr("data-id");var i=new b.HistoryItem();var g=this;i.url=i.urlRoot+h+"/contents";i.save({content:f,source:"library"},{success:function(){d.success("Dataset imported");g.modal.enableButton("Import");g.modal.enableButton("Download")},error:function(){d.error("An error occured! Dataset not imported. Please try again.");g.modal.enableButton("Import");g.modal.enableButton("Download")}})},selectAll:function(g){var f=g.target.checked;that=this;$(":checkbox").each(function(){this.checked=f;$row=$(this.parentElement.parentElement);(f)?that.makeDarkRow($row):that.makeWhiteRow($row)});this.checkTools()},selectClickedRow:function(g){var i="";var f;var h;if(g.target.localName==="input"){i=g.target;f=$(g.target.parentElement.parentElement);h="input"}else{if(g.target.localName==="td"){i=$("#"+g.target.parentElement.id).find(":checkbox")[0];f=$(g.target.parentElement);h="td"}}if(i.checked){if(h==="td"){i.checked="";this.makeWhiteRow(f)}else{if(h==="input"){this.makeDarkRow(f)}}}else{if(h==="td"){i.checked="selected";this.makeDarkRow(f)}else{if(h==="input"){this.makeWhiteRow(f)}}}this.checkTools()},makeDarkRow:function(f){f.removeClass("light");f.find("a").removeClass("light");f.addClass("dark");f.find("a").addClass("dark");f.find("span").removeClass("fa-file-o");f.find("span").addClass("fa-file")},makeWhiteRow:function(f){f.removeClass("dark");f.find("a").removeClass("dark");f.addClass("light");f.find("a").addClass("light");f.find("span").addClass("fa-file-o");f.find("span").removeClass("fa-file")},checkTools:function(){var f=$("#folder_table").find(":checked");if(f.length>0){$("#toolbtn_bulk_import").show();$("#toolbtn_dl").show()}else{$("#toolbtn_bulk_import").hide();$("#toolbtn_dl").hide()}},modalBulkImport:function(){var g=this;var f=new b.GalaxyHistories();f.fetch({success:function(h){var i=_.template(g.templateBulkImportInModal(),{histories:h.models});g.modal=Galaxy.modal;g.modal.show({closing_events:true,title:"Import into History",body:i,buttons:{Import:function(){g.importAllIntoHistory()},Close:function(){g.modal.hide()}}})},error:function(){d.error("An error occured :(")}})},importAllIntoHistory:function(){this.modal.disableButton("Import");var h=$("select[name=dataset_import_bulk] option:selected").val();var m=$("select[name=dataset_import_bulk] option:selected").text();var o=[];$("#folder_table").find(":checked").each(function(){if(this.parentElement.parentElement.id!=""){o.push(this.parentElement.parentElement.id)}});var n=_.template(this.templateProgressBar(),{history_name:m});$(this.modal.elMain).find(".modal-body").html(n);var j=100/o.length;this.initProgress(j);var f=[];for(var g=o.length-1;g>=0;g--){library_dataset_id=o[g];var k=new b.HistoryItem();var l=this;k.url=k.urlRoot+h+"/contents";k.content=library_dataset_id;k.source="library";f.push(k)}this.chainCall(f)},chainCall:function(g){var f=this;var h=g.pop();if(typeof h==="undefined"){d.success("All datasets imported");this.modal.hide();return}var i=$.when(h.save({content:h.content,source:h.source})).done(function(j){f.updateProgress();f.chainCall(g)})},initProgress:function(f){this.progress=0;this.progressStep=f},updateProgress:function(){this.progress+=this.progressStep;$(".progress-bar-import").width(Math.round(this.progress)+"%");txt_representation=Math.round(this.progress)+"% Complete";$(".completion_span").text(txt_representation)},download:function(f,j){var h=[];$("#folder_table").find(":checked").each(function(){if(this.parentElement.parentElement.id!=""){h.push(this.parentElement.parentElement.id)}});var g="/api/libraries/datasets/download/"+j;var i={ldda_ids:h};this.processDownload(g,i,"get")},processDownload:function(g,h,i){if(g&&h){h=typeof h=="string"?h:$.param(h);var f="";$.each(h.split("&"),function(){var j=this.split("=");f+='<input type="hidden" name="'+j[0]+'" value="'+j[1]+'" />'});$('<form action="'+g+'" method="'+(i||"post")+'">'+f+"</form>").appendTo("body").submit().remove();d.info("Your download will begin soon")}},createFolderFromModal:function(){event.preventDefault();event.stopPropagation();var f=this;this.modal=Galaxy.modal;this.modal.show({closing_events:true,title:"Create New Folder",body:this.templateNewFolderInModal(),buttons:{Create:function(){f.create_new_folder_event()},Close:function(){f.modal.hide();f.modal=null}}})},create_new_folder_event:function(){var f=this.serialize_new_folder();if(this.validate_new_folder(f)){var h=new b.FolderAsModel();url_items=Backbone.history.fragment.split("/");current_folder_id=url_items[url_items.length-1];h.url=h.urlRoot+"/"+current_folder_id;var g=this;h.save(f,{success:function(i){g.modal.hide();d.success("Folder created");g.render({id:current_folder_id})},error:function(){d.error("An error occured :(")}})}else{d.error("Folder's name is missing")}return false},serialize_new_folder:function(){return{name:$("input[name='Name']").val(),description:$("input[name='Description']").val()}},validate_new_folder:function(f){return f.name!==""}});return{FolderContentView:e}});