define(["galaxy.masthead","utils/utils","libs/toastr","mvc/library/library-model"],function(b,d,e,c){var a=Backbone.View.extend({lastSelectedHistory:"",events:{"click .library-dataset":"showDatasetDetails","click .undelete_dataset_btn":"undelete_dataset"},options:{type:null},initialize:function(f){this.render(f)},render:function(f){var g=null;if(f.get("type")==="folder"){this.options.type="folder";g=this.templateRowFolder()}else{this.options.type="file";if(f.get("deleted")){g=this.templateRowDeletedFile()}else{g=this.templateRowFile()}}this.setElement(g({content_item:f}));this.$el.show();return this},showDatasetDetails:function(i){i.preventDefault();var j=this.id;var h=new c.Item();var g=new c.GalaxyHistories();h.id=j;var f=this;h.fetch({success:function(k){g.fetch({success:function(l){f.renderModalAfterFetch(k,l)},error:function(m,l){if(typeof l.responseJSON!=="undefined"){e.error(l.responseJSON.err_msg)}else{e.error("An error occured during fetching histories:(")}f.renderModalAfterFetch(k)}})},error:function(l,k){if(typeof k.responseJSON!=="undefined"){e.error(k.responseJSON.err_msg)}else{e.error("An error occured during loading dataset details :(")}}})},renderModalAfterFetch:function(k,h){var i=this.size_to_string(k.get("file_size"));var j=_.template(this.templateDatasetModal(),{item:k,size:i});var g=this;this.modal=Galaxy.modal;this.modal.show({closing_events:true,title:"Dataset Details",body:j,buttons:{Import:function(){g.importCurrentIntoHistory()},Download:function(){g.downloadCurrent()},Close:function(){g.modal.hide()}}});$(".peek").html(k.get("peek"));if(typeof history.models!==undefined){var f=_.template(this.templateHistorySelectInModal(),{histories:h.models});$(this.modal.elMain).find(".buttons").prepend(f);if(g.lastSelectedHistory.length>0){$(this.modal.elMain).find("#dataset_import_single").val(g.lastSelectedHistory)}}},size_to_string:function(f){var g="";if(f>=100000000000){f=f/100000000000;g="TB"}else{if(f>=100000000){f=f/100000000;g="GB"}else{if(f>=100000){f=f/100000;g="MB"}else{if(f>=100){f=f/100;g="KB"}else{f=f*10;g="b"}}}}return(Math.round(f)/10)+g},downloadCurrent:function(){this.modal.disableButton("Import");this.modal.disableButton("Download");var f=[];f.push($("#id_row").attr("data-id"));var g="/api/libraries/datasets/download/uncompressed";var h={ldda_ids:f};this.processDownload(g,h);this.modal.enableButton("Import");this.modal.enableButton("Download")},processDownload:function(g,h,i){if(g&&h){h=typeof h=="string"?h:$.param(h);var f="";$.each(h.split("&"),function(){var j=this.split("=");f+='<input type="hidden" name="'+j[0]+'" value="'+j[1]+'" />'});$('<form action="'+g+'" method="'+(i||"post")+'">'+f+"</form>").appendTo("body").submit().remove();e.info("Your download will begin soon")}},importCurrentIntoHistory:function(){this.modal.disableButton("Import");this.modal.disableButton("Download");var h=$(this.modal.elMain).find("select[name=dataset_import_single] option:selected").val();this.lastSelectedHistory=h;var f=$("#id_row").attr("data-id");var i=new c.HistoryItem();var g=this;i.url=i.urlRoot+h+"/contents";i.save({content:f,source:"library"},{success:function(){e.success("Dataset imported");g.modal.enableButton("Import");g.modal.enableButton("Download")},error:function(){e.error("An error occured! Dataset not imported. Please try again.");g.modal.enableButton("Import");g.modal.enableButton("Download")}})},undelete_dataset:function(f){alert("undelete dataset")},templateRowFolder:function(){tmpl_array=[];tmpl_array.push('<tr class="folder_row light" id="<%- content_item.id %>">');tmpl_array.push("  <td>");tmpl_array.push('    <span title="Folder" class="fa fa-folder-o"></span>');tmpl_array.push("  </td>");tmpl_array.push("  <td></td>");tmpl_array.push("  <td>");tmpl_array.push('    <a href="#folders/<%- content_item.id %>"><%- content_item.get("name") %></a>');tmpl_array.push('    <% if (content_item.get("item_count") === 0) { %>');tmpl_array.push("      <span>(empty folder)</span>");tmpl_array.push("    <% } %>");tmpl_array.push("  </td>");tmpl_array.push("  <td>folder</td>");tmpl_array.push("  <td></td>");tmpl_array.push('  <td><%= _.escape(content_item.get("update_time")) %></td>');tmpl_array.push("  <td></td>");tmpl_array.push("</tr>");return _.template(tmpl_array.join(""))},templateRowFile:function(){tmpl_array=[];tmpl_array.push('<tr class="dataset_row light" id="<%- content_item.id %>">');tmpl_array.push("  <td>");tmpl_array.push('    <span title="Dataset" class="fa fa-file-o"></span>');tmpl_array.push("  </td>");tmpl_array.push('  <td style="text-align: center; "><input style="margin: 0;" type="checkbox"></td>');tmpl_array.push('  <td><a href="#" class="library-dataset"><%- content_item.get("name") %><a></td>');tmpl_array.push('  <td><%= _.escape(content_item.get("data_type")) %></td>');tmpl_array.push('  <td><%= _.escape(content_item.get("readable_size")) %></td>');tmpl_array.push('  <td><%= _.escape(content_item.get("update_time")) %></td>');tmpl_array.push("  <td></td>");tmpl_array.push("</tr>");return _.template(tmpl_array.join(""))},templateRowDeletedFile:function(){tmpl_array=[];tmpl_array.push('<tr class="active deleted_dataset" id="<%- content_item.id %>">');tmpl_array.push("  <td>");tmpl_array.push('    <span title="Dataset" class="fa fa-file-o"></span>');tmpl_array.push("  </td>");tmpl_array.push('  <td><span data-toggle="tooltip" data-placement="top" title="Marked deleted" style="color:grey;" class="fa fa-ban fa-lg"> </span></td>');tmpl_array.push('  <td style="color:grey;"><%- content_item.get("name") %></td>');tmpl_array.push('  <td><%= _.escape(content_item.get("data_type")) %></td>');tmpl_array.push('  <td><%= _.escape(content_item.get("readable_size")) %></td>');tmpl_array.push('  <td><%= _.escape(content_item.get("update_time")) %></td>');tmpl_array.push('  <td class="right-center"><button data-toggle="tooltip" data-placement="top" title="Undelete <%- content_item.get("name") %>" class="primary-button btn-xs undelete_dataset_btn show_on_hover" type="button" style="display:none;"><span class="fa fa-unlock"> Undelete</span></button></td>');tmpl_array.push("</tr>");return _.template(tmpl_array.join(""))},templateDatasetModal:function(){var f=[];f.push('<div class="modal_table">');f.push('   <table class="grid table table-striped table-condensed">');f.push("       <tr>");f.push('           <th scope="row" id="id_row" data-id="<%= _.escape(item.get("ldda_id")) %>">Name</th>');f.push('           <td><%= _.escape(item.get("name")) %></td>');f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Data type</th>');f.push('           <td><%= _.escape(item.get("data_type")) %></td>');f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Genome build</th>');f.push('           <td><%= _.escape(item.get("genome_build")) %></td>');f.push("       </tr>");f.push('           <th scope="row">Size</th>');f.push("           <td><%= _.escape(size) %></td>");f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Date uploaded (UTC)</th>');f.push('           <td><%= _.escape(item.get("date_uploaded")) %></td>');f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Uploaded by</th>');f.push('           <td><%= _.escape(item.get("uploaded_by")) %></td>');f.push("       </tr>");f.push('           <tr scope="row">');f.push('           <th scope="row">Data Lines</th>');f.push('           <td scope="row"><%= _.escape(item.get("metadata_data_lines")) %></td>');f.push("       </tr>");f.push('       <th scope="row">Comment Lines</th>');f.push('           <% if (item.get("metadata_comment_lines") === "") { %>');f.push('               <td scope="row"><%= _.escape(item.get("metadata_comment_lines")) %></td>');f.push("           <% } else { %>");f.push('               <td scope="row">unknown</td>');f.push("           <% } %>");f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Number of Columns</th>');f.push('           <td scope="row"><%= _.escape(item.get("metadata_columns")) %></td>');f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Column Types</th>');f.push('           <td scope="row"><%= _.escape(item.get("metadata_column_types")) %></td>');f.push("       </tr>");f.push("       <tr>");f.push('           <th scope="row">Miscellaneous information</th>');f.push('           <td scope="row"><%= _.escape(item.get("misc_blurb")) %></td>');f.push("       </tr>");f.push("   </table>");f.push('   <pre class="peek">');f.push("   </pre>");f.push("</div>");return f.join("")},templateHistorySelectInModal:function(){var f=[];f.push('<span id="history_modal_combo" style="width:100%; margin-left: 1em; margin-right: 1em; ">');f.push("Select history: ");f.push('<select id="dataset_import_single" name="dataset_import_single" style="width:40%; margin-bottom: 1em; "> ');f.push("   <% _.each(histories, function(history) { %>");f.push('       <option value="<%= _.escape(history.get("id")) %>"><%= _.escape(history.get("name")) %></option>');f.push("   <% }); %>");f.push("</select>");f.push("</span>");return f.join("")}});return{FolderRowView:a}});