define(["utils/graph","utils/add-logging"],function(n,m){var r=n.Graph;var c=function(u){u=u||{};var t=this;t.filters=[];t._jobsData=[];t._historyContentsMap={};t._toolMap={};t._outputIdToJobMap={};t.noInputJobs=[];t.noOutputJobs=[];t.filteredSetMetadata=[];t.filteredErroredJobs=[];t.dataKeys=["jobs","historyContents","tools"];r.call(t,true,_.pick(u,t.dataKeys),_.omit(u,t.dataKeys))};c.prototype=new n.Graph();c.prototype.constructor=c;m(c);c.prototype.init=function h(u){u=u||{};var t=this;t.options=_.defaults(u,{excludeSetMetadata:false});t.filters=t._initFilters();r.prototype.init.call(t,u);return t};c.prototype._initFilters=function g(){var t=this,u=[];if(t.options.excludeSetMetadata){t.filteredSetMetadata=[];u.push(function w(x){if(x.job.tool_id!=="__SET_METADATA__"){return true}t.filteredSetMetadata.push(x.job.id);return false})}if(t.options.excludeErroredJobs){t.filteredErroredJobs=[];u.push(function v(x){if(x.job.state!=="error"){return true}t.filteredErroredJobs.push(x.job.id);return false})}if(_.isArray(t.options.filters)){u=u.concat(t.options.filters)}t.debug("filters len:",u.length);return u};c.prototype.read=function f(u){var t=this;if(_.has(u,"historyContents")&&_.has(u,"jobs")&&_.has(u,"tools")){t.preprocessHistoryContents(u.historyContents||[]).preprocessTools(u.tools||{}).preprocessJobs(u.jobs||[]);t.createGraph(t._filterJobs());return t}return r.prototype.read.call(this,u)};c.prototype.preprocessHistoryContents=function a(u){this.info("processing history");var t=this;t._historyContentsMap={};u.forEach(function(w,v){t._historyContentsMap[w.id]=_.clone(w)});return t};c.prototype.preprocessTools=function i(u){this.info("processing tools");var t=this;t._toolMap={};_.each(u,function(v,w){t._toolMap[w]=_.clone(v)});return t};c.prototype.preprocessJobs=function p(t){this.info("processing jobs");var u=this;u._outputIdToJobMap={};u._jobsData=u.sort(t).map(function(v){return u.preprocessJob(_.clone(v))});return u};c.prototype.sort=function j(t){function u(w,v){if(w.create_time>v.create_time){return 1}if(w.create_time<v.create_time){return -1}return 0}return t.sort(u)};c.prototype.preprocessJob=function e(w,v){var u=this,t={job:w};t.inputs=u._processInputs(w);if(_.size(t.inputs)===0){u.noInputJobs.push(w.id)}t.outputs=u._processOutputs(w);if(_.size(t.outputs)===0){u.noOutputJobs.push(w.id)}t.tool=u._toolMap[w.tool_id];return t};c.prototype._processInputs=function b(w){var u=this,t=w.inputs,v={};_.each(t,function(x,y){x=_.clone(u._validateInputOutput(x));x.name=y;x.content=u._historyContentsMap[x.id];v[x.id]=x});return v};c.prototype._validateInputOutput=function q(t){if(!t.id){throw new Error("No id on job input/output: ",JSON.stringify(t))}if(!t.src||t.src!=="hda"){throw new Error("Bad src on job input/output: ",JSON.stringify(t))}return t};c.prototype._processOutputs=function k(v){var t=this,w=v.outputs,u={};_.each(w,function(x,y){x=_.clone(t._validateInputOutput(x));x.name=y;x.content=t._historyContentsMap[x.id];u[x.id]=x;t._outputIdToJobMap[x.id]=v.id});return u};c.prototype._filterJobs=function s(){var t=this;return t._jobsData.filter(function(u,v){return t._filterJob(u,v)})};c.prototype._filterJob=function l(u,v){var t=this;for(var w=0;w<t.filters.length;w++){if(!t.filters[w].call(t,u)){t.debug("\t job",u.job.id," has been filtered out by function:\n",t.filters[w]);return false}}return true};c.prototype.createGraph=function d(u){var t=this;t.debug("connections:");_.each(u,function(v){var w=v.job.id;t.debug("\t",w,v);t.createVertex(w,v)});_.each(u,function(v){var w=v.job.id;_.each(v.inputs,function(y,x){var z=t._outputIdToJobMap[x];if(!z){var A=t.createJobLessVertex(x);z=A.name}t.createEdge(z,w,t.directed,{dataset:x})})});t.debug("final graph: ",JSON.stringify(t.toVerticesAndEdges(),null,"  "));return t};c.prototype.createJobLessVertex=function o(v){var u="copy-",t=u+v;return this.createVertex(t,this._historyContentsMap[v])};c.prototype.weakComponentGraphArray=function(){var t=this;return this.weakComponents().map(function(v){v.vertices.sort(function u(x,w){var z=x.data.job?x.data.job.create_time:x.data.create_time,y=w.data.job?w.data.job.create_time:w.data.create_time;if(z>y){return 1}if(z<y){return -1}return 0});return new Graph(t.directed,v)})};c.prototype._jobsDataMap=function(){var t={};this._jobsData.forEach(function(u){t[u.job.id]=u});return t};return c});