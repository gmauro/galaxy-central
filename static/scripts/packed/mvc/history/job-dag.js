define(["utils/graph","utils/add-logging"],function(d,i){var k=d.Graph;var f=function(m){var l=this;l._historyContentsMap={};l.filters=[];l._idMap={};l.noInputJobs=[];l.noOutputJobs=[];l.filteredSetMetadata=[];l.filteredErroredJobs=[];k.call(l,true,null,m)};f.prototype=new d.Graph();f.prototype.constructor=f;i(f);f.prototype.init=function g(n){n=n||{};k.prototype.init.call(this,n);var m=this,l=n.historyContents||[];jobsJSON=n.jobs||[];l.forEach(function(p,o){m._historyContentsMap[p.id]=_.clone(p)});m.options=_.defaults(_.omit(n,"historyContents","jobs"),{excludeSetMetadata:false});m.filters=m._initFilters();m.preprocessJobs(_.clone(jobsJSON));m.createGraph();return m};f.prototype._initFilters=function b(){var l=this,m=[];if(l.options.excludeSetMetadata){l.filteredSetMetadata=[];m.push(function o(p){if(p.job.tool_id!=="__SET_METADATA__"){return true}l.filteredSetMetadata.push(p.job.id);return false})}if(l.options.excludeErroredJobs){l.filteredErroredJobs=[];m.push(function n(p){if(p.job.state!=="error"){return true}l.filteredErroredJobs.push(p.job.id);return false})}if(_.isArray(l.options.filters)){m=m.concat(l.options.filters)}l.debug("filters len:",m.length);return m};f.prototype.preprocessJobs=function a(l){this.info("processing jobs");var m=this;m.sort(l).forEach(function(p,o){var n=m.preprocessJob(p,o);if(n){m._idMap[p.id]=n}});return m};f.prototype.sort=function c(l){function m(o,n){if(o.update_time>n.update_time){return 1}if(o.update_time<n.update_time){return -1}return 0}return l.sort(m)};f.prototype.preprocessJob=function h(p,n){var m=this,l={index:n,job:p};l.inputs=m.datasetMapToIdArray(p.inputs,function(q,r){});if(l.inputs.length===0){m.noInputJobs.push(p.id)}l.outputs=m.datasetMapToIdArray(p.outputs,function(q,r){});if(l.outputs.length===0){m.noOutputJobs.push(p.id)}for(var o=0;o<m.filters.length;o++){if(!m.filters[o].call(m,l)){m.debug("job",p.id," has been filtered out by function:\n",m.filters[o]);return null}}return l};f.prototype.datasetMapToIdArray=function e(l,n){var m=this;return _.map(l,function(o,p){if(!o.id){throw new Error("No id on datasetMap: ",JSON.stringify(o))}if(!o.src||o.src!=="hda"){throw new Error("Bad src on datasetMap: ",JSON.stringify(o))}n.call(m,o,p);return o.id})};f.prototype.createGraph=function j(){var l=this;l.debug("connections:");_.each(l._idMap,function(m,n){l.debug("\t",n,m);l.createVertex(n,m);m.usedIn=[];_.each(m.outputs,function(o){_.each(l._idMap,function(p,q){if(p===m){return}if(p.inputs.indexOf(o)!==-1){l.info("\t\t\t found connection: ",n,q);m.usedIn.push({job:q,output:o});l.createVertex(q,p);l.createEdge(n,q,l.directed,{dataset:o})}})})});l.debug("job data: ",JSON.stringify(l._idMap,null,"  "));return l};Graph.prototype.weakComponentGraphArray=function(){return this.weakComponents().map(function(m){m.vertices.sort(function l(o,n){if(o.data.job.update_time>n.data.job.update_time){return 1}if(o.data.job.update_time<n.data.job.update_time){return -1}return 0});return new Graph(this.directed,m)})};return f});