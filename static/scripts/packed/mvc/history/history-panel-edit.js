define(["mvc/history/history-panel","mvc/history/history-contents","mvc/dataset/states","mvc/history/hda-model","mvc/history/hda-li-edit","mvc/history/hdca-li-edit","mvc/tags","mvc/annotations","jq-plugins/ui/fa-icon-button","utils/localization"],function(g,i,l,e,d,h,k,b,a,c){var j=g.HistoryPanel;var f=j.extend({HDAViewClass:d.HDAListItemEdit,HDCAViewClass:h.HDCAListItemEdit,initialize:function(m){m=m||{};j.prototype.initialize.call(this,m);this.tagsEditor=null;this.annotationEditor=null;this.purgeAllowed=m.purgeAllowed||false;this.annotationEditorShown=m.annotationEditorShown||false;this.tagsEditorShown=m.tagsEditorShown||false;this.multiselectActions=m.multiselectActions||this._getActions()},_setUpListeners:function(){j.prototype._setUpListeners.call(this);this.on("drop",function(m,n){this.dataDropped(n);this.dropTargetOff()})},_setUpCollectionListeners:function(){j.prototype._setUpCollectionListeners.call(this);this.collection.on("change:deleted",this._handleHdaDeletionChange,this);this.collection.on("change:visible",this._handleHdaVisibleChange,this);this.collection.on("change:purged",function(m){this.model.fetch()},this);return this},_setUpModelListeners:function(){j.prototype._setUpModelListeners.call(this);this.model.on("change:nice_size",this.updateHistoryDiskSize,this);return this},_buildNewRender:function(){var m=j.prototype._buildNewRender.call(this);if(!this.model){return m}if(Galaxy&&Galaxy.currUser&&Galaxy.currUser.id&&Galaxy.currUser.id===this.model.get("user_id")){this._renderTags(m);this._renderAnnotation(m)}return m},renderItems:function(n){var m=j.prototype.renderItems.call(this,n);this._renderCounts(n);return m},_renderCounts:function(o){function n(r,s){return['<a class="',r,'" href="javascript:void(0);">',s,"</a>"].join("")}o=o||this.$el;var m=this.collection.where({deleted:true}),q=this.collection.where({visible:false}),p=[];if(this.views.length){p.push([this.views.length,c("shown")].join(" "))}if(m.length){p.push((!this.showDeleted)?([m.length,n("toggle-deleted-link",c("deleted"))].join(" ")):(n("toggle-deleted-link",c("hide deleted"))))}if(q.length){p.push((!this.showHidden)?([q.length,n("toggle-hidden-link",c("hidden"))].join(" ")):(n("toggle-hidden-link",c("hide hidden"))))}return o.find("> .controls .subtitle").html(p.join(", "))},_renderTags:function(m){var n=this;this.tagsEditor=new k.TagsEditor({model:this.model,el:m.find(".controls .tags-display"),onshowFirstTime:function(){this.render()},onshow:function(){n.toggleHDATagEditors(true,n.fxSpeed)},onhide:function(){n.toggleHDATagEditors(false,n.fxSpeed)},$activator:a({title:c("Edit history tags"),classes:"history-tag-btn",faIcon:"fa-tags"}).appendTo(m.find(".controls .actions"))})},_renderAnnotation:function(m){var n=this;this.annotationEditor=new b.AnnotationEditor({model:this.model,el:m.find(".controls .annotation-display"),onshowFirstTime:function(){this.render()},onshow:function(){n.toggleHDAAnnotationEditors(true,n.fxSpeed)},onhide:function(){n.toggleHDAAnnotationEditors(false,n.fxSpeed)},$activator:a({title:c("Edit history annotation"),classes:"history-annotate-btn",faIcon:"fa-comment"}).appendTo(m.find(".controls .actions"))})},_setUpBehaviors:function(m){m=m||this.$el;j.prototype._setUpBehaviors.call(this,m);if(!this.model){return}if(this.multiselectActions.length){this.actionsPopup=new PopupMenu(m.find(".list-action-popup-btn"),this.multiselectActions)}if((!Galaxy.currUser||Galaxy.currUser.isAnonymous())||(Galaxy.currUser.id!==this.model.get("user_id"))){return}var n=this,o=".controls .name";m.find(o).attr("title",c("Click to rename history")).tooltip({placement:"bottom"}).make_text_editable({on_finish:function(p){var q=n.model.get("name");if(p&&p!==q){n.$el.find(o).text(p);n.model.save({name:p}).fail(function(){n.$el.find(o).text(n.model.previous("name"))})}else{n.$el.find(o).text(q)}}})},_getActions:function(){var m=this,n=[{html:c("Hide datasets"),func:function(){var o=e.HistoryDatasetAssociation.prototype.hide;m.getSelectedModels().ajaxQueue(o)}},{html:c("Unhide datasets"),func:function(){var o=e.HistoryDatasetAssociation.prototype.unhide;m.getSelectedModels().ajaxQueue(o)}},{html:c("Delete datasets"),func:function(){var o=e.HistoryDatasetAssociation.prototype["delete"];m.getSelectedModels().ajaxQueue(o)}},{html:c("Undelete datasets"),func:function(){var o=e.HistoryDatasetAssociation.prototype.undelete;m.getSelectedModels().ajaxQueue(o)}}];if(m.purgeAllowed){n.push({html:c("Permanently delete datasets"),func:function(){if(confirm(c("This will permanently remove the data in your datasets. Are you sure?"))){var o=e.HistoryDatasetAssociation.prototype.purge;m.getSelectedModels().ajaxQueue(o)}}})}n.push({html:c("Build Dataset List"),func:function(){m.getSelectedModels().promoteToHistoryDatasetCollection(m.model,"list")}});n.push({html:c("Build Dataset Pair"),func:function(){m.getSelectedModels().promoteToHistoryDatasetCollection(m.model,"paired")}});n.push({html:c("Build List of Dataset Pairs"),func:_.bind(m._showPairedCollectionModal,m)});return n},_showPairedCollectionModal:function(){var m=this,n=m.getSelectedModels().toJSON().filter(function(o){return o.history_content_type==="dataset"&&o.state===l.OK});if(n.length){require(["mvc/collection/paired-collection-creator"],function(o){window.creator=o.pairedCollectionCreatorModal(n,{historyId:m.model.id})})}else{}},_attachItems:function(m){this.$list(m).append(this.views.reverse().map(function(n){return n.$el}));return this},_attachView:function(n){var m=this;m.views.unshift(n);m.$list().prepend(n.render(0).$el.hide());n.$el.slideDown(m.fxSpeed)},_getItemViewOptions:function(n){var m=j.prototype._getItemViewOptions.call(this,n);_.extend(m,{purgeAllowed:this.purgeAllowed,tagsEditorShown:(this.tagsEditor&&!this.tagsEditor.hidden),annotationEditorShown:(this.annotationEditor&&!this.annotationEditor.hidden)});return m},_handleHdaDeletionChange:function(m){if(m.get("deleted")&&!this.showDeleted){this.removeItemView(m)}this._renderCounts()},_handleHdaVisibleChange:function(m){if(m.hidden()&&!this.storage.showHidden){this.removeItemView(m)}this._renderCounts()},toggleHDATagEditors:function(m){var n=Array.prototype.slice.call(arguments,1);_.each(this.views,function(o){if(o.tagsEditor){o.tagsEditor.toggle.apply(o.tagsEditor,n)}})},toggleHDAAnnotationEditors:function(m){var n=Array.prototype.slice.call(arguments,1);_.each(this.views,function(o){if(o.annotationEditor){o.annotationEditor.toggle.apply(o.annotationEditor,n)}})},events:_.extend(_.clone(j.prototype.events),{"click .show-selectors-btn":"toggleSelectors","click .toggle-deleted-link":function(m){this.toggleShowDeleted()},"click .toggle-hidden-link":function(m){this.toggleShowHidden()}}),updateHistoryDiskSize:function(){this.$el.find(".history-size").text(this.model.get("nice_size"))},dropTargetOn:function(){if(this.dropTarget){return this}this.dropTarget=true;var n={dragenter:_.bind(this.dragenter,this),dragover:_.bind(this.dragover,this),dragleave:_.bind(this.dragleave,this),drop:_.bind(this.drop,this)};var o=this._renderDropTarget();this.$list().before([this._renderDropTargetHelp(),o]);for(var m in n){if(n.hasOwnProperty(m)){o.on(m,n[m])}}return this},_renderDropTarget:function(){return $("<div/>").addClass("history-drop-target").css({height:"64px",margin:"0px 10px 10px 10px",border:"1px dashed black","border-radius":"3px"})},_renderDropTargetHelp:function(){return $("<div/>").addClass("history-drop-target-help").css({margin:"10px 10px 4px 10px",color:"grey","font-size":"80%","font-style":"italic"}).text(c("Drag datasets here to copy them to the current history"))},dropTargetOff:function(){if(!this.dropTarget){return this}this.dropTarget=false;this.$(".history-drop-target").remove();this.$(".history-drop-target-help").remove();return this},dropTargetToggle:function(){if(this.dropTarget){this.dropTargetOff()}else{this.dropTargetOn()}return this},dragenter:function(m){m.preventDefault();m.stopPropagation();this.$(".history-drop-target").css("border","2px solid black")},dragover:function(m){m.preventDefault();m.stopPropagation()},dragleave:function(m){m.preventDefault();m.stopPropagation();this.$(".history-drop-target").css("border","1px dashed black")},drop:function(o){o.preventDefault();o.dataTransfer.dropEffect="move";var m=this,p=o.dataTransfer.getData("text");try{p=JSON.parse(p)}catch(n){this.warn("error parsing JSON from drop:",p)}this.trigger("droptarget:drop",o,p,m);return false},dataDropped:function(n){var m=this;if(_.isObject(n)&&n.model_class==="HistoryDatasetAssociation"&&n.id){return m.model.contents.copy(n.id)}return jQuery.when()},toString:function(){return"HistoryPanelEdit("+((this.model)?(this.model.get("name")):(""))+")"}});return{HistoryPanelEdit:f}});