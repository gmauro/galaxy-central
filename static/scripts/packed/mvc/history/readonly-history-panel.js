define(["mvc/history/history-model","mvc/dataset/hda-base","mvc/user/user-model","mvc/base-mvc","utils/localization"],function(g,b,a,f,d){var i=f.SessionStorageModel.extend({defaults:{expandedHdas:{},show_deleted:false,show_hidden:false},addExpandedHda:function(m){var l="expandedHdas";this.save(l,_.extend(this.get(l),_.object([m],[true])))},removeExpandedHda:function(m){var l="expandedHdas";this.save(l,_.omit(this.get(l),m))},toString:function(){return"HistoryPrefs("+this.id+")"}});i.storageKeyPrefix="history:";i.historyStorageKey=function e(l){if(!l){throw new Error("HistoryPrefs.historyStorageKey needs valid id: "+l)}return(i.storageKeyPrefix+l)};i.get=function c(l){return new i({id:i.historyStorageKey(l)})};i.clearAll=function h(m){for(var l in sessionStorage){if(l.indexOf(i.storageKeyPrefix)===0){sessionStorage.removeItem(l)}}};var j=Backbone.View.extend(f.LoggableMixin).extend({HDAViewClass:b.HDABaseView,tagName:"div",className:"history-panel",fxSpeed:"fast",emptyMsg:d("This history is empty"),noneFoundMsg:d("No matching datasets found"),initialize:function(l){l=l||{};if(l.logger){this.logger=l.logger}this.log(this+".initialize:",l);this.linkTarget=l.linkTarget||"_blank";this.fxSpeed=_.has(l,"fxSpeed")?(l.fxSpeed):(this.fxSpeed);this.filters=[];this.searchFor="";this.findContainerFn=l.findContainerFn;this.hdaViews={};this.indicator=new LoadingIndicator(this.$el);this._setUpListeners();var m=_.pick(l,"initiallyExpanded","show_deleted","show_hidden");this.setModel(this.model,m,false);if(l.onready){l.onready.call(this)}},_setUpListeners:function(){this.on("error",function(m,p,l,o,n){this.errorHandler(m,p,l,o,n)});this.on("loading-history",function(){this._showLoadingIndicator("loading history...",40)});this.on("loading-done",function(){this._hideLoadingIndicator(40);if(_.isEmpty(this.hdaViews)){this.trigger("empty-history",this)}});this.once("rendered",function(){this.trigger("rendered:initial",this);return false});if(this.logger){this.on("all",function(l){this.log(this+"",arguments)},this)}return this},errorHandler:function(n,q,m,p,o){console.error(n,q,m,p,o);if(q&&q.status===0&&q.readyState===0){}else{if(q&&q.status===502){}else{var l=this._parseErrorMessage(n,q,m,p,o);if(!this.$messages().is(":visible")){this.once("rendered",function(){this.displayMessage("error",l.message,l.details)})}else{this.displayMessage("error",l.message,l.details)}}}},_parseErrorMessage:function(o,s,n,r,q){var m=Galaxy.currUser,l={message:this._bePolite(r),details:{user:(m instanceof a.User)?(m.toJSON()):(m+""),source:(o instanceof Backbone.Model)?(o.toJSON()):(o+""),xhr:s,options:(s)?(_.omit(n,"xhr")):(n)}};_.extend(l.details,q||{});if(s&&_.isFunction(s.getAllResponseHeaders)){var p=s.getAllResponseHeaders();p=_.compact(p.split("\n"));p=_.map(p,function(t){return t.split(": ")});l.details.xhr.responseHeaders=_.object(p)}return l},_bePolite:function(l){l=l||d("An error occurred while getting updates from the server");return l+". "+d("Please contact a Galaxy administrator if the problem persists.")},loadHistoryWithHDADetails:function(n,m,l,p){var o=function(q){return _.keys(i.get(q.id).get("expandedHdas"))};return this.loadHistory(n,m,l,p,o)},loadHistory:function(o,n,m,r,p){var l=this;n=n||{};l.trigger("loading-history",l);var q=g.History.getHistoryData(o,{historyFn:m,hdaFn:r,hdaDetailIds:n.initiallyExpanded||p});return l._loadHistoryFromXHR(q,n).fail(function(u,s,t){l.trigger("error",l,u,n,d("An error was encountered while "+s),{historyId:o,history:t||{}})}).always(function(){l.trigger("loading-done",l)})},_loadHistoryFromXHR:function(n,m){var l=this;n.then(function(o,p){l.JSONToModel(o,p,m)});n.fail(function(p,o){l.render()});return n},JSONToModel:function(o,l,m){this.log("JSONToModel:",o,l,m);m=m||{};var n=new g.History(o,l,m);this.setModel(n);return this},setModel:function(m,l,n){l=l||{};n=(n!==undefined)?(n):(true);this.log("setModel:",m,l,n);this.freeModel();this.selectedHdaIds=[];if(m){this.model=m;if(this.logger){this.model.logger=this.logger}this._setUpWebStorage(l.initiallyExpanded,l.show_deleted,l.show_hidden);this._setUpModelEventHandlers();this.trigger("new-model",this)}if(n){this.render()}return this},freeModel:function(){if(this.model){this.model.clearUpdateTimeout();this.stopListening(this.model);this.stopListening(this.model.hdas)}this.freeHdaViews();return this},freeHdaViews:function(){this.hdaViews={};return this},_setUpWebStorage:function(m,l,n){this.storage=new i({id:i.historyStorageKey(this.model.get("id"))});if(_.isObject(m)){this.storage.set("exandedHdas",m)}if(_.isBoolean(l)){this.storage.set("show_deleted",l)}if(_.isBoolean(n)){this.storage.set("show_hidden",n)}this.trigger("new-storage",this.storage,this);this.log(this+" (init'd) storage:",this.storage.get());return this},_setUpModelEventHandlers:function(){this.model.hdas.on("add",this.addHdaView,this);this.model.on("error error:hdas",function(m,o,l,n){this.errorHandler(m,o,l,n)},this);return this},render:function(n,o){this.log("render:",n,o);n=(n===undefined)?(this.fxSpeed):(n);var l=this,m;if(this.model){m=this.renderModel()}else{m=this.renderWithoutModel()}$(l).queue("fx",[function(p){if(n&&l.$el.is(":visible")){l.$el.fadeOut(n,p)}else{p()}},function(p){l.$el.empty();if(m){l.$el.append(m.children())}p()},function(p){if(n&&!l.$el.is(":visible")){l.$el.fadeIn(n,p)}else{p()}},function(p){if(o){o.call(this)}l.trigger("rendered",this);p()}]);return this},renderWithoutModel:function(){var l=$("<div/>"),m=$("<div/>").addClass("message-container").css({margin:"4px"});return l.append(m)},renderModel:function(){var l=$("<div/>");l.append(j.templates.historyPanel(this.model.toJSON()));this.$emptyMessage(l).text(this.emptyMsg);l.find(".history-secondary-actions").prepend(this._renderSearchButton());this._setUpBehaviours(l);this.renderHdas(l);return l},_renderEmptyMsg:function(n){var m=this,l=m.$emptyMessage(n);if(!_.isEmpty(m.hdaViews)){l.hide()}else{if(m.searchFor){l.text(m.noneFoundMsg).show()}else{l.text(m.emptyMsg).show()}}return this},_renderSearchButton:function(l){return faIconButton({title:d("Search datasets"),classes:"history-search-btn",faIcon:"fa-search"})},_setUpBehaviours:function(l){l=l||this.$el;l.find("[title]").tooltip({placement:"bottom"});this._setUpSearchInput(l.find(".history-search-controls .history-search-input"));return this},$container:function(){return(this.findContainerFn)?(this.findContainerFn.call(this)):(this.$el.parent())},$datasetsList:function(l){return(l||this.$el).find(".datasets-list")},$messages:function(l){return(l||this.$el).find(".message-container")},$emptyMessage:function(l){return(l||this.$el).find(".empty-history-message")},renderHdas:function(m){m=m||this.$el;var l=this,o={},n=this.model.hdas.getVisible(this.storage.get("show_deleted"),this.storage.get("show_hidden"),this.filters);this.$datasetsList(m).empty();if(n.length){n.each(function(q){var p=q.get("id"),r=l._createHdaView(q);o[p]=r;if(_.contains(l.selectedHdaIds,p)){r.selected=true}l.attachHdaView(r.render(),m)})}this.hdaViews=o;this._renderEmptyMsg(m);return this.hdaViews},_createHdaView:function(m){var l=m.get("id"),n=new this.HDAViewClass({model:m,linkTarget:this.linkTarget,expanded:this.storage.get("expandedHdas")[l],hasUser:this.model.ownedByCurrUser(),logger:this.logger});this._setUpHdaListeners(n);return n},_setUpHdaListeners:function(m){var l=this;m.on("error",function(o,q,n,p){l.errorHandler(o,q,n,p)});m.on("body-expanded",function(n){l.storage.addExpandedHda(n)});m.on("body-collapsed",function(n){l.storage.removeExpandedHda(n)});return this},attachHdaView:function(n,m){m=m||this.$el;var l=this.$datasetsList(m);l.prepend(n.$el);return this},addHdaView:function(o){this.log("add."+this,o);var m=this;if(!o.isVisible(this.storage.get("show_deleted"),this.storage.get("show_hidden"))){return m}$({}).queue([function n(q){var p=m.$emptyMessage();if(p.is(":visible")){p.fadeOut(m.fxSpeed,q)}else{q()}},function l(p){var q=m._createHdaView(o);m.hdaViews[o.id]=q;q.render().$el.hide();m.scrollToTop();m.attachHdaView(q);q.$el.slideDown(m.fxSpeed)}]);return m},refreshHdas:function(m,l){if(this.model){return this.model.refresh(m,l)}return $.when()},events:{"click .message-container":"clearMessages","click .history-search-btn":"toggleSearchControls"},collapseAllHdaBodies:function(){_.each(this.hdaViews,function(l){l.toggleBodyVisibility(null,false)});this.storage.set("expandedHdas",{});return this},toggleShowDeleted:function(l){l=(l!==undefined)?(l):(!this.storage.get("show_deleted"));this.storage.set("show_deleted",l);this.renderHdas();return this.storage.get("show_deleted")},toggleShowHidden:function(l){l=(l!==undefined)?(l):(!this.storage.get("show_hidden"));this.storage.set("show_hidden",l);this.renderHdas();return this.storage.get("show_hidden")},_setUpSearchInput:function(m){var n=this,o=".history-search-input";function l(p){if(n.model.hdas.haveDetails()){n.searchHdas(p);return}n.$el.find(o).searchInput("toggle-loading");n.model.hdas.fetchAllDetails({silent:true}).always(function(){n.$el.find(o).searchInput("toggle-loading")}).done(function(){n.searchHdas(p)})}m.searchInput({initialVal:n.searchFor,name:"history-search",placeholder:"search datasets",classes:"history-search",onfirstsearch:l,onsearch:_.bind(this.searchHdas,this),onclear:_.bind(this.clearHdaSearch,this)});return m},toggleSearchControls:function(n,l){var m=this.$el.find(".history-search-controls"),o=(jQuery.type(n)==="number")?(n):(this.fxSpeed);l=(l!==undefined)?(l):(!m.is(":visible"));if(l){m.slideDown(o,function(){$(this).find("input").focus()})}else{m.slideUp(o)}return l},searchHdas:function(l){var m=this;this.searchFor=l;this.filters=[function(n){return n.matchesAll(m.searchFor)}];this.trigger("search:searching",l,this);this.renderHdas();return this},clearHdaSearch:function(l){this.searchFor="";this.filters=[];this.trigger("search:clear",this);this.renderHdas();return this},_showLoadingIndicator:function(m,l,n){l=(l!==undefined)?(l):(this.fxSpeed);if(!this.indicator){this.indicator=new LoadingIndicator(this.$el,this.$el.parent())}if(!this.$el.is(":visible")){this.indicator.show(0,n)}else{this.$el.fadeOut(l);this.indicator.show(m,l,n)}},_hideLoadingIndicator:function(l,m){l=(l!==undefined)?(l):(this.fxSpeed);if(this.indicator){this.indicator.hide(l,m)}},displayMessage:function(q,r,p){var n=this;this.scrollToTop();var o=this.$messages(),l=$("<div/>").addClass(q+"message").html(r);if(!_.isEmpty(p)){var m=$('<a href="javascript:void(0)">Details</a>').click(function(){Galaxy.modal.show(n._messageToModalOptions(q,r,p));return false});l.append(" ",m)}return o.html(l)},_messageToModalOptions:function(p,r,o){var l=this,q=$("<div/>"),n={title:"Details"};function m(s){s=_.omit(s,_.functions(s));return["<table>",_.map(s,function(u,t){u=(_.isObject(u))?(m(u)):(u);return'<tr><td style="vertical-align: top; color: grey">'+t+'</td><td style="padding-left: 8px">'+u+"</td></tr>"}).join(""),"</table>"].join("")}if(_.isObject(o)){n.body=q.append(m(o))}else{n.body=q.html(o)}n.buttons={Ok:function(){Galaxy.modal.hide();l.clearMessages()}};return n},clearMessages:function(){this.$messages().empty();return this},scrollPosition:function(){return this.$container().scrollTop()},scrollTo:function(l){this.$container().scrollTop(l);return this},scrollToTop:function(){this.$container().scrollTop(0);return this},scrollToId:function(m){if((!m)||(!this.hdaViews[m])){return this}var l=this.hdaViews[m];this.scrollTo(l.el.offsetTop);return this},scrollToHid:function(l){var m=this.model.hdas.getByHid(l);if(!m){return this}return this.scrollToId(m.id)},toString:function(){return"ReadOnlyHistoryPanel("+((this.model)?(this.model.get("name")):(""))+")"}});var k=['<div class="history-controls">','<div class="history-search-controls">','<div class="history-search-input"></div>',"</div>",'<div class="history-title">',"<% if( history.name ){ %>",'<div class="history-name"><%= history.name %></div>',"<% } %>","</div>",'<div class="history-subtitle clear">',"<% if( history.nice_size ){ %>",'<div class="history-size"><%= history.nice_size %></div>',"<% } %>",'<div class="history-secondary-actions"></div>',"</div>","<% if( history.deleted ){ %>",'<div class="warningmessagesmall"><strong>',d("You are currently viewing a deleted history!"),"</strong></div>","<% } %>",'<div class="message-container">',"<% if( history.message ){ %>",'<div class="<%= history.status %>message"><%= history.message %></div>',"<% } %>","</div>",'<div class="quota-message errormessage">',d("You are over your disk quota."),d("Tool execution is on hold until your disk usage drops below your allocated quota."),"</div>",'<div class="tags-display"></div>','<div class="annotation-display"></div>','<div class="history-dataset-actions">','<div class="btn-group">','<button class="history-select-all-datasets-btn btn btn-default"','data-mode="select">',d("All"),"</button>",'<button class="history-deselect-all-datasets-btn btn btn-default"','data-mode="select">',d("None"),"</button>","</div>",'<button class="history-dataset-action-popup-btn btn btn-default">',d("For all selected"),"...</button>","</div>","</div>",'<div class="datasets-list"></div>','<div class="empty-history-message infomessagesmall">',d("Your history is empty. Click 'Get Data' on the left pane to start"),"</div>"].join("");j.templates={historyPanel:function(l){return _.template(k,l,{variable:"history"})}};return{ReadOnlyHistoryPanel:j}});