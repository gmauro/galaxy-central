define(["mvc/history/history-model","mvc/collection/hdca-base","mvc/dataset/dataset-list-element","mvc/dataset/hda-base","mvc/user/user-model","mvc/base-mvc","utils/localization"],function(d,a,k,i,e,l,c){var h=l.SessionStorageModel.extend({defaults:{expandedHdas:{},show_deleted:false,show_hidden:false},addExpandedHda:function(n){var o="expandedHdas";this.save(o,_.extend(this.get(o),_.object([n.id],[n.get("id")])))},removeExpandedHda:function(n){var o="expandedHdas";this.save(o,_.omit(this.get(o),n.id))},toString:function(){return"HistoryPrefs("+this.id+")"}});h.storageKeyPrefix="history:";h.historyStorageKey=function f(n){if(!n){throw new Error("HistoryPrefs.historyStorageKey needs valid id: "+n)}return(h.storageKeyPrefix+n)};h.get=function b(n){return new h({id:h.historyStorageKey(n)})};h.clearAll=function g(o){for(var n in sessionStorage){if(n.indexOf(h.storageKeyPrefix)===0){sessionStorage.removeItem(n)}}};var j=Backbone.View.extend(l.LoggableMixin).extend({HDAViewClass:k.DatasetListItemView,HDCAViewClass:a.HDCABaseView,tagName:"div",className:"history-panel",fxSpeed:"fast",emptyMsg:c("This history is empty"),noneFoundMsg:c("No matching datasets found"),initialize:function(n){n=n||{};if(n.logger){this.logger=n.logger}this.log(this+".initialize:",n);this.linkTarget=n.linkTarget||"_blank";this.fxSpeed=_.has(n,"fxSpeed")?(n.fxSpeed):(this.fxSpeed);this.filters=[];this.searchFor="";this.findContainerFn=n.findContainerFn;this.hdaViews={};this.indicator=new LoadingIndicator(this.$el);this._setUpListeners();var o=_.pick(n,"initiallyExpanded","show_deleted","show_hidden");this.setModel(this.model,o,false);if(n.onready){n.onready.call(this)}},_setUpListeners:function(){this.on("error",function(o,r,n,q,p){this.errorHandler(o,r,n,q,p)});this.on("loading-history",function(){this._showLoadingIndicator("loading history...",40)});this.on("loading-done",function(){this._hideLoadingIndicator(40);if(_.isEmpty(this.hdaViews)){this.trigger("empty-history",this)}});this.once("rendered",function(){this.trigger("rendered:initial",this);return false});if(this.logger){this.on("all",function(n){this.log(this+"",arguments)},this)}return this},errorHandler:function(p,s,o,r,q){this.error(p,s,o,r,q);if(s&&s.status===0&&s.readyState===0){}else{if(s&&s.status===502){}else{var n=this._parseErrorMessage(p,s,o,r,q);if(!this.$messages().is(":visible")){this.once("rendered",function(){this.displayMessage("error",n.message,n.details)})}else{this.displayMessage("error",n.message,n.details)}}}},_parseErrorMessage:function(q,u,p,t,s){var o=Galaxy.currUser,n={message:this._bePolite(t),details:{user:(o instanceof e.User)?(o.toJSON()):(o+""),source:(q instanceof Backbone.Model)?(q.toJSON()):(q+""),xhr:u,options:(u)?(_.omit(p,"xhr")):(p)}};_.extend(n.details,s||{});if(u&&_.isFunction(u.getAllResponseHeaders)){var r=u.getAllResponseHeaders();r=_.compact(r.split("\n"));r=_.map(r,function(v){return v.split(": ")});n.details.xhr.responseHeaders=_.object(r)}return n},_bePolite:function(n){n=n||c("An error occurred while getting updates from the server");return n+". "+c("Please contact a Galaxy administrator if the problem persists")+"."},loadHistoryWithHDADetails:function(p,o,n,r){var q=function(s){return _.values(h.get(s.id).get("expandedHdas"))};return this.loadHistory(p,o,n,r,q)},loadHistory:function(q,p,o,t,r){var n=this;p=p||{};n.trigger("loading-history",n);var s=d.History.getHistoryData(q,{historyFn:o,hdaFn:t,hdaDetailIds:p.initiallyExpanded||r});return n._loadHistoryFromXHR(s,p).fail(function(w,u,v){n.trigger("error",n,w,p,c("An error was encountered while "+u),{historyId:q,history:v||{}})}).always(function(){n.trigger("loading-done",n)})},_loadHistoryFromXHR:function(p,o){var n=this;p.then(function(q,r){n.JSONToModel(q,r,o)});p.fail(function(r,q){n.render()});return p},JSONToModel:function(q,n,o){this.log("JSONToModel:",q,n,o);o=o||{};var p=new d.History(q,n,o);this.setModel(p);return this},setModel:function(o,n,p){n=n||{};p=(p!==undefined)?(p):(true);this.log("setModel:",o,n,p);this.freeModel();this.selectedHdaIds=[];if(o){this.model=o;if(this.logger){this.model.logger=this.logger}this._setUpWebStorage(n.initiallyExpanded,n.show_deleted,n.show_hidden);this._setUpModelEventHandlers();this.trigger("new-model",this)}if(p){this.render()}return this},freeModel:function(){if(this.model){this.model.clearUpdateTimeout();this.stopListening(this.model);this.stopListening(this.model.contents)}this.freeHdaViews();return this},freeHdaViews:function(){this.hdaViews={};return this},_setUpWebStorage:function(o,n,p){this.storage=new h({id:h.historyStorageKey(this.model.get("id"))});if(_.isObject(o)){this.storage.set("exandedHdas",o)}if(_.isBoolean(n)){this.storage.set("show_deleted",n)}if(_.isBoolean(p)){this.storage.set("show_hidden",p)}this.trigger("new-storage",this.storage,this);this.log(this+" (init'd) storage:",this.storage.get());return this},_setUpModelEventHandlers:function(){this.model.contents.on("add",this.addContentView,this);this.model.on("error error:contents",function(o,q,n,p){this.errorHandler(o,q,n,p)},this);return this},render:function(p,q){this.log("render:",p,q);p=(p===undefined)?(this.fxSpeed):(p);var n=this,o;if(this.model){o=this.renderModel()}else{o=this.renderWithoutModel()}$(n).queue("fx",[function(r){if(p&&n.$el.is(":visible")){n.$el.fadeOut(p,r)}else{r()}},function(r){n.$el.empty();if(o){n.$el.append(o.children())}r()},function(r){if(p&&!n.$el.is(":visible")){n.$el.fadeIn(p,r)}else{r()}},function(r){if(q){q.call(this)}n.trigger("rendered",this);r()}]);return this},renderWithoutModel:function(){var n=$("<div/>"),o=$("<div/>").addClass("message-container").css({margin:"4px"});return n.append(o)},renderModel:function(){var n=$("<div/>");n.append(j.templates.historyPanel(this.model.toJSON()));this.$emptyMessage(n).text(this.emptyMsg);n.find(".history-secondary-actions").prepend(this._renderSearchButton());this._setUpBehaviours(n);this.renderHdas(n);return n},_renderEmptyMsg:function(p){var o=this,n=o.$emptyMessage(p);if(!_.isEmpty(o.hdaViews)){n.hide()}else{if(o.searchFor){n.text(o.noneFoundMsg).show()}else{n.text(o.emptyMsg).show()}}return this},_renderSearchButton:function(n){return faIconButton({title:c("Search datasets"),classes:"history-search-btn",faIcon:"fa-search"})},_setUpBehaviours:function(n){n=n||this.$el;n.find("[title]").tooltip({placement:"bottom"});this._setUpSearchInput(n.find(".history-search-controls .history-search-input"));return this},$container:function(){return(this.findContainerFn)?(this.findContainerFn.call(this)):(this.$el.parent())},$datasetsList:function(n){return(n||this.$el).find(".datasets-list")},$messages:function(n){return(n||this.$el).find(".message-container")},$emptyMessage:function(n){return(n||this.$el).find(".empty-history-message")},renderHdas:function(o){o=o||this.$el;var n=this,q={},p=this.model.contents.getVisible(this.storage.get("show_deleted"),this.storage.get("show_hidden"),this.filters);this.$datasetsList(o).empty();if(p.length){p.each(function(s){var r=s.id,t=n._createContentView(s);q[r]=t;if(_.contains(n.selectedHdaIds,r)){t.selected=true}n.attachContentView(t.render(),o)})}this.hdaViews=q;this._renderEmptyMsg(o);return this.hdaViews},_createContentView:function(q){var o=this._getContentClass(q),n=_.extend(this._getContentOptions(q),{model:q}),p=new o(n);this._setUpHdaListeners(p);return p},_getContentClass:function(n){var o=n.get("history_content_type");switch(o){case"dataset":return this.HDAViewClass;case"dataset_collection":return this.HDCAViewClass}throw new TypeError("Unknown history_content_type: "+o)},_getContentOptions:function(n){return{linkTarget:this.linkTarget,expanded:!!this.storage.get("expandedHdas")[n.id],hasUser:this.model.ownedByCurrUser(),logger:this.logger}},_setUpHdaListeners:function(o){var n=this;o.on("error",function(q,s,p,r){n.errorHandler(q,s,p,r)});o.on("expanded",function(p){n.storage.addExpandedHda(p.model)});o.on("collapsed",function(p){n.storage.removeExpandedHda(p.model)});return this},attachContentView:function(p,o){o=o||this.$el;var n=this.$datasetsList(o);n.prepend(p.$el);return this},addContentView:function(q){this.log("add."+this,q);var o=this;if(!q.isVisible(this.storage.get("show_deleted"),this.storage.get("show_hidden"))){return o}$({}).queue([function p(s){var r=o.$emptyMessage();if(r.is(":visible")){r.fadeOut(o.fxSpeed,s)}else{s()}},function n(r){var s=o._createContentView(q);o.hdaViews[q.id]=s;s.render().$el.hide();o.scrollToTop();o.attachContentView(s);s.$el.slideDown(o.fxSpeed)}]);return o},views:function(n){var o=this,p=this.model.contents.getVisible(this.storage.get("show_deleted"),this.storage.get("show_hidden"),this.filters);if(n!==undefined){return o.hdaViews[p.at(n).id]}return p.map(function(q){return o.hdaViews[q.id]})},refreshContents:function(o,n){if(this.model){return this.model.refresh(o,n)}return $.when()},hdaViewRange:function(q,p){if(q===p){return[q]}var n=this,o=false,r=[];this.model.contents.getVisible(this.storage.get("show_deleted"),this.storage.get("show_hidden"),this.filters).each(function(s){if(o){r.push(n.hdaViews[s.id]);if(s===q.model||s===p.model){o=false}}else{if(s===q.model||s===p.model){o=true;r.push(n.hdaViews[s.id])}}});return r},events:{"click .message-container":"clearMessages","click .history-search-btn":"toggleSearchControls"},collapseAllHdaBodies:function(){_.each(this.hdaViews,function(n){n.collapse()});this.storage.set("expandedHdas",{});return this},toggleShowDeleted:function(n){n=(n!==undefined)?(n):(!this.storage.get("show_deleted"));this.storage.set("show_deleted",n);this.renderHdas();return this.storage.get("show_deleted")},toggleShowHidden:function(n){n=(n!==undefined)?(n):(!this.storage.get("show_hidden"));this.storage.set("show_hidden",n);this.renderHdas();return this.storage.get("show_hidden")},_setUpSearchInput:function(o){var p=this,q=".history-search-input";function n(r){if(p.model.contents.haveDetails()){p.searchHdas(r);return}p.$el.find(q).searchInput("toggle-loading");p.model.contents.fetchAllDetails({silent:true}).always(function(){p.$el.find(q).searchInput("toggle-loading")}).done(function(){p.searchHdas(r)})}o.searchInput({initialVal:p.searchFor,name:"history-search",placeholder:"search datasets",classes:"history-search",onfirstsearch:n,onsearch:_.bind(this.searchHdas,this),onclear:_.bind(this.clearHdaSearch,this)});return o},toggleSearchControls:function(p,n){var o=this.$el.find(".history-search-controls"),q=(jQuery.type(p)==="number")?(p):(this.fxSpeed);n=(n!==undefined)?(n):(!o.is(":visible"));if(n){o.slideDown(q,function(){$(this).find("input").focus()})}else{o.slideUp(q)}return n},searchHdas:function(n){var o=this;this.searchFor=n;this.filters=[function(p){return p.matchesAll(o.searchFor)}];this.trigger("search:searching",n,this);this.renderHdas();return this},clearHdaSearch:function(n){this.searchFor="";this.filters=[];this.trigger("search:clear",this);this.renderHdas();return this},_showLoadingIndicator:function(o,n,p){n=(n!==undefined)?(n):(this.fxSpeed);if(!this.indicator){this.indicator=new LoadingIndicator(this.$el,this.$el.parent())}if(!this.$el.is(":visible")){this.indicator.show(0,p)}else{this.$el.fadeOut(n);this.indicator.show(o,n,p)}},_hideLoadingIndicator:function(n,o){n=(n!==undefined)?(n):(this.fxSpeed);if(this.indicator){this.indicator.hide(n,o)}},displayMessage:function(s,t,r){var p=this;this.scrollToTop();var q=this.$messages(),n=$("<div/>").addClass(s+"message").html(t);if(!_.isEmpty(r)){var o=$('<a href="javascript:void(0)">Details</a>').click(function(){Galaxy.modal.show(p._messageToModalOptions(s,t,r));return false});n.append(" ",o)}return q.html(n)},_messageToModalOptions:function(r,t,q){var n=this,s=$("<div/>"),p={title:"Details"};function o(u){u=_.omit(u,_.functions(u));return["<table>",_.map(u,function(w,v){w=(_.isObject(w))?(o(w)):(w);return'<tr><td style="vertical-align: top; color: grey">'+v+'</td><td style="padding-left: 8px">'+w+"</td></tr>"}).join(""),"</table>"].join("")}if(_.isObject(q)){p.body=s.append(o(q))}else{p.body=s.html(q)}p.buttons={Ok:function(){Galaxy.modal.hide();n.clearMessages()}};return p},clearMessages:function(){this.$messages().empty();return this},scrollPosition:function(){return this.$container().scrollTop()},scrollTo:function(n){this.$container().scrollTop(n);return this},scrollToTop:function(){this.$container().scrollTop(0);return this},scrollToId:function(o){if((!o)||(!this.hdaViews[o])){return this}var n=this.hdaViews[o];this.scrollTo(n.el.offsetTop);return this},scrollToHid:function(n){var o=this.model.contents.getByHid(n);if(!o){return this}return this.scrollToId(o.id)},print:function(){var n=this;n.debug(this);_.each(this.hdaViews,function(o,p){n.debug("\t "+p,o)})},toString:function(){return"ReadOnlyHistoryPanel("+((this.model)?(this.model.get("name")):(""))+")"}});var m=['<div class="history-controls">','<div class="history-search-controls">','<div class="history-search-input"></div>',"</div>",'<div class="history-title">',"<% if( history.name ){ %>",'<div class="history-name"><%= history.name %></div>',"<% } %>","</div>",'<div class="history-subtitle clear">',"<% if( history.nice_size ){ %>",'<div class="history-size"><%= history.nice_size %></div>',"<% } %>",'<div class="history-secondary-actions"></div>',"</div>","<% if( history.deleted ){ %>",'<div class="warningmessagesmall"><strong>',c("You are currently viewing a deleted history!"),"</strong></div>","<% } %>",'<div class="message-container">',"<% if( history.message ){ %>",'<div class="<%= history.status %>message"><%= history.message %></div>',"<% } %>","</div>",'<div class="quota-message errormessage">',c("You are over your disk quota"),". ",c("Tool execution is on hold until your disk usage drops below your allocated quota"),".","</div>",'<div class="tags-display"></div>','<div class="annotation-display"></div>','<div class="history-dataset-actions">','<div class="btn-group">','<button class="history-select-all-datasets-btn btn btn-default"','data-mode="select">',c("All"),"</button>",'<button class="history-deselect-all-datasets-btn btn btn-default"','data-mode="select">',c("None"),"</button>","</div>",'<button class="history-dataset-action-popup-btn btn btn-default">',c("For all selected"),"...</button>","</div>","</div>",'<div class="datasets-list"></div>','<div class="empty-history-message infomessagesmall">',c("This history is empty"),"</div>"].join("");j.templates={historyPanel:function(n){return _.template(m,n,{variable:"history"})}};return{ReadOnlyHistoryPanel:j}});