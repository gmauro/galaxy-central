define(["mvc/history/history-model","mvc/dataset/hda-base","mvc/user/user-model","mvc/base-mvc"],function(f,b,a,e){var h=e.SessionStorageModel.extend({defaults:{expandedHdas:{},show_deleted:false,show_hidden:false},addExpandedHda:function(l){var k="expandedHdas";this.save(k,_.extend(this.get(k),_.object([l],[true])))},removeExpandedHda:function(l){var k="expandedHdas";this.save(k,_.omit(this.get(k),l))},toString:function(){return"HistoryPrefs("+this.id+")"}});h.storageKeyPrefix="history:";h.historyStorageKey=function d(k){if(!k){throw new Error("HistoryPrefs.historyStorageKey needs valid id: "+k)}return(h.storageKeyPrefix+k)};h.get=function c(k){return new h({id:h.historyStorageKey(k)})};h.clearAll=function g(l){for(var k in sessionStorage){if(k.indexOf(h.storageKeyPrefix)===0){sessionStorage.removeItem(k)}}};var i=Backbone.View.extend(e.LoggableMixin).extend({HDAViewClass:b.HDABaseView,tagName:"div",className:"history-panel",fxSpeed:"fast",emptyMsg:_l("This history is empty"),noneFoundMsg:_l("No matching datasets found"),initialize:function(k){k=k||{};if(k.logger){this.logger=k.logger}this.log(this+".initialize:",k);this.linkTarget=k.linkTarget||"_blank";this.fxSpeed=_.has(k,"fxSpeed")?(k.fxSpeed):(this.fxSpeed);this.filters=[];this.searchFor="";this.findContainerFn=k.findContainerFn;this.hdaViews={};this.indicator=new LoadingIndicator(this.$el);this._setUpListeners();var l=_.pick(k,"initiallyExpanded","show_deleted","show_hidden");this.setModel(this.model,l,false);if(k.onready){k.onready.call(this)}},_setUpListeners:function(){this.on("error",function(l,o,k,n,m){this.errorHandler(l,o,k,n,m)});this.on("loading-history",function(){this._showLoadingIndicator("loading history...",40)});this.on("loading-done",function(){this._hideLoadingIndicator(40);if(_.isEmpty(this.hdaViews)){this.trigger("empty-history",this)}});this.once("rendered",function(){this.trigger("rendered:initial",this);return false});if(this.logger){this.on("all",function(k){this.log(this+"",arguments)},this)}return this},errorHandler:function(m,p,l,o,n){console.error(m,p,l,o,n);if(p&&p.status===0&&p.readyState===0){}else{if(p&&p.status===502){}else{var k=this._parseErrorMessage(m,p,l,o,n);if(!this.$messages().is(":visible")){this.once("rendered",function(){this.displayMessage("error",k.message,k.details)})}else{this.displayMessage("error",k.message,k.details)}}}},_parseErrorMessage:function(n,r,m,q,p){var l=Galaxy.currUser,k={message:this._bePolite(q),details:{user:(l instanceof a.User)?(l.toJSON()):(l+""),source:(n instanceof Backbone.Model)?(n.toJSON()):(n+""),xhr:r,options:(r)?(_.omit(m,"xhr")):(m)}};_.extend(k.details,p||{});if(r&&_.isFunction(r.getAllResponseHeaders)){var o=r.getAllResponseHeaders();o=_.compact(o.split("\n"));o=_.map(o,function(s){return s.split(": ")});k.details.xhr.responseHeaders=_.object(o)}return k},_bePolite:function(k){k=k||_l("An error occurred while getting updates from the server");return k+". "+_l("Please contact a Galaxy administrator if the problem persists.")},loadHistoryWithHDADetails:function(m,l,k,o){var n=function(p){return _.keys(h.get(p.id).get("expandedHdas"))};return this.loadHistory(m,l,k,o,n)},loadHistory:function(n,m,l,q,o){var k=this;m=m||{};k.trigger("loading-history",k);var p=f.History.getHistoryData(n,{historyFn:l,hdaFn:q,hdaDetailIds:m.initiallyExpanded||o});return k._loadHistoryFromXHR(p,m).fail(function(t,r,s){k.trigger("error",k,t,m,_l("An error was encountered while "+r),{historyId:n,history:s||{}})}).always(function(){k.trigger("loading-done",k)})},_loadHistoryFromXHR:function(m,l){var k=this;m.then(function(n,o){k.JSONToModel(n,o,l)});m.fail(function(o,n){k.render()});return m},JSONToModel:function(n,k,l){this.log("JSONToModel:",n,k,l);l=l||{};var m=new f.History(n,k,l);this.setModel(m);return this},setModel:function(l,k,m){k=k||{};m=(m!==undefined)?(m):(true);this.log("setModel:",l,k,m);this.freeModel();this.selectedHdaIds=[];if(l){this.model=l;if(this.logger){this.model.logger=this.logger}this._setUpWebStorage(k.initiallyExpanded,k.show_deleted,k.show_hidden);this._setUpModelEventHandlers();this.trigger("new-model",this)}if(m){this.render()}return this},freeModel:function(){if(this.model){this.model.clearUpdateTimeout();this.stopListening(this.model);this.stopListening(this.model.hdas)}this.freeHdaViews();return this},freeHdaViews:function(){this.hdaViews={};return this},_setUpWebStorage:function(l,k,m){this.storage=new h({id:h.historyStorageKey(this.model.get("id"))});if(_.isObject(l)){this.storage.set("exandedHdas",l)}if(_.isBoolean(k)){this.storage.set("show_deleted",k)}if(_.isBoolean(m)){this.storage.set("show_hidden",m)}this.trigger("new-storage",this.storage,this);this.log(this+" (init'd) storage:",this.storage.get());return this},_setUpModelEventHandlers:function(){this.model.hdas.on("add",this.addHdaView,this);this.model.on("error error:hdas",function(l,n,k,m){this.errorHandler(l,n,k,m)},this);return this},render:function(m,n){this.log("render:",m,n);m=(m===undefined)?(this.fxSpeed):(m);var k=this,l;if(this.model){l=this.renderModel()}else{l=this.renderWithoutModel()}$(k).queue("fx",[function(o){if(m&&k.$el.is(":visible")){k.$el.fadeOut(m,o)}else{o()}},function(o){k.$el.empty();if(l){k.$el.append(l.children())}o()},function(o){if(m&&!k.$el.is(":visible")){k.$el.fadeIn(m,o)}else{o()}},function(o){if(n){n.call(this)}k.trigger("rendered",this);o()}]);return this},renderWithoutModel:function(){var k=$("<div/>"),l=$("<div/>").addClass("message-container").css({margin:"4px"});return k.append(l)},renderModel:function(){var k=$("<div/>");k.append(i.templates.historyPanel(this.model.toJSON()));this.$emptyMessage(k).text(this.emptyMsg);k.find(".history-secondary-actions").prepend(this._renderSearchButton());this._setUpBehaviours(k);this.renderHdas(k);return k},_renderEmptyMsg:function(m){var l=this,k=l.$emptyMessage(m);if(!_.isEmpty(l.hdaViews)){k.hide()}else{if(l.searchFor){k.text(l.noneFoundMsg).show()}else{k.text(l.emptyMsg).show()}}return this},_renderSearchButton:function(k){return faIconButton({title:_l("Search datasets"),classes:"history-search-btn",faIcon:"fa-search"})},_setUpBehaviours:function(k){k=k||this.$el;k.find("[title]").tooltip({placement:"bottom"});this._setUpSearchInput(k.find(".history-search-controls .history-search-input"));return this},$container:function(){return(this.findContainerFn)?(this.findContainerFn.call(this)):(this.$el.parent())},$datasetsList:function(k){return(k||this.$el).find(".datasets-list")},$messages:function(k){return(k||this.$el).find(".message-container")},$emptyMessage:function(k){return(k||this.$el).find(".empty-history-message")},renderHdas:function(l){l=l||this.$el;var k=this,n={},m=this.model.hdas.getVisible(this.storage.get("show_deleted"),this.storage.get("show_hidden"),this.filters);this.$datasetsList(l).empty();if(m.length){m.each(function(p){var o=p.get("id"),q=k._createHdaView(p);n[o]=q;if(_.contains(k.selectedHdaIds,o)){q.selected=true}k.attachHdaView(q.render(),l)})}this.hdaViews=n;this._renderEmptyMsg(l);return this.hdaViews},_createHdaView:function(l){var k=l.get("id"),m=new this.HDAViewClass({model:l,linkTarget:this.linkTarget,expanded:this.storage.get("expandedHdas")[k],hasUser:this.model.ownedByCurrUser(),logger:this.logger});this._setUpHdaListeners(m);return m},_setUpHdaListeners:function(l){var k=this;l.on("error",function(n,p,m,o){k.errorHandler(n,p,m,o)});l.on("body-expanded",function(m){k.storage.addExpandedHda(m)});l.on("body-collapsed",function(m){k.storage.removeExpandedHda(m)});return this},attachHdaView:function(m,l){l=l||this.$el;var k=this.$datasetsList(l);k.prepend(m.$el);return this},addHdaView:function(n){this.log("add."+this,n);var l=this;if(!n.isVisible(this.storage.get("show_deleted"),this.storage.get("show_hidden"))){return l}$({}).queue([function m(p){var o=l.$emptyMessage();if(o.is(":visible")){o.fadeOut(l.fxSpeed,p)}else{p()}},function k(o){var p=l._createHdaView(n);l.hdaViews[n.id]=p;p.render().$el.hide();l.scrollToTop();l.attachHdaView(p);p.$el.slideDown(l.fxSpeed)}]);return l},refreshHdas:function(l,k){if(this.model){return this.model.refresh(l,k)}return $.when()},events:{"click .message-container":"clearMessages","click .history-search-btn":"toggleSearchControls"},collapseAllHdaBodies:function(){_.each(this.hdaViews,function(k){k.toggleBodyVisibility(null,false)});this.storage.set("expandedHdas",{});return this},toggleShowDeleted:function(k){k=(k!==undefined)?(k):(!this.storage.get("show_deleted"));this.storage.set("show_deleted",k);this.renderHdas();return this.storage.get("show_deleted")},toggleShowHidden:function(k){k=(k!==undefined)?(k):(!this.storage.get("show_hidden"));this.storage.set("show_hidden",k);this.renderHdas();return this.storage.get("show_hidden")},_setUpSearchInput:function(l){var m=this,n=".history-search-input";function k(o){if(m.model.hdas.haveDetails()){m.searchHdas(o);return}m.$el.find(n).searchInput("toggle-loading");m.model.hdas.fetchAllDetails({silent:true}).always(function(){m.$el.find(n).searchInput("toggle-loading")}).done(function(){m.searchHdas(o)})}l.searchInput({initialVal:m.searchFor,name:"history-search",placeholder:"search datasets",classes:"history-search",onfirstsearch:k,onsearch:_.bind(this.searchHdas,this),onclear:_.bind(this.clearHdaSearch,this)});return l},toggleSearchControls:function(m,k){var l=this.$el.find(".history-search-controls"),n=(jQuery.type(m)==="number")?(m):(this.fxSpeed);k=(k!==undefined)?(k):(!l.is(":visible"));if(k){l.slideDown(n,function(){$(this).find("input").focus()})}else{l.slideUp(n)}return k},searchHdas:function(k){var l=this;this.searchFor=k;this.filters=[function(m){return m.matchesAll(l.searchFor)}];this.trigger("search:searching",k,this);this.renderHdas();return this},clearHdaSearch:function(k){this.searchFor="";this.filters=[];this.trigger("search:clear",this);this.renderHdas();return this},_showLoadingIndicator:function(l,k,m){k=(k!==undefined)?(k):(this.fxSpeed);if(!this.indicator){this.indicator=new LoadingIndicator(this.$el,this.$el.parent())}if(!this.$el.is(":visible")){this.indicator.show(0,m)}else{this.$el.fadeOut(k);this.indicator.show(l,k,m)}},_hideLoadingIndicator:function(k,l){k=(k!==undefined)?(k):(this.fxSpeed);if(this.indicator){this.indicator.hide(k,l)}},displayMessage:function(p,q,o){var m=this;this.scrollToTop();var n=this.$messages(),k=$("<div/>").addClass(p+"message").html(q);if(!_.isEmpty(o)){var l=$('<a href="javascript:void(0)">Details</a>').click(function(){Galaxy.modal.show(m._messageToModalOptions(p,q,o));return false});k.append(" ",l)}return n.html(k)},_messageToModalOptions:function(o,q,n){var k=this,p=$("<div/>"),m={title:"Details"};function l(r){r=_.omit(r,_.functions(r));return["<table>",_.map(r,function(t,s){t=(_.isObject(t))?(l(t)):(t);return'<tr><td style="vertical-align: top; color: grey">'+s+'</td><td style="padding-left: 8px">'+t+"</td></tr>"}).join(""),"</table>"].join("")}if(_.isObject(n)){m.body=p.append(l(n))}else{m.body=p.html(n)}m.buttons={Ok:function(){Galaxy.modal.hide();k.clearMessages()}};return m},clearMessages:function(){this.$messages().empty();return this},scrollPosition:function(){return this.$container().scrollTop()},scrollTo:function(k){this.$container().scrollTop(k);return this},scrollToTop:function(){this.$container().scrollTop(0);return this},scrollToId:function(l){if((!l)||(!this.hdaViews[l])){return this}var k=this.hdaViews[l];this.scrollTo(k.el.offsetTop);return this},scrollToHid:function(k){var l=this.model.hdas.getByHid(k);if(!l){return this}return this.scrollToId(l.id)},toString:function(){return"ReadOnlyHistoryPanel("+((this.model)?(this.model.get("name")):(""))+")"}});var j=['<div class="history-controls">','<div class="history-search-controls">','<div class="history-search-input"></div>',"</div>",'<div class="history-title">',"<% if( history.name ){ %>",'<div class="history-name"><%= history.name %></div>',"<% } %>","</div>",'<div class="history-subtitle clear">',"<% if( history.nice_size ){ %>",'<div class="history-size"><%= history.nice_size %></div>',"<% } %>",'<div class="history-secondary-actions"></div>',"</div>","<% if( history.deleted ){ %>",'<div class="warningmessagesmall"><strong>',_l("You are currently viewing a deleted history!"),"</strong></div>","<% } %>",'<div class="message-container">',"<% if( history.message ){ %>",'<div class="<%= history.status %>message"><%= history.message %></div>',"<% } %>","</div>",'<div class="quota-message errormessage">',_l("You are over your disk quota."),_l("Tool execution is on hold until your disk usage drops below your allocated quota."),"</div>",'<div class="tags-display"></div>','<div class="annotation-display"></div>','<div class="history-dataset-actions">','<div class="btn-group">','<button class="history-select-all-datasets-btn btn btn-default"','data-mode="select">',_l("All"),"</button>",'<button class="history-deselect-all-datasets-btn btn btn-default"','data-mode="select">',_l("None"),"</button>","</div>",'<button class="history-dataset-action-popup-btn btn btn-default">',_l("For all selected"),"...</button>","</div>","</div>",'<div class="datasets-list"></div>','<div class="empty-history-message infomessagesmall">',_l("Your history is empty. Click 'Get Data' on the left pane to start"),"</div>"].join("");i.templates={historyPanel:function(k){return _.template(j,k,{variable:"history"})}};return{ReadOnlyHistoryPanel:i}});