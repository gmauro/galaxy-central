define(["mvc/dataset/states","mvc/dataset/hda-model","mvc/dataset/hda-base","mvc/dataset/hda-edit","mvc/dataset/dataset-list-element","mvc/dataset/editable-dataset-list-element","mvc/collection/dataset-collection-base","mvc/collection/dataset-collection-edit","mvc/collection/hdca-base","mvc/collection/hdca-edit","mvc/history/history-contents","mvc/history/readonly-history-panel","mvc/tags","mvc/annotations","utils/localization"],function(p,h,j,g,m,f,e,q,a,k,l,c,o,b,d){var n=c.ReadOnlyHistoryPanel;var i=n.extend({HDAViewClass:g.HDAEditView,HDCAViewClass:k.HDCAEditView,initialize:function(r){r=r||{};this.selectedHdaIds=[];this.lastSelectedViewId=null;this.tagsEditor=null;this.annotationEditor=null;this.purgeAllowed=r.purgeAllowed||false;this.selecting=r.selecting||false;this.annotationEditorShown=r.annotationEditorShown||false;this.tagsEditorShown=r.tagsEditorShown||false;n.prototype.initialize.call(this,r)},_setUpModelEventHandlers:function(){n.prototype._setUpModelEventHandlers.call(this);this.model.on("change:nice_size",this.updateHistoryDiskSize,this);this.model.contents.on("change:deleted",this._handleHdaDeletionChange,this);this.model.contents.on("change:visible",this._handleHdaVisibleChange,this);this.model.contents.on("change:purged",function(r){this.model.fetch()},this)},renderModel:function(){var r=$("<div/>");r.append(i.templates.historyPanel(this.model.toJSON()));this.$emptyMessage(r).text(this.emptyMsg);if(Galaxy&&Galaxy.currUser&&Galaxy.currUser.id&&Galaxy.currUser.id===this.model.get("user_id")){this._renderTags(r);this._renderAnnotation(r)}r.find(".history-secondary-actions").prepend(this._renderSelectButton());r.find(".history-dataset-actions").toggle(this.selecting);r.find(".history-secondary-actions").prepend(this._renderSearchButton());this._setUpBehaviours(r);this.renderHdas(r);return r},_renderTags:function(r){var s=this;this.tagsEditor=new o.TagsEditor({model:this.model,el:r.find(".history-controls .tags-display"),onshowFirstTime:function(){this.render()},onshow:function(){s.toggleHDATagEditors(true,s.fxSpeed)},onhide:function(){s.toggleHDATagEditors(false,s.fxSpeed)},$activator:faIconButton({title:d("Edit history tags"),classes:"history-tag-btn",faIcon:"fa-tags"}).appendTo(r.find(".history-secondary-actions"))})},_renderAnnotation:function(r){var s=this;this.annotationEditor=new b.AnnotationEditor({model:this.model,el:r.find(".history-controls .annotation-display"),onshowFirstTime:function(){this.render()},onshow:function(){s.toggleHDAAnnotationEditors(true,s.fxSpeed)},onhide:function(){s.toggleHDAAnnotationEditors(false,s.fxSpeed)},$activator:faIconButton({title:d("Edit history annotation"),classes:"history-annotate-btn",faIcon:"fa-comment"}).appendTo(r.find(".history-secondary-actions"))})},_renderSelectButton:function(r){return faIconButton({title:d("Operations on multiple datasets"),classes:"history-select-btn",faIcon:"fa-check-square-o"})},_setUpBehaviours:function(r){r=r||this.$el;n.prototype._setUpBehaviours.call(this,r);if(!this.model){return}this._setUpDatasetActionsPopup(r);if((!Galaxy.currUser||Galaxy.currUser.isAnonymous())||(Galaxy.currUser.id!==this.model.get("user_id"))){return}var s=this;r.find(".history-name").attr("title",d("Click to rename history")).tooltip({placement:"bottom"}).make_text_editable({on_finish:function(t){var u=s.model.get("name");if(t&&t!==u){s.$el.find(".history-name").text(t);s.model.save({name:t}).fail(function(){s.$el.find(".history-name").text(s.model.previous("name"))})}else{s.$el.find(".history-name").text(u)}}})},_setUpDatasetActionsPopup:function(r){var s=this,t=[{html:d("Hide datasets"),func:function(){var u=h.HistoryDatasetAssociation.prototype.hide;s.getSelectedHdaCollection().ajaxQueue(u)}},{html:d("Unhide datasets"),func:function(){var u=h.HistoryDatasetAssociation.prototype.unhide;s.getSelectedHdaCollection().ajaxQueue(u)}},{html:d("Delete datasets"),func:function(){var u=h.HistoryDatasetAssociation.prototype["delete"];s.getSelectedHdaCollection().ajaxQueue(u)}},{html:d("Undelete datasets"),func:function(){var u=h.HistoryDatasetAssociation.prototype.undelete;s.getSelectedHdaCollection().ajaxQueue(u)}}];if(s.purgeAllowed){t.push({html:d("Permanently delete datasets"),func:function(){if(confirm(d("This will permanently remove the data in your datasets. Are you sure?"))){var u=h.HistoryDatasetAssociation.prototype.purge;s.getSelectedHdaCollection().ajaxQueue(u)}}})}t.push({html:d("Build Dataset List (Experimental)"),func:function(){s.getSelectedHdaCollection().promoteToHistoryDatasetCollection(s.model,"list")}});t.push({html:d("Build Dataset Pair (Experimental)"),func:function(){s.getSelectedHdaCollection().promoteToHistoryDatasetCollection(s.model,"paired")}});t.push({html:d("Build List of Dataset Pairs (Experimental)"),func:_.bind(s._showPairedCollectionModal,s)});return new PopupMenu(r.find(".history-dataset-action-popup-btn"),t)},_showPairedCollectionModal:function(){var r=this,s=r.getSelectedHdaCollection().toJSON().filter(function(t){return t.history_content_type==="dataset"&&t.state===p.OK});if(s.length){require(["mvc/collection/paired-collection-creator"],function(t){window.creator=t.pairedCollectionCreatorModal(s,{historyId:r.model.id})})}else{}},_handleHdaDeletionChange:function(r){if(r.get("deleted")&&!this.storage.get("show_deleted")){this.removeHdaView(this.hdaViews[r.id])}},_handleHdaVisibleChange:function(r){if(r.hidden()&&!this.storage.get("show_hidden")){this.removeHdaView(this.hdaViews[r.id])}},_getContentOptions:function(s){var r=n.prototype._getContentOptions.call(this,s);_.extend(r,{selectable:this.selecting,purgeAllowed:this.purgeAllowed,tagsEditorShown:(this.tagsEditor&&!this.tagsEditor.hidden),annotationEditorShown:(this.annotationEditor&&!this.annotationEditor.hidden)});return r},_setUpHdaListeners:function(s){var r=this;n.prototype._setUpHdaListeners.call(this,s);s.on("selected",function(v,u){if(!u){return}var t=[];if((u.shiftKey)&&(r.lastSelectedViewId&&_.has(r.hdaViews,r.lastSelectedViewId))){var x=r.hdaViews[r.lastSelectedViewId];t=r.selectDatasetRange(v,x).map(function(y){return y.model.id})}else{var w=v.model.id;r.lastSelectedViewId=w;t=[w]}r.selectedHdaIds=_.union(r.selectedHdaIds,t)});s.on("de-selected",function(u,t){var v=u.model.id;r.selectedHdaIds=_.without(r.selectedHdaIds,v)})},toggleHDATagEditors:function(r){var s=arguments;_.each(this.hdaViews,function(t){if(t.tagsEditor){t.tagsEditor.toggle.apply(t.tagsEditor,s)}})},toggleHDAAnnotationEditors:function(r){var s=arguments;_.each(this.hdaViews,function(t){if(t.annotationEditor){t.annotationEditor.toggle.apply(t.annotationEditor,s)}})},removeHdaView:function(s){if(!s){return}var r=this;s.$el.fadeOut(r.fxSpeed,function(){s.off();s.remove();delete r.hdaViews[s.model.id];if(_.isEmpty(r.hdaViews)){r.trigger("empty-history",r);r._renderEmptyMsg()}})},events:_.extend(_.clone(n.prototype.events),{"click .history-select-btn":"toggleSelectors","click .history-select-all-datasets-btn":"selectAllDatasets","click .history-deselect-all-datasets-btn":"deselectAllDatasets"}),updateHistoryDiskSize:function(){this.$el.find(".history-size").text(this.model.get("nice_size"))},showSelectors:function(r){r=(r!==undefined)?(r):(this.fxSpeed);this.selecting=true;this.$(".history-dataset-actions").slideDown(r);_.each(this.hdaViews,function(s){s.showSelector()});this.selectedHdaIds=[];this.lastSelectedViewId=null},hideSelectors:function(r){r=(r!==undefined)?(r):(this.fxSpeed);this.selecting=false;this.$(".history-dataset-actions").slideUp(r);_.each(this.hdaViews,function(s){s.hideSelector()});this.selectedHdaIds=[];this.lastSelectedViewId=null},toggleSelectors:function(){if(!this.selecting){this.showSelectors()}else{this.hideSelectors()}},selectAllDatasets:function(r){_.each(this.hdaViews,function(s){s.select(r)})},deselectAllDatasets:function(r){this.lastSelectedViewId=null;_.each(this.hdaViews,function(s){s.deselect(r)})},selectDatasetRange:function(t,s){var r=this.hdaViewRange(t,s);_.each(r,function(u){u.select()});return r},getSelectedHdaViews:function(){return _.filter(this.hdaViews,function(r){return r.selected})},getSelectedHdaCollection:function(){return new l.HistoryContents(_.map(this.getSelectedHdaViews(),function(r){return r.model}),{historyId:this.model.id})},toString:function(){return"HistoryPanel("+((this.model)?(this.model.get("name")):(""))+")"}});return{HistoryPanel:i}});