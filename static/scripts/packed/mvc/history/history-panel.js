define(["mvc/dataset/hda-model","mvc/dataset/hda-edit","mvc/collection/dataset-collection-edit","mvc/history/history-contents","mvc/history/readonly-history-panel","mvc/tags","mvc/annotations","utils/localization"],function(f,h,b,g,c,d,i,a){var e=c.ReadOnlyHistoryPanel.extend({HDAViewClass:h.HDAEditView,initialize:function(j){j=j||{};this.selectedHdaIds=[];this.lastSelectedViewId=null;this.tagsEditor=null;this.annotationEditor=null;this.purgeAllowed=j.purgeAllowed||false;this.selecting=j.selecting||false;this.annotationEditorShown=j.annotationEditorShown||false;this.tagsEditorShown=j.tagsEditorShown||false;c.ReadOnlyHistoryPanel.prototype.initialize.call(this,j)},_setUpModelEventHandlers:function(){c.ReadOnlyHistoryPanel.prototype._setUpModelEventHandlers.call(this);this.model.on("change:nice_size",this.updateHistoryDiskSize,this);this.model.hdas.on("change:deleted",this._handleHdaDeletionChange,this);this.model.hdas.on("change:visible",this._handleHdaVisibleChange,this);this.model.hdas.on("change:purged",function(j){this.model.fetch()},this)},renderModel:function(){var j=$("<div/>");j.append(e.templates.historyPanel(this.model.toJSON()));this.$emptyMessage(j).text(this.emptyMsg);if(Galaxy&&Galaxy.currUser&&Galaxy.currUser.id&&Galaxy.currUser.id===this.model.get("user_id")){this._renderTags(j);this._renderAnnotation(j)}j.find(".history-secondary-actions").prepend(this._renderSelectButton());j.find(".history-dataset-actions").toggle(this.selecting);j.find(".history-secondary-actions").prepend(this._renderSearchButton());this._setUpBehaviours(j);this.renderHdas(j);return j},_renderTags:function(j){var k=this;this.tagsEditor=new d.TagsEditor({model:this.model,el:j.find(".history-controls .tags-display"),onshowFirstTime:function(){this.render()},onshow:function(){k.toggleHDATagEditors(true,k.fxSpeed)},onhide:function(){k.toggleHDATagEditors(false,k.fxSpeed)},$activator:faIconButton({title:a("Edit history tags"),classes:"history-tag-btn",faIcon:"fa-tags"}).appendTo(j.find(".history-secondary-actions"))})},_renderAnnotation:function(j){var k=this;this.annotationEditor=new i.AnnotationEditor({model:this.model,el:j.find(".history-controls .annotation-display"),onshowFirstTime:function(){this.render()},onshow:function(){k.toggleHDAAnnotationEditors(true,k.fxSpeed)},onhide:function(){k.toggleHDAAnnotationEditors(false,k.fxSpeed)},$activator:faIconButton({title:a("Edit history annotation"),classes:"history-annotate-btn",faIcon:"fa-comment"}).appendTo(j.find(".history-secondary-actions"))})},_renderSelectButton:function(j){return faIconButton({title:a("Operations on multiple datasets"),classes:"history-select-btn",faIcon:"fa-check-square-o"})},_setUpBehaviours:function(j){j=j||this.$el;c.ReadOnlyHistoryPanel.prototype._setUpBehaviours.call(this,j);if(!this.model){return}this._setUpDatasetActionsPopup(j);if((!Galaxy.currUser||Galaxy.currUser.isAnonymous())||(Galaxy.currUser.id!==this.model.get("user_id"))){return}var k=this;j.find(".history-name").attr("title",a("Click to rename history")).tooltip({placement:"bottom"}).make_text_editable({on_finish:function(l){var m=k.model.get("name");if(l&&l!==m){k.$el.find(".history-name").text(l);k.model.save({name:l}).fail(function(){k.$el.find(".history-name").text(k.model.previous("name"))})}else{k.$el.find(".history-name").text(m)}}})},_setUpDatasetActionsPopup:function(j){var k=this,l=[{html:a("Hide datasets"),func:function(){var m=f.HistoryDatasetAssociation.prototype.hide;k.getSelectedHdaCollection().ajaxQueue(m)}},{html:a("Unhide datasets"),func:function(){var m=f.HistoryDatasetAssociation.prototype.unhide;k.getSelectedHdaCollection().ajaxQueue(m)}},{html:a("Delete datasets"),func:function(){var m=f.HistoryDatasetAssociation.prototype["delete"];k.getSelectedHdaCollection().ajaxQueue(m)}},{html:a("Undelete datasets"),func:function(){var m=f.HistoryDatasetAssociation.prototype.undelete;k.getSelectedHdaCollection().ajaxQueue(m)}}];if(k.purgeAllowed){l.push({html:a("Permanently delete datasets"),func:function(){if(confirm(a("This will permanently remove the data in your datasets. Are you sure?"))){var m=f.HistoryDatasetAssociation.prototype.purge;k.getSelectedHdaCollection().ajaxQueue(m)}}})}l.push({html:a("Build Dataset List (Experimental)"),func:function(){k.getSelectedHdaCollection().promoteToHistoryDatasetCollection(k.model,"list")}});l.push({html:a("Build Dataset Pair (Experimental)"),func:function(){k.getSelectedHdaCollection().promoteToHistoryDatasetCollection(k.model,"paired")}});l.push({html:a("Build List of Dataset Pairs (Experimental)"),func:_.bind(k._showPairedCollectionModal,k)});return new PopupMenu(j.find(".history-dataset-action-popup-btn"),l)},_showPairedCollectionModal:function(){var j=this,k=j.getSelectedHdaCollection().toJSON().filter(function(l){return l.history_content_type==="dataset"&&l.state===f.HistoryDatasetAssociation.STATES.OK});if(k.length){require(["mvc/collection/paired-collection-creator"],function(l){window.creator=l.pairedCollectionCreatorModal(k,{historyId:j.model.id})})}else{}},_handleHdaDeletionChange:function(j){if(j.get("deleted")&&!this.storage.get("show_deleted")){this.removeHdaView(this.hdaViews[j.id])}},_handleHdaVisibleChange:function(j){if(j.hidden()&&!this.storage.get("show_hidden")){this.removeHdaView(this.hdaViews[j.id])}},_createContentView:function(k){var j=k.id,m=k.get("history_content_type"),l=null;if(m==="dataset"){l=new this.HDAViewClass({model:k,linkTarget:this.linkTarget,expanded:this.storage.get("expandedHdas")[j],selectable:this.selecting,purgeAllowed:this.purgeAllowed,hasUser:this.model.ownedByCurrUser(),logger:this.logger,tagsEditorShown:(this.tagsEditor&&!this.tagsEditor.hidden),annotationEditorShown:(this.annotationEditor&&!this.annotationEditor.hidden)})}else{if(m==="dataset_collection"){l=new b.DatasetCollectionEditView({model:k,linkTarget:this.linkTarget,expanded:this.storage.get("expandedHdas")[j],hasUser:this.model.ownedByCurrUser(),logger:this.logger})}}this._setUpHdaListeners(l);return l},_setUpHdaListeners:function(k){var j=this;c.ReadOnlyHistoryPanel.prototype._setUpHdaListeners.call(this,k);k.on("selected",function(n,m){if(!m){return}var l=[];if((m.shiftKey)&&(j.lastSelectedViewId&&_.has(j.hdaViews,j.lastSelectedViewId))){var p=j.hdaViews[j.lastSelectedViewId];l=j.selectDatasetRange(n,p).map(function(q){return q.model.id})}else{var o=n.model.id;j.lastSelectedViewId=o;l=[o]}j.selectedHdaIds=_.union(j.selectedHdaIds,l)});k.on("de-selected",function(m,l){var n=m.model.id;j.selectedHdaIds=_.without(j.selectedHdaIds,n)})},toggleHDATagEditors:function(j){var k=arguments;_.each(this.hdaViews,function(l){if(l.tagsEditor){l.tagsEditor.toggle.apply(l.tagsEditor,k)}})},toggleHDAAnnotationEditors:function(j){var k=arguments;_.each(this.hdaViews,function(l){if(l.annotationEditor){l.annotationEditor.toggle.apply(l.annotationEditor,k)}})},removeHdaView:function(k){if(!k){return}var j=this;k.$el.fadeOut(j.fxSpeed,function(){k.off();k.remove();delete j.hdaViews[k.model.id];if(_.isEmpty(j.hdaViews)){j.trigger("empty-history",j);j._renderEmptyMsg()}})},events:_.extend(_.clone(c.ReadOnlyHistoryPanel.prototype.events),{"click .history-select-btn":"toggleSelectors","click .history-select-all-datasets-btn":"selectAllDatasets","click .history-deselect-all-datasets-btn":"deselectAllDatasets"}),updateHistoryDiskSize:function(){this.$el.find(".history-size").text(this.model.get("nice_size"))},showSelectors:function(j){j=(j!==undefined)?(j):(this.fxSpeed);this.selecting=true;this.$(".history-dataset-actions").slideDown(j);_.each(this.hdaViews,function(k){k.showSelector()});this.selectedHdaIds=[];this.lastSelectedViewId=null},hideSelectors:function(j){j=(j!==undefined)?(j):(this.fxSpeed);this.selecting=false;this.$(".history-dataset-actions").slideUp(j);_.each(this.hdaViews,function(k){k.hideSelector()});this.selectedHdaIds=[];this.lastSelectedViewId=null},toggleSelectors:function(){if(!this.selecting){this.showSelectors()}else{this.hideSelectors()}},selectAllDatasets:function(j){_.each(this.hdaViews,function(k){k.select(j)})},deselectAllDatasets:function(j){this.lastSelectedViewId=null;_.each(this.hdaViews,function(k){k.deselect(j)})},selectDatasetRange:function(l,k){var j=this.hdaViewRange(l,k);_.each(j,function(m){m.select()});return j},getSelectedHdaViews:function(){return _.filter(this.hdaViews,function(j){return j.selected})},getSelectedHdaCollection:function(){return new g.HistoryContents(_.map(this.getSelectedHdaViews(),function(j){return j.model}),{historyId:this.model.id})},toString:function(){return"HistoryPanel("+((this.model)?(this.model.get("name")):(""))+")"}});return{HistoryPanel:e}});