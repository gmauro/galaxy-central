define(["mvc/history/job-dag","mvc/job/job-model","mvc/job/job-li","mvc/history/history-content-model","mvc/dataset/dataset-li","mvc/base-mvc","utils/localization","libs/d3"],function(c,e,f,j,g,i,a){window.JobDAG=c;var b=Backbone.View.extend(i.LoggableMixin).extend({className:"history-structure-component",_INITIAL_ZOOM_LEVEL:1,_MIN_ZOOM_LEVEL:0.25,_LINK_ID_SEP:"-to-",_VERTEX_NAME_DATA_KEY:"vertex-name",JobItemClass:f.JobListItemView,ContentItemClass:g.DatasetListItemView,initialize:function(k){this.log(this+"(HistoryStructureComponent).initialize:",k);this.component=k.component;this._liMap={};this._createVertexItems();this.zoomLevel=k.zoomLevel||this._INITIAL_ZOOM_LEVEL;this.layout=this._createLayout(k.layoutOptions)},_createVertexItems:function(){var k=this;k.component.eachVertex(function(n){var m=n.data.job?"job":"copy",l;if(m==="job"){l=k._createJobListItem(n)}else{if(m==="copy"){l=k._createContentListItem(n)}}k._liMap[n.name]=l});k.debug("_liMap:",k._liMap)},_createJobListItem:function(p){this.debug("_createJobListItem:",p);var m=this,n=p.data,o=new e.Job(n.job);var l=_.map(o.get("outputs"),function(q){var s=q.src==="hda"?"dataset":"dataset_collection",r=j.typeIdStr(s,q.id);return m.model.contents.get(r)});o.outputCollection.reset(l);o.outputCollection.historyId=m.model.id;var k=new m.JobItemClass({model:o,tool:n.tool,jobData:n});k.on("expanding expanded collapsing collapsed",m.renderGraph,m);k.foldout.on("view:expanding view:expanded view:collapsing view:collapsed",m.renderGraph,m);return k},_createContentListItem:function(o){this.debug("_createContentListItem:",o);var l=this,n=o.data,m=j.typeIdStr(n.history_content_type,n.id);n=l.model.contents.get(m);var k=new l.ContentItemClass({model:n});k.on("expanding expanded collapsing collapsed",l.renderGraph,l);return k},layoutDefaults:{linkSpacing:16,linkWidth:0,linkHeight:0,jobWidth:300,jobHeight:300,jobSpacing:12,linkAdjX:4,linkAdjY:0},_createLayout:function(m){m=_.defaults(_.clone(m||{}),this.layoutDefaults);var k=this,l=_.values(k.component.vertices),n=_.extend(m,{nodeMap:{},links:[],svg:{width:0,height:0}});l.forEach(function(o,p){var q={name:o.name,x:0,y:0};n.nodeMap[o.name]=q});k.component.edges(function(p){var o={source:p.source,target:p.target};n.links.push(o)});return n},render:function(l){this.debug(this+".render:",l);var k=this;k.$el.html(["<header></header>",'<nav class="controls"></nav>','<figure class="graph"></figure>',"<footer></footer>"].join(""));var m=k.$graph();k.component.eachVertex(function(n){k._liMap[n.name].render(0).$el.appendTo(m).data(k._VERTEX_NAME_DATA_KEY,n.name)});k.renderGraph();return this},$graph:function(){return this.$(".graph")},renderGraph:function(l){this.debug(this+".renderGraph:",l);var k=this;function m(){k._updateLayout();k.$graph().css("transform",["scale(",k.zoomLevel,",",k.zoomLevel,")"].join("")).width(k.layout.svg.width).height(k.layout.svg.height);k.renderSVG();k.component.eachVertex(function(p){var o=k._liMap[p.name],n=k.layout.nodeMap[p.name];o.$el.css({top:n.y,left:n.x})})}if(!this.$el.is(":visible")){_.delay(m,0)}else{m()}return this},_updateLayout:function(){this.debug(this+"._updateLayout:");var l=this,m=l.layout;m.linkHeight=m.linkSpacing*_.size(m.nodeMap);m.svg.height=m.linkHeight+m.jobHeight;m.svg.width=0;var k=0,n=m.linkHeight;_.each(m.nodeMap,function(p,o){p.x=k;p.y=n;k+=m.jobWidth+m.jobSpacing});m.svg.width=m.linkWidth=Math.max(m.svg.width,k);m.links.forEach(function(o){var p=m.nodeMap[o.source],q=m.nodeMap[o.target];o.x1=p.x+m.linkAdjX;o.y1=p.y+m.linkAdjY;o.x2=q.x+m.linkAdjX;o.y2=q.y+m.linkAdjY});this.debug(JSON.stringify(m,null,"  "));return this.layout},renderSVG:function(){this.debug(this+".renderSVG:");var k=this,p=k.layout;var l=d3.select(this.$graph().get(0)).select("svg");if(l.empty()){l=d3.select(this.$graph().get(0)).append("svg")}l.attr("width",p.svg.width).attr("height",p.svg.height);function n(q){d3.select(this).classed("highlighted",true);k._liMap[q.source].$el.addClass("highlighted");k._liMap[q.target].$el.addClass("highlighted")}function m(q){d3.select(this).classed("highlighted",false);k._liMap[q.source].$el.removeClass("highlighted");k._liMap[q.target].$el.removeClass("highlighted")}var o=l.selectAll(".connection").data(p.links);o.enter().append("path").attr("class","connection").attr("id",function(q){return[q.source,q.target].join(k._LINK_ID_SEP)}).on("mouseover",n).on("mouseout",m);o.attr("d",function(q){return k._connectionPath(q)});return l.node()},_connectionPath:function(l){var m=0,k=((l.x2-l.x1)/this.layout.svg.width)*this.layout.linkHeight;return["M",l.x1,",",l.y1," ","C",l.x1+m,",",l.y1-k," ",l.x2-m,",",l.y2-k," ",l.x2,",",l.y2].join("")},events:{"mouseover .graph > .list-item":function(k){this.highlightConnected(k.currentTarget,true)},"mouseout  .graph > .list-item":function(k){this.highlightConnected(k.currentTarget,false)}},highlightConnected:function(q,m){this.debug("highlightConnected",q,m);m=m!==undefined?m:true;var k=this,n=k.component,p=m?jQuery.prototype.addClass:jQuery.prototype.removeClass,o=m?"connection highlighted":"connection";var l=p.call($(q),"highlighted"),r=l.data(k._VERTEX_NAME_DATA_KEY);n.edges({target:r}).forEach(function(u){var s=u.source,t=k._liMap[s];p.call(t.$el,"highlighted");k.$("#"+s+k._LINK_ID_SEP+r).attr("class",o)});n.vertices[r].eachEdge(function(u){var s=u.target,t=k._liMap[s];p.call(t.$el,"highlighted");k.$("#"+r+k._LINK_ID_SEP+s).attr("class",o)})},zoom:function(k){this.zoomLevel=Math.min(1,Math.max(this._MIN_ZOOM_LEVEL,k));return this.renderGraph()},toString:function(){return"HistoryStructureComponent("+this.model.id+")"}});var h=b.extend({className:b.prototype.className+" vertical",layoutDefaults:_.extend(_.clone(b.prototype.layoutDefaults),{linkAdjX:0,linkAdjY:4}),_updateLayout:function(){this.debug(this+"._updateLayout:");var l=this,m=l.layout;m.linkWidth=m.linkSpacing*_.size(m.nodeMap);m.svg.width=m.linkWidth+m.jobWidth;m.svg.height=0;var k=m.linkWidth,n=0;_.each(m.nodeMap,function(p,q){p.x=k;p.y=n;var o=l._liMap[q];n+=o.$el.height()+m.jobSpacing});m.linkHeight=m.svg.height=Math.max(m.svg.height,n);m.links.forEach(function(o){var p=m.nodeMap[o.source],q=m.nodeMap[o.target];o.x1=p.x+m.linkAdjX;o.y1=p.y+m.linkAdjY;o.x2=q.x+m.linkAdjX;o.y2=q.y+m.linkAdjY});this.debug(JSON.stringify(m,null,"  "));return m},_connectionPath:function(m){var l=0,k=((m.y2-m.y1)/this.layout.svg.height)*this.layout.linkWidth;return["M",m.x1,",",m.y1," ","C",m.x1-k,",",m.y1+l," ",m.x2-k,",",m.y2-l," ",m.x2,",",m.y2].join("")},toString:function(){return"VerticalHistoryStructureComponent("+this.model.id+")"}});var d=Backbone.View.extend(i.LoggableMixin).extend({className:"history-structure",_layoutToComponentClass:{horizontal:b,vertical:h},_DEFAULT_LAYOUT:"vertical",initialize:function(k){this.layout=_.contains(k.layout,_.keys(this._layoutToComponentClass))?k.layout:this._DEFAULT_LAYOUT;this.log(this+"(HistoryStructureView).initialize:",k,this.model);this._processTools(k.tools);this._processJobs(k.jobs);this._createDAG()},_processTools:function(k){this.tools=k||{};return this.tools},_processJobs:function(k){this.jobs=k||[];return this.jobs},_createDAG:function(){this.dag=new c({historyContents:this.model.contents.toJSON(),tools:this.tools,jobs:this.jobs,excludeSetMetadata:true,excludeErroredJobs:true});this.debug(this+".dag:",this.dag);this._createComponents()},_createComponents:function(){this.log(this+"._createComponents");var k=this;k.componentViews=k.dag.weakComponentGraphArray().map(function(l){return k._createComponent(l)});return k.componentViews},_createComponent:function(k){this.log(this+"._createComponent:",k);var l=this._layoutToComponentClass[this.layout];return new l({model:this.model,component:k})},render:function(l){this.log(this+".render:",l);var k=this;k.$el.addClass("clear").html(['<div class="controls"></div>','<div class="components"></div>'].join(""));k.componentViews.forEach(function(m){m.render().$el.appendTo(k.$components())});return k},$components:function(){return this.$(".components")},changeLayout:function(k){if(!(k in this._layoutToComponentClass)){throw new Error(this+": unknown layout: "+k)}this.layout=k;this._createComponents();return this.render()},toString:function(){return"HistoryStructureView("+this.model.id+")"}});return d});