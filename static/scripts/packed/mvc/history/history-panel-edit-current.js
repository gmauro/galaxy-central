define(["mvc/history/history-panel-edit","mvc/collection/collection-panel","mvc/base-mvc","utils/localization"],function(g,f,b,d){var c=b.SessionStorageModel.extend({defaults:{searching:false,tagsEditorShown:false,annotationEditorShown:false},toString:function(){return"HistoryPanelPrefs("+JSON.stringify(this.toJSON())+")"}});c.storageKey=function h(){return("history-panel")};var e=g.HistoryPanel;var a=e.extend({emptyMsg:d("This history is empty. Click 'Get Data' on the left tool menu to start"),noneFoundMsg:d("No matching datasets found"),initialize:function(i){i=i||{};this.preferences=new c(_.extend({id:c.storageKey()},_.pick(i,_.keys(c.prototype.defaults))));e.prototype.initialize.call(this,i);this.panelStack=[]},loadCurrentHistory:function(j){var i=this;return this.loadHistoryWithHDADetails("current",j).then(function(l,k){i.trigger("current-history",i)})},switchToHistory:function(l,k){var i=this,j=function(){return jQuery.ajax({url:galaxy_config.root+"api/histories/"+l+"/set_as_current",method:"PUT"})};return this.loadHistoryWithHDADetails(l,k,j).then(function(n,m){i.trigger("switched-history",i)})},createNewHistory:function(k){if(!Galaxy||!Galaxy.currUser||Galaxy.currUser.isAnonymous()){this.displayMessage("error",d("You must be logged in to create histories"));return $.when()}var i=this,j=function(){return jQuery.post(galaxy_config.root+"api/histories",{current:true})};return this.loadHistory(undefined,k,j).then(function(m,l){i.trigger("new-history",i)})},setModel:function(j,i,k){e.prototype.setModel.call(this,j,i,k);if(this.model){this.log("checking for updates");this.model.checkForUpdates()}return this},_setUpModelEventHandlers:function(){e.prototype._setUpModelEventHandlers.call(this);if(Galaxy&&Galaxy.quotaMeter){this.listenTo(this.model,"change:nice_size",function(){Galaxy.quotaMeter.update()})}this.model.contents.on("state:ready",function(j,k,i){if((!j.get("visible"))&&(!this.storage.get("show_hidden"))){this.removeHdaView(this.hdaViews[j.id])}},this)},render:function(k,l){this.log("render:",k,l);k=(k===undefined)?(this.fxSpeed):(k);var i=this,j;if(this.model){j=this.renderModel()}else{j=this.renderWithoutModel()}$(i).queue("fx",[function(m){if(k&&i.$el.is(":visible")){i.$el.fadeOut(k,m)}else{m()}},function(m){i.$el.empty();if(j){i.$el.append(j.children());i.renderBasedOnPrefs()}m()},function(m){if(k&&!i.$el.is(":visible")){i.$el.fadeIn(k,m)}else{m()}},function(m){if(l){l.call(this)}i.trigger("rendered",this);m()}]);return this},renderBasedOnPrefs:function(){if(this.preferences.get("searching")){this.toggleSearchControls(0,true)}},_renderEmptyMsg:function(k){var j=this,i=j.$emptyMessage(k),l=$(".toolMenuContainer");if((_.isEmpty(j.hdaViews)&&!j.searchFor)&&(Galaxy&&Galaxy.upload&&l.size())){i.empty();i.html([d("This history is empty"),". ",d("You can "),'<a class="uploader-link" href="javascript:void(0)">',d("load your own data"),"</a>",d(" or "),'<a class="get-data-link" href="javascript:void(0)">',d("get data from an external source"),"</a>"].join(""));i.find(".uploader-link").click(function(m){Galaxy.upload._eventShow(m)});i.find(".get-data-link").click(function(m){l.parent().scrollTop(0);l.find('span:contains("Get Data")').click()});i.show()}else{e.prototype._renderEmptyMsg.call(this,k)}return this},toggleSearchControls:function(j,i){var k=e.prototype.toggleSearchControls.call(this,j,i);this.preferences.set("searching",k)},_renderTags:function(i){var j=this;e.prototype._renderTags.call(this,i);if(this.preferences.get("tagsEditorShown")){this.tagsEditor.toggle(true)}this.tagsEditor.on("hiddenUntilActivated:shown hiddenUntilActivated:hidden",function(k){j.preferences.set("tagsEditorShown",k.hidden)})},_renderAnnotation:function(i){var j=this;e.prototype._renderAnnotation.call(this,i);if(this.preferences.get("annotationEditorShown")){this.annotationEditor.toggle(true)}this.annotationEditor.on("hiddenUntilActivated:shown hiddenUntilActivated:hidden",function(k){j.preferences.set("annotationEditorShown",k.hidden)})},_setUpHdaListeners:function(j){e.prototype._setUpHdaListeners.call(this,j);var i=this;if(j instanceof i.HDCAViewClass){j.off("expanded");j.on("expanded",function(k){this.info("expanded",k);i._addCollectionPanel(k)});j.off("collapsed")}},_addCollectionPanel:function(k){var l=this,i=k.model;this.debug("history panel (stack), collectionModel:",i);var j=new (this._getCollectionPanelClass(i))({model:i,HDAViewClass:this.HDAViewClass,parentName:this.model.get("name"),linkTarget:this.linkTarget});l.panelStack.push(j);l.$(".history-controls").add(".datasets-list").hide();l.$el.append(j.$el);j.on("close",function(){l.render();k.collapse();l.panelStack.pop()});if(!j.model.hasDetails()){var m=j.model.fetch();m.done(function(){j.render()})}else{j.render()}},_getCollectionPanelClass:function(i){switch(i.get("collection_type")){case"list":return f.ListCollectionPanel;case"paired":return f.PairCollectionPanel;case"list:paired":return f.ListOfPairsCollectionPanel}throw new TypeError("Uknown collection_type: "+i.get("collection_type"))},addContentView:function(i){if(this.panelStack.length){return this}return e.prototype.addContentView.call(this,i)},connectToQuotaMeter:function(i){if(!i){return this}this.listenTo(i,"quota:over",this.showQuotaMessage);this.listenTo(i,"quota:under",this.hideQuotaMessage);this.on("rendered rendered:initial",function(){if(i&&i.isOverQuota()){this.showQuotaMessage()}});return this},showQuotaMessage:function(){var i=this.$el.find(".quota-message");if(i.is(":hidden")){i.slideDown(this.fxSpeed)}},hideQuotaMessage:function(){var i=this.$el.find(".quota-message");if(!i.is(":hidden")){i.slideUp(this.fxSpeed)}},connectToOptionsMenu:function(i){if(!i){return this}this.on("new-storage",function(k,j){if(i&&k){i.findItemByHtml(d("Include Deleted Datasets")).checked=k.get("show_deleted");i.findItemByHtml(d("Include Hidden Datasets")).checked=k.get("show_hidden")}});return this},toString:function(){return"CurrentHistoryPanel("+((this.model)?(this.model.get("name")):(""))+")"}});return{CurrentHistoryPanel:a}});