(function(b){var h,g,c;if(typeof window==="undefined"){h=require("underscore");g=require("backbone");c=module.exports=g}else{h=window._;g=window.Backbone;c=window}g.Relational={showWarnings:true};g.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable){throw new Error("Max permits acquired")}else{this._permitsUsed++}},release:function(){if(this._permitsUsed===0){throw new Error("All permits released")}else{this._permitsUsed--}},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(j){if(this._permitsUsed>j){throw new Error("Available permits cannot be less than used permits")}this._permitsAvailable=j}};g.BlockingQueue=function(){this._queue=[]};h.extend(g.BlockingQueue.prototype,g.Semaphore,{_queue:null,add:function(j){if(this.isBlocked()){this._queue.push(j)}else{j()}},process:function(){while(this._queue&&this._queue.length){this._queue.shift()()}},block:function(){this.acquire()},unblock:function(){this.release();if(!this.isBlocked()){this.process()}},isBlocked:function(){return this.isLocked()}});g.Relational.eventQueue=new g.BlockingQueue();g.Store=function(){this._collections=[];this._reverseRelations=[];this._orphanRelations=[];this._subModels=[];this._modelScopes=[c]};h.extend(g.Store.prototype,g.Events,{initializeRelation:function(k,m,j){var l=!h.isString(m.type)?m.type:g[m.type]||this.getObjectByName(m.type);if(l&&l.prototype instanceof g.Relation){new l(k,m,j)}else{g.Relational.showWarnings&&typeof console!=="undefined"&&console.warn("Relation=%o; missing or invalid relation type!",m)}},addModelScope:function(j){this._modelScopes.push(j)},addSubModels:function(j,k){this._subModels.push({superModelType:k,subModels:j})},setupSuperModel:function(j){h.find(this._subModels,function(k){return h.find(k.subModels||[],function(m,n){var l=this.getObjectByName(m);if(j===l){k.superModelType._subModels[n]=j;j._superModel=k.superModelType;j._subModelTypeValue=n;j._subModelTypeAttribute=k.superModelType.prototype.subModelTypeAttribute;return true}},this)},this)},addReverseRelation:function(k){var j=h.any(this._reverseRelations,function(l){return h.all(k||[],function(n,m){return n===l[m]})});if(!j&&k.model&&k.type){this._reverseRelations.push(k);this._addRelation(k.model,k);this.retroFitRelation(k)}},addOrphanRelation:function(k){var j=h.any(this._orphanRelations,function(l){return h.all(k||[],function(n,m){return n===l[m]})});if(!j&&k.model&&k.type){this._orphanRelations.push(k)}},processOrphanRelations:function(){h.each(this._orphanRelations.slice(0),function(j){var k=g.Relational.store.getObjectByName(j.relatedModel);if(k){this.initializeRelation(null,j);this._orphanRelations=h.without(this._orphanRelations,j)}},this)},_addRelation:function(j,k){if(!j.prototype.relations){j.prototype.relations=[]}j.prototype.relations.push(k);h.each(j._subModels||[],function(l){this._addRelation(l,k)},this)},retroFitRelation:function(k){var j=this.getCollection(k.model,false);j&&j.each(function(l){if(!(l instanceof k.model)){return}new k.type(l,k)},this)},getCollection:function(m,l){if(m instanceof g.RelationalModel){m=m.constructor}var j=m;while(j._superModel){j=j._superModel}var k=h.findWhere(this._collections,{model:j});if(!k&&l!==false){k=this._createCollection(j)}return k},getObjectByName:function(j){var l=j.split("."),k=null;h.find(this._modelScopes,function(m){k=h.reduce(l||[],function(n,o){return n?n[o]:b},m);if(k&&k!==m){return true}},this);return k},_createCollection:function(k){var j;if(k instanceof g.RelationalModel){k=k.constructor}if(k.prototype instanceof g.RelationalModel){j=new g.Collection();j.model=k;this._collections.push(j)}return j},resolveIdForItem:function(j,k){var l=h.isString(k)||h.isNumber(k)?k:null;if(l===null){if(k instanceof g.RelationalModel){l=k.id}else{if(h.isObject(k)){l=k[j.prototype.idAttribute]}}}if(!l&&l!==0){l=null}return l},find:function(k,l){var n=this.resolveIdForItem(k,l);var j=this.getCollection(k);if(j){var m=j.get(n);if(m instanceof k){return m}}return null},register:function(k){var l=this.getCollection(k);if(l){if(l.get(k)){if(g.Relational.showWarnings&&typeof console!=="undefined"){console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",l.get(k),k)}throw new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!")}var j=k.collection;l.add(k);this.listenTo(k,"destroy",this.unregister,this);k.collection=j}},update:function(j){var k=this.getCollection(j);k._onModelEvent("change:"+j.idAttribute,j,k)},unregister:function(j){this.stopListening(j,"destroy",this.unregister);var k=this.getCollection(j);k&&k.remove(j)},reset:function(){this.stopListening();this._collections=[];this._subModels=[];this._modelScopes=[c]}});g.Relational.store=new g.Store();g.Relation=function(j,k,l){this.instance=j;k=h.isObject(k)?k:{};this.reverseRelation=h.defaults(k.reverseRelation||{},this.options.reverseRelation);this.options=h.defaults(k,this.options,g.Relation.prototype.options);this.reverseRelation.type=!h.isString(this.reverseRelation.type)?this.reverseRelation.type:g[this.reverseRelation.type]||g.Relational.store.getObjectByName(this.reverseRelation.type);this.key=this.options.key;this.keySource=this.options.keySource||this.key;this.keyDestination=this.options.keyDestination||this.keySource||this.key;this.model=this.options.model||this.instance.constructor;this.relatedModel=this.options.relatedModel;if(h.isString(this.relatedModel)){this.relatedModel=g.Relational.store.getObjectByName(this.relatedModel)}if(!this.checkPreconditions()){return}if(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key){g.Relational.store.addReverseRelation(h.defaults({isAutoRelation:true,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation))}if(j){var m=this.keySource;if(m!==this.key&&typeof this.instance.get(this.key)==="object"){m=this.key}this.setKeyContents(this.instance.get(m));this.relatedCollection=g.Relational.store.getCollection(this.relatedModel);if(this.keySource!==this.key){this.instance.unset(this.keySource,{silent:true})}this.instance._relations[this.key]=this;this.initialize(l);if(this.options.autoFetch){this.instance.fetchRelated(this.key,h.isObject(this.options.autoFetch)?this.options.autoFetch:{})}this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)}};g.Relation.extend=g.Model.extend;h.extend(g.Relation.prototype,g.Events,g.Semaphore,{options:{createModels:true,includeInJSON:true,isAutoRelation:false,autoFetch:false,parse:false},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,checkPreconditions:function(){var n=this.instance,l=this.key,j=this.model,p=this.relatedModel,q=g.Relational.showWarnings&&typeof console!=="undefined";if(!j||!l||!p){q&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,j,l,p);return false}if(!(j.prototype instanceof g.RelationalModel)){q&&console.warn("Relation=%o: model does not inherit from Backbone.RelationalModel (%o).",this,n);return false}if(!(p.prototype instanceof g.RelationalModel)){q&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.RelationalModel (%o).",this,p);return false}if(this instanceof g.HasMany&&this.reverseRelation.type===g.HasMany){q&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this);return false}if(n&&h.keys(n._relations).length){var o=h.find(n._relations,function(k){return k.key===l},this);if(o){q&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,l,n,o);return false}}return true},setRelated:function(j){this.related=j;this.instance.acquire();this.instance.attributes[this.key]=j;this.instance.release()},_isReverseRelation:function(j){return j.instance instanceof this.relatedModel&&this.reverseRelation.key===j.key&&this.key===j.reverseRelation.key},getReverseRelations:function(j){var k=[];var l=!h.isUndefined(j)?[j]:this.related&&(this.related.models||[this.related]);h.each(l||[],function(m){h.each(m.getRelations()||[],function(n){if(this._isReverseRelation(n)){k.push(n)}},this)},this);return k},destroy:function(){this.stopListening();if(this instanceof g.HasOne){this.setRelated(null)}else{if(this instanceof g.HasMany){this.setRelated(this._prepareCollection())}}h.each(this.getReverseRelations(),function(j){j.removeRelated(this.instance)},this)}});g.HasOne=g.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(j){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var k=this.findRelated(j);this.setRelated(k);h.each(this.getReverseRelations(),function(l){l.addRelated(this.instance,j)},this)},findRelated:function(j){var l=null;j=h.defaults({parse:this.options.parse},j);if(this.keyContents instanceof this.relatedModel){l=this.keyContents}else{if(this.keyContents||this.keyContents===0){var k=h.defaults({create:this.options.createModels},j);l=this.relatedModel.findOrCreate(this.keyContents,k)}}return l},setKeyContents:function(j){this.keyContents=j;this.keyId=g.Relational.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(m,j,l){if(this.isLocked()){return}this.acquire();l=l?h.clone(l):{};var p=h.isUndefined(l.__related),n=p?this.related:l.__related;if(p){this.setKeyContents(j);var o=this.findRelated(l);this.setRelated(o)}if(n&&this.related!==n){h.each(this.getReverseRelations(n),function(q){q.removeRelated(this.instance,null,l)},this)}h.each(this.getReverseRelations(),function(q){q.addRelated(this.instance,l)},this);if(!l.silent&&this.related!==n){var k=this;this.changed=true;g.Relational.eventQueue.add(function(){k.instance.trigger("change:"+k.key,k.instance,k.related,l,true);k.changed=false})}this.release()},tryAddRelated:function(k,l,j){if((this.keyId||this.keyId===0)&&k.id===this.keyId){this.addRelated(k,j);this.keyId=null}},addRelated:function(l,k){var j=this;l.queue(function(){if(l!==j.related){var m=j.related||null;j.setRelated(l);j.onChange(j.instance,l,h.defaults({__related:m},k))}})},removeRelated:function(k,l,j){if(!this.related){return}if(k===this.related){var m=this.related||null;this.setRelated(null);this.onChange(this.instance,k,h.defaults({__related:m},j))}}});g.HasMany=g.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:g.Collection,collectionKey:true,collectionOptions:{}},initialize:function(j){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);this.collectionType=this.options.collectionType;if(h.isString(this.collectionType)){this.collectionType=g.Relational.store.getObjectByName(this.collectionType)}if(!this.collectionType.prototype instanceof g.Collection){throw new Error("`collectionType` must inherit from Backbone.Collection")}var k=this.findRelated(j);this.setRelated(k)},_prepareCollection:function(l){if(this.related){this.stopListening(this.related)}if(!l||!(l instanceof g.Collection)){var j=h.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions;l=new this.collectionType(null,j)}l.model=this.relatedModel;if(this.options.collectionKey){var k=this.options.collectionKey===true?this.options.reverseRelation.key:this.options.collectionKey;if(l[k]&&l[k]!==this.instance){if(g.Relational.showWarnings&&typeof console!=="undefined"){console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,k,this.options.collectionKey)}}else{if(k){l[k]=this.instance}}}this.listenTo(l,"relational:add",this.handleAddition).listenTo(l,"relational:remove",this.handleRemoval).listenTo(l,"relational:reset",this.handleReset);return l},findRelated:function(j){var l=null;j=h.defaults({parse:this.options.parse},j);if(this.keyContents instanceof g.Collection){this._prepareCollection(this.keyContents);l=this.keyContents}else{var k=[];h.each(this.keyContents,function(m){if(m instanceof this.relatedModel){var n=m}else{n=this.relatedModel.findOrCreate(m,h.extend({merge:true},j,{create:this.options.createModels}))}n&&k.push(n)},this);if(this.related instanceof g.Collection){l=this.related}else{l=this._prepareCollection()}l.update(k,h.defaults({merge:false,parse:false},j))}return l},setKeyContents:function(j){this.keyContents=j instanceof g.Collection?j:null;this.keyIds=[];if(!this.keyContents&&(j||j===0)){this.keyContents=h.isArray(j)?j:[j];h.each(this.keyContents,function(k){var l=g.Relational.store.resolveIdForItem(this.relatedModel,k);if(l||l===0){this.keyIds.push(l)}},this)}},onChange:function(m,j,l){l=l?h.clone(l):{};this.setKeyContents(j);this.changed=false;var n=this.findRelated(l);this.setRelated(n);if(!l.silent){var k=this;g.Relational.eventQueue.add(function(){if(k.changed){k.instance.trigger("change:"+k.key,k.instance,k.related,l,true);k.changed=false}})}},handleAddition:function(l,m,k){k=k?h.clone(k):{};this.changed=true;h.each(this.getReverseRelations(l),function(n){n.addRelated(this.instance,k)},this);var j=this;!k.silent&&g.Relational.eventQueue.add(function(){j.instance.trigger("add:"+j.key,l,j.related,k)})},handleRemoval:function(l,m,k){k=k?h.clone(k):{};this.changed=true;h.each(this.getReverseRelations(l),function(n){n.removeRelated(this.instance,null,k)},this);var j=this;!k.silent&&g.Relational.eventQueue.add(function(){j.instance.trigger("remove:"+j.key,l,j.related,k)})},handleReset:function(l,k){var j=this;k=k?h.clone(k):{};!k.silent&&g.Relational.eventQueue.add(function(){j.instance.trigger("reset:"+j.key,j.related,k)})},tryAddRelated:function(k,l,j){var m=h.contains(this.keyIds,k.id);if(m){this.addRelated(k,j);this.keyIds=h.without(this.keyIds,k.id)}},addRelated:function(l,k){var j=this;l.queue(function(){if(j.related&&!j.related.get(l)){j.related.add(l,k)}})},removeRelated:function(k,l,j){if(this.related.get(k)){this.related.remove(k,j)}}});g.RelationalModel=g.Model.extend({relations:null,_relations:null,_isInitialized:false,_deferProcessing:false,_queue:null,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(k,l){if(l&&l.collection){var j=this,n=this.collection=l.collection;delete l.collection;this._deferProcessing=true;var m=function(o){if(o===j){j._deferProcessing=false;j.processQueue();n.off("relational:add",m)}};n.on("relational:add",m);h.defer(function(){m(j)})}g.Relational.store.processOrphanRelations();this._queue=new g.BlockingQueue();this._queue.block();g.Relational.eventQueue.block();try{g.Model.apply(this,arguments)}finally{g.Relational.eventQueue.unblock()}},trigger:function(k){if(k.length>5&&k.indexOf("change")===0){var j=this,l=arguments;g.Relational.eventQueue.add(function(){if(!j._isInitialized){return}var o=true;if(k==="change"){o=j.hasChanged()}else{var n=k.slice(7),m=j.getRelation(n);if(m){o=(l[4]===true);if(o){j.changed[n]=l[2]}else{if(!m.changed){delete j.changed[n]}}}}o&&g.Model.prototype.trigger.apply(j,l)})}else{g.Model.prototype.trigger.apply(this,arguments)}return this},initializeRelations:function(j){this.acquire();this._relations={};h.each(this.relations||[],function(k){g.Relational.store.initializeRelation(this,k,j)},this);this._isInitialized=true;this.release();this.processQueue()},updateRelations:function(j){if(this._isInitialized&&!this.isLocked()){h.each(this._relations,function(k){var l=this.attributes[k.keySource]||this.attributes[k.key];if(k.related!==l){this.trigger("relational:change:"+k.key,this,l,j||{})}},this)}},queue:function(j){this._queue.add(j)},processQueue:function(){if(this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()){this._queue.unblock()}},getRelation:function(j){return this._relations[j]},getRelations:function(){return h.values(this._relations)},fetchRelated:function(q,t,o){t=h.extend({update:true,remove:false},t);var n,k=[],s=this.getRelation(q),r=s&&(s.keyIds||[s.keyId]),p=r&&h.select(r||[],function(u){return(u||u===0)&&(o||!g.Relational.store.find(s.relatedModel,u))},this);if(p&&p.length){var m=[],l=h.map(p,function(w){var v=g.Relational.store.find(s.relatedModel,w);if(!v){var u={};u[s.relatedModel.prototype.idAttribute]=w;v=s.relatedModel.findOrCreate(u,t);m.push(v)}return v},this);if(s.related instanceof g.Collection&&h.isFunction(s.related.url)){n=s.related.url(l)}if(n&&n!==s.related.url()){var j=h.defaults({error:function(){var u=arguments;h.each(m,function(v){v.trigger("destroy",v,v.collection,t);t.error&&t.error.apply(v,u)})},url:n},t);k=[s.related.fetch(j)]}else{k=h.map(l,function(u){var v=h.defaults({error:function(){if(h.contains(m,u)){u.trigger("destroy",u,u.collection,t);t.error&&t.error.apply(u,arguments)}}},t);return u.fetch(v)},this)}}return k},get:function(k){var l=g.Model.prototype.get.call(this,k);if(!this.dotNotation||k.indexOf(".")===-1){return l}var m=k.split(".");var j=h.reduce(m,function(n,o){if(!(n instanceof g.Model)){throw new Error("Attribute must be an instanceof Backbone.Model. Is: "+n+", currentSplit: "+o)}return g.Model.prototype.get.call(n,o)},this);if(l!==b&&j!==b){throw new Error("Ambiguous result for '"+k+"'. direct result: "+l+", dotNotation: "+j)}return l||j},set:function(m,n,l){g.Relational.eventQueue.block();var k;if(h.isObject(m)||m==null){k=m;l=n}else{k={};k[m]=n}var j=g.Model.prototype.set.apply(this,arguments);try{if(!this._isInitialized&&!this.isLocked()){this.constructor.initializeModelHierarchy();g.Relational.store.register(this);this.initializeRelations(l)}else{if(k&&this.idAttribute in k){g.Relational.store.update(this)}}if(k){this.updateRelations(l)}}finally{g.Relational.eventQueue.unblock()}return j},unset:function(l,k){g.Relational.eventQueue.block();var j=g.Model.prototype.unset.apply(this,arguments);this.updateRelations(k);g.Relational.eventQueue.unblock();return j},clear:function(k){g.Relational.eventQueue.block();var j=g.Model.prototype.clear.apply(this,arguments);this.updateRelations(k);g.Relational.eventQueue.unblock();return j},clone:function(){var j=h.clone(this.attributes);if(!h.isUndefined(j[this.idAttribute])){j[this.idAttribute]=null}h.each(this.getRelations(),function(k){delete j[k.key]});return new this.constructor(j)},toJSON:function(j){if(this.isLocked()){return this.id}this.acquire();var k=g.Model.prototype.toJSON.call(this,j);if(this.constructor._superModel&&!(this.constructor._subModelTypeAttribute in k)){k[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue}h.each(this._relations,function(l){var n=k[l.key];if(l.options.includeInJSON===true){if(n&&h.isFunction(n.toJSON)){k[l.keyDestination]=n.toJSON(j)}else{k[l.keyDestination]=null}}else{if(h.isString(l.options.includeInJSON)){if(n instanceof g.Collection){k[l.keyDestination]=n.pluck(l.options.includeInJSON)}else{if(n instanceof g.Model){k[l.keyDestination]=n.get(l.options.includeInJSON)}else{k[l.keyDestination]=null}}}else{if(h.isArray(l.options.includeInJSON)){if(n instanceof g.Collection){var m=[];n.each(function(p){var o={};h.each(l.options.includeInJSON,function(q){o[q]=p.get(q)});m.push(o)});k[l.keyDestination]=m}else{if(n instanceof g.Model){var m={};h.each(l.options.includeInJSON,function(o){m[o]=n.get(o)});k[l.keyDestination]=m}else{k[l.keyDestination]=null}}}else{delete k[l.key]}}}if(l.keyDestination!==l.key){delete k[l.key]}});this.release();return k}},{setup:function(j){this.prototype.relations=(this.prototype.relations||[]).slice(0);this._subModels={};this._superModel=null;if(this.prototype.hasOwnProperty("subModelTypes")){g.Relational.store.addSubModels(this.prototype.subModelTypes,this)}else{this.prototype.subModelTypes=null}h.each(this.prototype.relations||[],function(k){if(!k.model){k.model=this}if(k.reverseRelation&&k.model===this){var m=true;if(h.isString(k.relatedModel)){var l=g.Relational.store.getObjectByName(k.relatedModel);m=l&&(l.prototype instanceof g.RelationalModel)}if(m){g.Relational.store.initializeRelation(null,k)}else{if(h.isString(k.relatedModel)){g.Relational.store.addOrphanRelation(k)}}}},this);return this},build:function(l,n){var m=this;this.initializeModelHierarchy();if(this._subModels&&this.prototype.subModelTypeAttribute in l){var k=l[this.prototype.subModelTypeAttribute];var j=this._subModels[k];if(j){m=j}}return new m(l,n)},initializeModelHierarchy:function(){if(h.isUndefined(this._superModel)||h.isNull(this._superModel)){g.Relational.store.setupSuperModel(this);if(this._superModel){if(this._superModel.prototype.relations){var j=h.any(this.prototype.relations||[],function(k){return k.model&&k.model!==this},this);if(!j){this.prototype.relations=this._superModel.prototype.relations.concat(this.prototype.relations)}}}else{this._superModel=false}}if(this.prototype.subModelTypes&&h.keys(this.prototype.subModelTypes).length!==h.keys(this._subModels).length){h.each(this.prototype.subModelTypes||[],function(l){var k=g.Relational.store.getObjectByName(l);k&&k.initializeModelHierarchy()})}},findOrCreate:function(j,l){l||(l={});var m=(h.isObject(j)&&l.parse&&this.prototype.parse)?this.prototype.parse(j):j;var k=g.Relational.store.find(this,m);if(h.isObject(j)){if(k&&l.merge!==false){k.set(m,l)}else{if(!k&&l.create!==false){k=this.build(j,l)}}}return k}});h.extend(g.RelationalModel.prototype,g.Semaphore);g.Collection.prototype.__prepareModel=g.Collection.prototype._prepareModel;g.Collection.prototype._prepareModel=function(l,k){var j;if(l instanceof g.Model){if(!l.collection){l.collection=this}j=l}else{k||(k={});k.collection=this;if(typeof this.model.findOrCreate!=="undefined"){j=this.model.findOrCreate(l,k)}else{j=new this.model(l,k)}if(j&&j.isNew()&&!j._validate(l,k)){this.trigger("invalid",this,l,k);j=false}}return j};var i=g.Collection.prototype.__add=g.Collection.prototype.add;g.Collection.prototype.add=function(m,k){if(!(this.model.prototype instanceof g.RelationalModel)){return i.apply(this,arguments)}m=h.isArray(m)?m.slice():[m];k=h.extend({merge:false},k);var j=[],l=[];h.each(m,function(n){if(!(n instanceof g.Model)){n=g.Collection.prototype._prepareModel.call(this,n,k)}if(n){l.push(n);if(!(this.get(n)||this.get(n.cid))){j.push(n)}else{if(n.id!=null){this._byId[n.id]=n}}}},this);i.call(this,l,k);h.each(j,function(n){if(this.get(n)||this.get(n.cid)){this.trigger("relational:add",n,this,k)}},this);return this};var e=g.Collection.prototype.__remove=g.Collection.prototype.remove;g.Collection.prototype.remove=function(l,j){if(!(this.model.prototype instanceof g.RelationalModel)){return e.apply(this,arguments)}l=h.isArray(l)?l.slice():[l];j||(j={});var k=[];h.each(l,function(m){m=this.get(m)||this.get(m.cid);m&&k.push(m)},this);if(k.length){e.call(this,k,j);h.each(k,function(m){this.trigger("relational:remove",m,this,j)},this)}return this};var f=g.Collection.prototype.__reset=g.Collection.prototype.reset;g.Collection.prototype.reset=function(k,j){f.call(this,k,j);if(this.model.prototype instanceof g.RelationalModel){this.trigger("relational:reset",this,j)}return this};var d=g.Collection.prototype.__sort=g.Collection.prototype.sort;g.Collection.prototype.sort=function(j){d.call(this,j);if(this.model.prototype instanceof g.RelationalModel){this.trigger("relational:reset",this,j)}return this};var a=g.Collection.prototype.__trigger=g.Collection.prototype.trigger;g.Collection.prototype.trigger=function(k){if(!(this.model.prototype instanceof g.RelationalModel)){return a.apply(this,arguments)}if(k==="add"||k==="remove"||k==="reset"){var j=this,l=arguments;if(h.isObject(l[3])){l=h.toArray(l);l[3]=h.clone(l[3])}g.Relational.eventQueue.add(function(){a.apply(j,l)})}else{a.apply(this,arguments)}return this};g.RelationalModel.extend=function(j,k){var l=g.Model.extend.apply(this,arguments);l.setup(this);return l}})();