(function(b){var i,h,c;if(typeof window==="undefined"){i=require("underscore");h=require("backbone");c=h;typeof module==="undefined"||(module.exports=c)}else{i=window._;h=window.Backbone;c=window}h.Relational={showWarnings:true};h.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable){throw new Error("Max permits acquired")}else{this._permitsUsed++}},release:function(){if(this._permitsUsed===0){throw new Error("All permits released")}else{this._permitsUsed--}},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(j){if(this._permitsUsed>j){throw new Error("Available permits cannot be less than used permits")}this._permitsAvailable=j}};h.BlockingQueue=function(){this._queue=[]};i.extend(h.BlockingQueue.prototype,h.Semaphore,{_queue:null,add:function(j){if(this.isBlocked()){this._queue.push(j)}else{j()}},process:function(){var j=this._queue;this._queue=[];while(j&&j.length){j.shift()()}},block:function(){this.acquire()},unblock:function(){this.release();if(!this.isBlocked()){this.process()}},isBlocked:function(){return this.isLocked()}});h.Relational.eventQueue=new h.BlockingQueue();h.Store=function(){this._collections=[];this._reverseRelations=[];this._orphanRelations=[];this._subModels=[];this._modelScopes=[c]};i.extend(h.Store.prototype,h.Events,{initializeRelation:function(k,m,j){var l=!i.isString(m.type)?m.type:h[m.type]||this.getObjectByName(m.type);if(l&&l.prototype instanceof h.Relation){new l(k,m,j)}else{h.Relational.showWarnings&&typeof console!=="undefined"&&console.warn("Relation=%o; missing or invalid relation type!",m)}},addModelScope:function(j){this._modelScopes.push(j)},removeModelScope:function(j){this._modelScopes=i.without(this._modelScopes,j)},addSubModels:function(j,k){this._subModels.push({superModelType:k,subModels:j})},setupSuperModel:function(j){i.find(this._subModels,function(k){return i.find(k.subModels||[],function(m,n){var l=this.getObjectByName(m);if(j===l){k.superModelType._subModels[n]=j;j._superModel=k.superModelType;j._subModelTypeValue=n;j._subModelTypeAttribute=k.superModelType.prototype.subModelTypeAttribute;return true}},this)},this)},addReverseRelation:function(k){var j=i.any(this._reverseRelations,function(l){return i.all(k||[],function(n,m){return n===l[m]})});if(!j&&k.model&&k.type){this._reverseRelations.push(k);this._addRelation(k.model,k);this.retroFitRelation(k)}},addOrphanRelation:function(k){var j=i.any(this._orphanRelations,function(l){return i.all(k||[],function(n,m){return n===l[m]})});if(!j&&k.model&&k.type){this._orphanRelations.push(k)}},processOrphanRelations:function(){i.each(this._orphanRelations.slice(0),function(j){var k=h.Relational.store.getObjectByName(j.relatedModel);if(k){this.initializeRelation(null,j);this._orphanRelations=i.without(this._orphanRelations,j)}},this)},_addRelation:function(j,k){if(!j.prototype.relations){j.prototype.relations=[]}j.prototype.relations.push(k);i.each(j._subModels||[],function(l){this._addRelation(l,k)},this)},retroFitRelation:function(k){var j=this.getCollection(k.model,false);j&&j.each(function(l){if(!(l instanceof k.model)){return}new k.type(l,k)},this)},getCollection:function(m,l){if(m instanceof h.RelationalModel){m=m.constructor}var j=m;while(j._superModel){j=j._superModel}var k=i.find(this._collections,function(n){return n.model===j});if(!k&&l!==false){k=this._createCollection(j)}return k},getObjectByName:function(j){var l=j.split("."),k=null;i.find(this._modelScopes,function(m){k=i.reduce(l||[],function(n,o){return n?n[o]:b},m);if(k&&k!==m){return true}},this);return k},_createCollection:function(k){var j;if(k instanceof h.RelationalModel){k=k.constructor}if(k.prototype instanceof h.RelationalModel){j=new h.Collection();j.model=k;this._collections.push(j)}return j},resolveIdForItem:function(j,k){var l=i.isString(k)||i.isNumber(k)?k:null;if(l===null){if(k instanceof h.RelationalModel){l=k.id}else{if(i.isObject(k)){l=k[j.prototype.idAttribute]}}}if(!l&&l!==0){l=null}return l},find:function(k,l){var n=this.resolveIdForItem(k,l);var j=this.getCollection(k);if(j){var m=j.get(n);if(m instanceof k){return m}}return null},register:function(k){var l=this.getCollection(k);if(l){var j=k.collection;l.add(k);this.listenTo(k,"destroy",this.unregister,this);this.listenTo(k,"relational:unregister",this.unregister,this);k.collection=j}},checkId:function(j,m){var k=this.getCollection(j),l=k&&k.get(m);if(l&&j!==l){if(h.Relational.showWarnings&&typeof console!=="undefined"){console.warn("Duplicate id! Old RelationalModel=%o, new RelationalModel=%o",l,j)}throw new Error("Cannot instantiate more than one Backbone.RelationalModel with the same id per type!")}},update:function(j){var k=this.getCollection(j);k._onModelEvent("change:"+j.idAttribute,j,k);j.trigger("relational:change:id",j,k)},unregister:function(k,m,j){this.stopListening(k);var l=this.getCollection(k);l&&l.remove(k,j)},reset:function(){this.stopListening();this._collections=[];this._subModels=[];this._modelScopes=[c]}});h.Relational.store=new h.Store();h.Relation=function(j,k,l){this.instance=j;k=i.isObject(k)?k:{};this.reverseRelation=i.defaults(k.reverseRelation||{},this.options.reverseRelation);this.options=i.defaults(k,this.options,h.Relation.prototype.options);this.reverseRelation.type=!i.isString(this.reverseRelation.type)?this.reverseRelation.type:h[this.reverseRelation.type]||h.Relational.store.getObjectByName(this.reverseRelation.type);this.key=this.options.key;this.keySource=this.options.keySource||this.key;this.keyDestination=this.options.keyDestination||this.keySource||this.key;this.model=this.options.model||this.instance.constructor;this.relatedModel=this.options.relatedModel;if(i.isString(this.relatedModel)){this.relatedModel=h.Relational.store.getObjectByName(this.relatedModel)}if(!this.checkPreconditions()){return}if(!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key){h.Relational.store.addReverseRelation(i.defaults({isAutoRelation:true,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation))}if(j){var m=this.keySource;if(m!==this.key&&typeof this.instance.get(this.key)==="object"){m=this.key}this.setKeyContents(this.instance.get(m));this.relatedCollection=h.Relational.store.getCollection(this.relatedModel);if(this.keySource!==this.key){delete this.instance.attributes[this.keySource]}this.instance._relations[this.key]=this;this.initialize(l);if(this.options.autoFetch){this.instance.fetchRelated(this.key,i.isObject(this.options.autoFetch)?this.options.autoFetch:{})}this.listenTo(this.instance,"destroy",this.destroy).listenTo(this.relatedCollection,"relational:add relational:change:id",this.tryAddRelated).listenTo(this.relatedCollection,"relational:remove",this.removeRelated)}};h.Relation.extend=h.Model.extend;i.extend(h.Relation.prototype,h.Events,h.Semaphore,{options:{createModels:true,includeInJSON:true,isAutoRelation:false,autoFetch:false,parse:false},instance:null,key:null,keyContents:null,relatedModel:null,relatedCollection:null,reverseRelation:null,related:null,checkPreconditions:function(){var n=this.instance,l=this.key,j=this.model,p=this.relatedModel,q=h.Relational.showWarnings&&typeof console!=="undefined";if(!j||!l||!p){q&&console.warn("Relation=%o: missing model, key or relatedModel (%o, %o, %o).",this,j,l,p);return false}if(!(j.prototype instanceof h.RelationalModel)){q&&console.warn("Relation=%o: model does not inherit from Backbone.RelationalModel (%o).",this,n);return false}if(!(p.prototype instanceof h.RelationalModel)){q&&console.warn("Relation=%o: relatedModel does not inherit from Backbone.RelationalModel (%o).",this,p);return false}if(this instanceof h.HasMany&&this.reverseRelation.type===h.HasMany){q&&console.warn("Relation=%o: relation is a HasMany, and the reverseRelation is HasMany as well.",this);return false}if(n&&i.keys(n._relations).length){var o=i.find(n._relations,function(k){return k.key===l},this);if(o){q&&console.warn("Cannot create relation=%o on %o for model=%o: already taken by relation=%o.",this,l,n,o);return false}}return true},setRelated:function(j){this.related=j;this.instance.acquire();this.instance.attributes[this.key]=j;this.instance.release()},_isReverseRelation:function(j){return j.instance instanceof this.relatedModel&&this.reverseRelation.key===j.key&&this.key===j.reverseRelation.key},getReverseRelations:function(j){var k=[];var l=!i.isUndefined(j)?[j]:this.related&&(this.related.models||[this.related]);i.each(l||[],function(m){i.each(m.getRelations()||[],function(n){if(this._isReverseRelation(n)){k.push(n)}},this)},this);return k},destroy:function(){this.stopListening();if(this instanceof h.HasOne){this.setRelated(null)}else{if(this instanceof h.HasMany){this.setRelated(this._prepareCollection())}}i.each(this.getReverseRelations(),function(j){j.removeRelated(this.instance)},this)}});h.HasOne=h.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(j){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);var k=this.findRelated(j);this.setRelated(k);i.each(this.getReverseRelations(),function(l){l.addRelated(this.instance,j)},this)},findRelated:function(j){var l=null;j=i.defaults({parse:this.options.parse},j);if(this.keyContents instanceof this.relatedModel){l=this.keyContents}else{if(this.keyContents||this.keyContents===0){var k=i.defaults({create:this.options.createModels},j);l=this.relatedModel.findOrCreate(this.keyContents,k)}}if(this.related){this.keyId=null}return l},setKeyContents:function(j){this.keyContents=j;this.keyId=h.Relational.store.resolveIdForItem(this.relatedModel,this.keyContents)},onChange:function(m,j,l){if(this.isLocked()){return}this.acquire();l=l?i.clone(l):{};var p=i.isUndefined(l.__related),n=p?this.related:l.__related;if(p){this.setKeyContents(j);var o=this.findRelated(l);this.setRelated(o)}if(n&&this.related!==n){i.each(this.getReverseRelations(n),function(q){q.removeRelated(this.instance,null,l)},this)}i.each(this.getReverseRelations(),function(q){q.addRelated(this.instance,l)},this);if(!l.silent&&this.related!==n){var k=this;this.changed=true;h.Relational.eventQueue.add(function(){k.instance.trigger("change:"+k.key,k.instance,k.related,l,true);k.changed=false})}this.release()},tryAddRelated:function(k,l,j){if((this.keyId||this.keyId===0)&&k.id===this.keyId){this.addRelated(k,j);this.keyId=null}},addRelated:function(l,k){var j=this;l.queue(function(){if(l!==j.related){var m=j.related||null;j.setRelated(l);j.onChange(j.instance,l,i.defaults({__related:m},k))}})},removeRelated:function(k,l,j){if(!this.related){return}if(k===this.related){var m=this.related||null;this.setRelated(null);this.onChange(this.instance,k,i.defaults({__related:m},j))}}});h.HasMany=h.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:h.Collection,collectionKey:true,collectionOptions:{}},initialize:function(j){this.listenTo(this.instance,"relational:change:"+this.key,this.onChange);this.collectionType=this.options.collectionType;if(i.isString(this.collectionType)){this.collectionType=h.Relational.store.getObjectByName(this.collectionType)}if(this.collectionType!==h.Collection&&!(this.collectionType.prototype instanceof h.Collection)){throw new Error("`collectionType` must inherit from Backbone.Collection")}var k=this.findRelated(j);this.setRelated(k)},_prepareCollection:function(l){if(this.related){this.stopListening(this.related)}if(!l||!(l instanceof h.Collection)){var j=i.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions;l=new this.collectionType(null,j)}l.model=this.relatedModel;if(this.options.collectionKey){var k=this.options.collectionKey===true?this.options.reverseRelation.key:this.options.collectionKey;if(l[k]&&l[k]!==this.instance){if(h.Relational.showWarnings&&typeof console!=="undefined"){console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,k,this.options.collectionKey)}}else{if(k){l[k]=this.instance}}}this.listenTo(l,"relational:add",this.handleAddition).listenTo(l,"relational:remove",this.handleRemoval).listenTo(l,"relational:reset",this.handleReset);return l},findRelated:function(j){var l=null;j=i.defaults({parse:this.options.parse},j);if(this.keyContents instanceof h.Collection){this._prepareCollection(this.keyContents);l=this.keyContents}else{var k=[];i.each(this.keyContents,function(m){if(m instanceof this.relatedModel){var n=m}else{n=this.relatedModel.findOrCreate(m,i.extend({merge:true},j,{create:this.options.createModels}))}n&&k.push(n)},this);if(this.related instanceof h.Collection){l=this.related}else{l=this._prepareCollection()}l.set(k,i.defaults({merge:false,parse:false},j))}this.keyIds=i.difference(this.keyIds,i.pluck(l.models,"id"));return l},setKeyContents:function(j){this.keyContents=j instanceof h.Collection?j:null;this.keyIds=[];if(!this.keyContents&&(j||j===0)){this.keyContents=i.isArray(j)?j:[j];i.each(this.keyContents,function(k){var l=h.Relational.store.resolveIdForItem(this.relatedModel,k);if(l||l===0){this.keyIds.push(l)}},this)}},onChange:function(m,j,l){l=l?i.clone(l):{};this.setKeyContents(j);this.changed=false;var n=this.findRelated(l);this.setRelated(n);if(!l.silent){var k=this;h.Relational.eventQueue.add(function(){if(k.changed){k.instance.trigger("change:"+k.key,k.instance,k.related,l,true);k.changed=false}})}},handleAddition:function(l,m,k){k=k?i.clone(k):{};this.changed=true;i.each(this.getReverseRelations(l),function(n){n.addRelated(this.instance,k)},this);var j=this;!k.silent&&h.Relational.eventQueue.add(function(){j.instance.trigger("add:"+j.key,l,j.related,k)})},handleRemoval:function(l,m,k){k=k?i.clone(k):{};this.changed=true;i.each(this.getReverseRelations(l),function(n){n.removeRelated(this.instance,null,k)},this);var j=this;!k.silent&&h.Relational.eventQueue.add(function(){j.instance.trigger("remove:"+j.key,l,j.related,k)})},handleReset:function(l,k){var j=this;k=k?i.clone(k):{};!k.silent&&h.Relational.eventQueue.add(function(){j.instance.trigger("reset:"+j.key,j.related,k)})},tryAddRelated:function(k,l,j){var m=i.contains(this.keyIds,k.id);if(m){this.addRelated(k,j);this.keyIds=i.without(this.keyIds,k.id)}},addRelated:function(l,k){var j=this;l.queue(function(){if(j.related&&!j.related.get(l)){j.related.add(l,i.defaults({parse:false},k))}})},removeRelated:function(k,l,j){if(this.related.get(k)){this.related.remove(k,j)}}});h.RelationalModel=h.Model.extend({relations:null,_relations:null,_isInitialized:false,_deferProcessing:false,_queue:null,_attributeChangeFired:false,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(k,l){if(l&&l.collection){var j=this,n=this.collection=l.collection;delete l.collection;this._deferProcessing=true;var m=function(o){if(o===j){j._deferProcessing=false;j.processQueue();n.off("relational:add",m)}};n.on("relational:add",m);i.defer(function(){m(j)})}h.Relational.store.processOrphanRelations();this._queue=new h.BlockingQueue();this._queue.block();h.Relational.eventQueue.block();try{h.Model.apply(this,arguments)}finally{h.Relational.eventQueue.unblock()}},trigger:function(k){if(k.length>5&&k.indexOf("change")===0){var j=this,l=arguments;h.Relational.eventQueue.add(function(){if(!j._isInitialized){return}var o=true;if(k==="change"){o=j.hasChanged()||j._attributeChangeFired;j._attributeChangeFired=false}else{var n=k.slice(7),m=j.getRelation(n);if(m){o=(l[4]===true);if(o){j.changed[n]=l[2]}else{if(!m.changed){delete j.changed[n]}}}else{if(o){j._attributeChangeFired=true}}}o&&h.Model.prototype.trigger.apply(j,l)})}else{h.Model.prototype.trigger.apply(this,arguments)}return this},initializeRelations:function(j){this.acquire();this._relations={};i.each(i.result(this,"relations")||[],function(k){h.Relational.store.initializeRelation(this,k,j)},this);this._isInitialized=true;this.release();this.processQueue()},updateRelations:function(j){if(this._isInitialized&&!this.isLocked()){i.each(this._relations,function(k){var l=this.attributes[k.keySource]||this.attributes[k.key];if(k.related!==l){this.trigger("relational:change:"+k.key,this,l,j||{})}if(k.keySource!==k.key){delete k.instance.attributes[k.keySource]}},this)}},queue:function(j){this._queue.add(j)},processQueue:function(){if(this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()){this._queue.unblock()}},getRelation:function(j){return this._relations[j]},getRelations:function(){return i.values(this._relations)},fetchRelated:function(q,s,p){s=i.extend({update:true,remove:false},s);var o,k=[],r=this.getRelation(q),m=r&&((r.keyIds&&r.keyIds.slice(0))||((r.keyId||r.keyId===0)?[r.keyId]:[]));if(p){var l=r.related instanceof h.Collection?r.related.models:[r.related];i.each(l,function(t){if(t.id||t.id===0){m.push(t.id)}})}if(m&&m.length){var n=[],l=i.map(m,function(v){var u=h.Relational.store.find(r.relatedModel,v);if(!u){var t={};t[r.relatedModel.prototype.idAttribute]=v;u=r.relatedModel.findOrCreate(t,s);n.push(u)}return u},this);if(r.related instanceof h.Collection&&i.isFunction(r.related.url)){o=r.related.url(l)}if(o&&o!==r.related.url()){var j=i.defaults({error:function(){var t=arguments;i.each(n,function(u){u.trigger("destroy",u,u.collection,s);s.error&&s.error.apply(u,t)})},url:o},s);k=[r.related.fetch(j)]}else{k=i.map(l,function(t){var u=i.defaults({error:function(){if(i.contains(n,t)){t.trigger("destroy",t,t.collection,s);s.error&&s.error.apply(t,arguments)}}},s);return t.fetch(u)},this)}}return k},get:function(k){var l=h.Model.prototype.get.call(this,k);if(!this.dotNotation||k.indexOf(".")===-1){return l}var m=k.split(".");var j=i.reduce(m,function(n,o){if(i.isNull(n)||i.isUndefined(n)){return b}if(!(n instanceof h.Model)){throw new Error("Attribute must be an instanceof Backbone.Model. Is: "+n+", currentSplit: "+o)}return h.Model.prototype.get.call(n,o)},this);if(l!==b&&j!==b){throw new Error("Ambiguous result for '"+k+"'. direct result: "+l+", dotNotation: "+j)}return l||j},set:function(n,o,m){h.Relational.eventQueue.block();var k;if(i.isObject(n)||n==null){k=n;m=o}else{k={};k[n]=o}try{var p=this.id,l=k&&this.idAttribute in k&&k[this.idAttribute];h.Relational.store.checkId(this,l);var j=h.Model.prototype.set.apply(this,arguments);if(!this._isInitialized&&!this.isLocked()){this.constructor.initializeModelHierarchy();h.Relational.store.register(this);this.initializeRelations(m)}else{if(l&&l!==p){h.Relational.store.update(this)}}if(k){this.updateRelations(m)}}finally{h.Relational.eventQueue.unblock()}return j},clone:function(){var j=i.clone(this.attributes);if(!i.isUndefined(j[this.idAttribute])){j[this.idAttribute]=null}i.each(this.getRelations(),function(k){delete j[k.key]});return new this.constructor(j)},toJSON:function(j){if(this.isLocked()){return this.id}this.acquire();var k=h.Model.prototype.toJSON.call(this,j);if(this.constructor._superModel&&!(this.constructor._subModelTypeAttribute in k)){k[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue}i.each(this._relations,function(l){var n=k[l.key],o=l.options.includeInJSON,m=null;if(o===true){if(n&&i.isFunction(n.toJSON)){m=n.toJSON(j)}}else{if(i.isString(o)){if(n instanceof h.Collection){m=n.pluck(o)}else{if(n instanceof h.Model){m=n.get(o)}}if(o===l.relatedModel.prototype.idAttribute){if(l instanceof h.HasMany){m=m.concat(l.keyIds)}else{if(l instanceof h.HasOne){m=m||l.keyId}}}}else{if(i.isArray(o)){if(n instanceof h.Collection){m=[];n.each(function(q){var p={};i.each(o,function(r){p[r]=q.get(r)});m.push(p)})}else{if(n instanceof h.Model){m={};i.each(o,function(p){m[p]=n.get(p)})}}}else{delete k[l.key]}}}if(o){k[l.keyDestination]=m}if(l.keyDestination!==l.key){delete k[l.key]}});this.release();return k}},{setup:function(j){this.prototype.relations=(this.prototype.relations||[]).slice(0);this._subModels={};this._superModel=null;if(this.prototype.hasOwnProperty("subModelTypes")){h.Relational.store.addSubModels(this.prototype.subModelTypes,this)}else{this.prototype.subModelTypes=null}i.each(this.prototype.relations||[],function(k){if(!k.model){k.model=this}if(k.reverseRelation&&k.model===this){var m=true;if(i.isString(k.relatedModel)){var l=h.Relational.store.getObjectByName(k.relatedModel);m=l&&(l.prototype instanceof h.RelationalModel)}if(m){h.Relational.store.initializeRelation(null,k)}else{if(i.isString(k.relatedModel)){h.Relational.store.addOrphanRelation(k)}}}},this);return this},build:function(j,l){this.initializeModelHierarchy();var k=this._findSubModelType(this,j)||this;return new k(j,l)},_findSubModelType:function(m,l){if(m._subModels&&m.prototype.subModelTypeAttribute in l){var k=l[m.prototype.subModelTypeAttribute];var j=m._subModels[k];if(j){return j}else{for(k in m._subModels){j=this._findSubModelType(m._subModels[k],l);if(j){return j}}}}return null},initializeModelHierarchy:function(){this.inheritRelations();if(this.prototype.subModelTypes){var k=i.keys(this._subModels);var j=i.omit(this.prototype.subModelTypes,k);i.each(j,function(m){var l=h.Relational.store.getObjectByName(m);l&&l.initializeModelHierarchy()})}},inheritRelations:function(){if(!i.isUndefined(this._superModel)&&!i.isNull(this._superModel)){return}h.Relational.store.setupSuperModel(this);if(this._superModel){this._superModel.inheritRelations();if(this._superModel.prototype.relations){var j=i.select(this._superModel.prototype.relations||[],function(k){return !i.any(this.prototype.relations||[],function(l){return k.relatedModel===l.relatedModel&&k.key===l.key},this)},this);this.prototype.relations=j.concat(this.prototype.relations)}}else{this._superModel=false}},findOrCreate:function(j,l){l||(l={});var m=(i.isObject(j)&&l.parse&&this.prototype.parse)?this.prototype.parse(i.clone(j)):j;var k=h.Relational.store.find(this,m);if(i.isObject(j)){if(k&&l.merge!==false){delete l.collection;delete l.url;k.set(m,l)}else{if(!k&&l.create!==false){k=this.build(j,l)}}}return k},find:function(j,k){k||(k={});k.create=false;return this.findOrCreate(j,k)}});i.extend(h.RelationalModel.prototype,h.Semaphore);h.Collection.prototype.__prepareModel=h.Collection.prototype._prepareModel;h.Collection.prototype._prepareModel=function(l,k){var j;if(l instanceof h.Model){if(!l.collection){l.collection=this}j=l}else{k||(k={});k.collection=this;if(typeof this.model.findOrCreate!=="undefined"){j=this.model.findOrCreate(l,k)}else{j=new this.model(l,k)}if(j&&j.isNew()&&!j._validate(l,k)){this.trigger("invalid",this,l,k);j=false}}return j};var g=h.Collection.prototype.__set=h.Collection.prototype.set;h.Collection.prototype.set=function(m,k){if(!(this.model.prototype instanceof h.RelationalModel)){return g.apply(this,arguments)}if(k&&k.parse){m=this.parse(m,k)}if(!i.isArray(m)){m=m?[m]:[]}var j=[],l=[];i.each(m,function(n){if(!(n instanceof h.Model)){n=h.Collection.prototype._prepareModel.call(this,n,k)}if(n){l.push(n);if(!(this.get(n)||this.get(n.cid))){j.push(n)}else{if(n.id!=null){this._byId[n.id]=n}}}},this);g.call(this,l,i.defaults({parse:false},k));i.each(j,function(n){if(this.get(n)||this.get(n.cid)){this.trigger("relational:add",n,this,k)}},this);return this};var e=h.Collection.prototype.__remove=h.Collection.prototype.remove;h.Collection.prototype.remove=function(l,j){if(!(this.model.prototype instanceof h.RelationalModel)){return e.apply(this,arguments)}l=i.isArray(l)?l.slice(0):[l];j||(j={});var k=[];i.each(l,function(m){m=this.get(m)||(m&&this.get(m.cid));m&&k.push(m)},this);if(k.length){e.call(this,k,j);i.each(k,function(m){this.trigger("relational:remove",m,this,j)},this)}return this};var f=h.Collection.prototype.__reset=h.Collection.prototype.reset;h.Collection.prototype.reset=function(k,j){j=i.extend({merge:true},j);f.call(this,k,j);if(this.model.prototype instanceof h.RelationalModel){this.trigger("relational:reset",this,j)}return this};var d=h.Collection.prototype.__sort=h.Collection.prototype.sort;h.Collection.prototype.sort=function(j){d.call(this,j);if(this.model.prototype instanceof h.RelationalModel){this.trigger("relational:reset",this,j)}return this};var a=h.Collection.prototype.__trigger=h.Collection.prototype.trigger;h.Collection.prototype.trigger=function(k){if(!(this.model.prototype instanceof h.RelationalModel)){return a.apply(this,arguments)}if(k==="add"||k==="remove"||k==="reset"||k==="sort"){var j=this,l=arguments;if(i.isObject(l[3])){l=i.toArray(l);l[3]=i.clone(l[3])}h.Relational.eventQueue.add(function(){a.apply(j,l)})}else{a.apply(this,arguments)}return this};h.RelationalModel.extend=function(j,k){var l=h.Model.extend.apply(this,arguments);l.setup(this);return l}})();