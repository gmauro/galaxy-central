function OutputTerminal(A,B){this.element=A;this.connectors=[];this.datatype=B}$.extend(OutputTerminal.prototype,{connect:function(A){this.connectors.push(A)},disconnect:function(A){this.connectors.splice($.inArray(A,this.connectors),1)},redraw:function(){$.each(this.connectors,function(A,B){B.redraw()})},destroy:function(){$.each(this.connectors.slice(),function(A,B){B.destroy()})}});function InputTerminal(A,B){this.element=A;this.connectors=[];this.max_connections=1;this.datatypes=B}$.extend(InputTerminal.prototype,{connect:function(A){this.connectors.push(A)},disconnect:function(A){this.connectors.splice($.inArray(A,this.connectors),1)},can_accept:function(A){if(this.connectors.length<this.max_connections){for(t in this.datatypes){if(A.datatype=="input"){return true}if(issubtype(A.datatype,this.datatypes[t])){return true}}}return false},redraw:function(){$.each(this.connectors,function(A,B){B.redraw()})},destroy:function(){$.each(this.connectors.slice(),function(A,B){B.destroy()})}});function Connector(B,A){this.canvas=null;this.dragging=false;this.inner_color="#EEEEEE"}$.extend(Connector.prototype,{connect:function(B,A){this.handle1=B;this.handle1.connect(this);this.handle2=A;this.handle2.connect(this)},destroy:function(){if(this.handle1){this.handle1.disconnect(this)}if(this.handle2){this.handle2.disconnect(this)}$(this.canvas).remove()},redraw:function(){if(!this.canvas){this.canvas=document.createElement("canvas");$("body").append(this.canvas);if(this.dragging){this.canvas.style.zIndex="300"}}var C=$(this.handle1.element).offset();var N=C.left+5;var M=C.top+5;var C=$(this.handle2.element).offset();var P=C.left+5;var O=C.top+5;var L=100;var E=Math.min(N,P);var H=Math.max(N,P);var D=Math.min(M,O);var G=Math.max(M,O);var B=Math.min(Math.max(Math.abs(G-D)/2,100),300);var F=E-L;var I=D-L;var J=H-E+2*L;var A=G-D+2*L;this.canvas.style.left=F+"px";this.canvas.style.top=I+"px";this.canvas.setAttribute("width",J);this.canvas.setAttribute("height",A);var C=$(this.handle1.element).offset();var C=$(this.handle2.element).offset();N-=F;M-=I;P-=F;O-=I;var K=this.canvas.getContext("2d");K.lineCap="round";K.strokeStyle="#999";K.lineWidth=7;K.beginPath();K.moveTo(N,M);K.bezierCurveTo(N+B,M,P-B,O,P,O);K.stroke();K.strokeStyle=this.inner_color;K.lineWidth=5;K.beginPath();K.moveTo(N,M);K.bezierCurveTo(N+B,M,P-B,O,P,O);K.stroke()}});function Node(A){this.element=A;this.input_terminals={};this.output_terminals={};this.has_errors=false}$.extend(Node.prototype,{enable_input_terminal:function(C,A,B){node=this;$(C).each(function(){var D=this.terminal=new InputTerminal(this,B);D.node=node;D.name=A;$(this).droppable({tolerance:"intersect",accept:function(E){return(E.terminal)&&(D.can_accept(E.terminal))},activeClass:"input-terminal-active",over:function(F,E){E.helper.terminal.connectors[0].inner_color="#BBFFBB"},out:function(F,E){E.helper.terminal.connectors[0].inner_color="#EEEEEE"},drop:function(H,F){var E=F.draggable.element.terminal;var G=F.droppable.element.terminal;var I=new Connector();I.connect(E,G);I.redraw()}});node.input_terminals[A]=D})},enable_output_terminal:function(C,A,B){node=this;$(C).each(function(){var D=this.terminal=new OutputTerminal(this,B);D.node=node;D.name=A;$(this).draggable({scroll:true,helper:function(){var E=$('<div class="drag-terminal" style="position: absolute;"></div>').get(0);E.terminal=new OutputTerminal(E);var F=new Connector();this.drag_temp_connector=F;F.dragging=true;F.connect(this.terminal,E.terminal);return E},drag:function(F,E){E.helper.terminal.redraw()},stop:function(F,E){this.drag_temp_connector.destroy()}});node.output_terminals[A]=D})},destroy:function(){$.each(this.input_terminals,function(A,B){B.destroy();$(B.element).droppableDestroy()});$.each(this.output_terminals,function(A,B){B.destroy();$(B.element).draggableDestroy()});$(this.element).draggableDestroy().remove();workflow.remove_node(this)},make_active:function(){$(this.element).addClass("toolForm-active")},make_inactive:function(){$(this.element).removeClass("toolForm-active")},init_field_data:function(C){var B=this.element;this.form_html=C.form_html;this.tool_state=C.tool_state;var A=this;b=B.find(".toolFormBody");b.find("div").remove();$.each(C.data_inputs,function(E,D){t=$("<div class='terminal input-terminal'></div>");A.enable_input_terminal(t,D.name,D.extensions);b.append($("<div class='form-row dataRow'>"+D.name+"</div></div>").prepend(t))});if((C.data_inputs.length>0)&&(C.data_outputs.length>0)){b.append($("<div class='rule'></div>"))}$.each(C.data_outputs,function(F,D){var E=$("<div class='terminal output-terminal'></div>");A.enable_output_terminal(E,D.name,D.extension);b.append($("<div class='form-row dataRow'>"+D.name+"</div>").append(E))});workflow.node_changed(this)},update_field_data:function(A){this.tool_state=A.state;this.form_html=A.form_html;this.has_errors=A.has_errors;if(this.has_errors){$(this.element).addClass("tool-node-error")}else{$(this.element).removeClass("tool-node-error")}if(workflow.active_node==this){workflow.activate_node(this)}},error:function(C){var A=$(this.element).find(".toolFormBody");A.find("div").remove();var B="<div style='color: red; text-style: italic;'>"+C+"</div>";this.form_html=$(B);A.html(B);workflow.node_changed(this)}});function Workflow(){this.id_counter=0;this.nodes={};this.name=null;this.has_changes=false}$.extend(Workflow.prototype,{add_node:function(A){A.id=String(this.id_counter);this.id_counter++;this.nodes[A.id]=A;this.has_changes=true},remove_node:function(A){if(this.active_node==A){this.clear_active_node()}delete this.nodes[A.id];this.has_changes=true},remove_all:function(){wf=this;$.each(this.nodes,function(B,A){A.destroy();wf.remove_node(A)})},to_simple:function(){var A={};$.each(this.nodes,function(B,D){var E={};$.each(D.input_terminals,function(F,G){E[G.name]=null;$.each(G.connectors,function(H,I){E[G.name]={node_id:I.handle1.node.id,output_name:I.handle1.name}})});var C={id:D.id,tool_id:D.tool_id,tool_state:D.tool_state,has_errors:D.has_errors,input_connections:E,position:$(D.element).position()};A[D.id]=C});return{steps:A}},from_simple:function(A){wf=this;var B=0;wf.name=A.name;$.each(A.steps,function(E,D){var C=prebuild_node_for_tool(D.tool_id,D.name);C.init_field_data(D);if(D.position){C.element.css({top:D.position.top,left:D.position.left})}C.id=E;wf.nodes[C.id]=C;B=Math.max(B,parseInt(E))});wf.id_counter=B+1;$.each(A.steps,function(E,D){var C=wf.nodes[E];$.each(D.input_connections,function(G,F){if(F){var H=wf.nodes[F.node_id];var I=new Connector();I.connect(H.output_terminals[F.output_name],C.input_terminals[G]);I.redraw()}})})},clear_active_node:function(){if(this.active_node){this.active_node.make_inactive()}parent.show_form_for_tool("<div>No node selected</div>")},activate_node:function(A){this.clear_active_node();parent.show_form_for_tool(A.form_html,A);A.make_active();this.active_node=A},node_changed:function(A){if(this.active_node==A){this.activate_node(A)}}});function prebuild_node_for_tool(B,F){var E=$("<div class='toolForm' style='position: absolute; min-width: 130px'></div>");var C=new Node(E);C.tool_id=B;var I=$("<div class='toolFormTitle unselectable'>"+F+"</div>");E.append(I);E.css("left",$(window).scrollLeft()+20);E.css("top",$(window).scrollTop()+20);var H=$("<div class='toolFormBody'></div>");var D="<div><img height='16' align='middle' src='../images/loading_small_white_bg.gif'/> loading tool info...</div>";H.append(D);C.form_html=$(D);E.append(H);var G=$("<div class='buttons' style='float: right'></div>");G.append($("<img src='../images/delete_icon.png' />").click(function(){C.destroy()}).hover(function(){$(this).attr("src","../images/delete_icon_dark.png")},function(){$(this).attr("src","../images/delete_icon.png")}));E.appendTo("body");var A=E.width();G.prependTo(I);A+=(G.width()+10);E.css("width",A);$(E).draggable({cursor:"move",scroll:true,scrollSensitivity:10,scrollSpeed:20,containment:$("#shim"),click:function(){document.body.removeChild(this);document.body.appendChild(this);workflow.activate_node(C)},start:function(){workflow.activate_node(C);$(this).css("z-index","1000")},drag:function(){$(this).find(".terminal").each(function(){this.terminal.redraw()})},stop:function(){document.body.removeChild(this);document.body.appendChild(this);$(this).css("z-index","100");$(this).find(".terminal").each(function(){this.terminal.redraw()})}});return C}var ext_to_type=null;var type_to_type=null;function issubtype(B,A){B=ext_to_type[B];A=ext_to_type[A];return(A in type_to_type[B])}function populate_datatype_info(A){ext_to_type=A.ext_to_class_name;type_to_type=A.class_to_classes}