function Terminal(a){this.element=a;this.connectors=[]}Terminal.prototype={connect:function(a){this.connectors.push(a);if(this.node){this.node.changed()}},disconnect:function(a){this.connectors.splice($.inArray(a,this.connectors),1);if(this.node){this.node.changed()}},redraw:function(){$.each(this.connectors,function(a,b){b.redraw()})},destroy:function(){$.each(this.connectors.slice(),function(a,b){b.destroy()})}};function OutputTerminal(a,b){Terminal.call(this,a);this.datatype=b}OutputTerminal.prototype=new Terminal;function InputTerminal(a,b){Terminal.call(this,a);this.datatypes=b}InputTerminal.prototype=new Terminal;$.extend(InputTerminal.prototype,{can_accept:function(a){if(this.connectors.length<1){for(t in this.datatypes){if(a.datatype=="input"){return true}if(issubtype(a.datatype,this.datatypes[t])){return true}}}return false}});function Connector(b,a){this.canvas=null;this.dragging=false;this.inner_color="#FFFFFF";this.outer_color="#D8B365";if(b&&a){this.connect(b,a)}}$.extend(Connector.prototype,{connect:function(b,a){this.handle1=b;this.handle1.connect(this);this.handle2=a;this.handle2.connect(this)},destroy:function(){if(this.handle1){this.handle1.disconnect(this)}if(this.handle2){this.handle2.disconnect(this)}$(this.canvas).remove()},redraw:function(){var d=$("#canvas-container");if(!this.canvas){this.canvas=document.createElement("canvas");if(window.G_vmlCanvasManager){G_vmlCanvasManager.initElement(this.canvas)}d.append($(this.canvas));if(this.dragging){this.canvas.style.zIndex="300"}}var m=function(c){return $(c).offset().left-d.offset().left};var h=function(c){return $(c).offset().top-d.offset().top};var g=m(this.handle1.element)+5;var f=h(this.handle1.element)+5;var o=m(this.handle2.element)+5;var l=h(this.handle2.element)+5;var e=100;var j=Math.min(g,o);var a=Math.max(g,o);var i=Math.min(f,l);var s=Math.max(f,l);var b=Math.min(Math.max(Math.abs(s-i)/2,100),300);var n=j-e;var r=i-e;var p=a-j+2*e;var k=s-i+2*e;this.canvas.style.left=n+"px";this.canvas.style.top=r+"px";this.canvas.setAttribute("width",p);this.canvas.setAttribute("height",k);g-=n;f-=r;o-=n;l-=r;var q=this.canvas.getContext("2d");q.lineCap="round";q.strokeStyle=this.outer_color;q.lineWidth=7;q.beginPath();q.moveTo(g,f);q.bezierCurveTo(g+b,f,o-b,l,o,l);q.stroke();q.strokeStyle=this.inner_color;q.lineWidth=5;q.beginPath();q.moveTo(g,f);q.bezierCurveTo(g+b,f,o-b,l,o,l);q.stroke()}});function Node(a){this.element=a;this.input_terminals={};this.output_terminals={};this.tool_errors={}}$.extend(Node.prototype,{enable_input_terminal:function(d,a,b){var c=this;$(d).each(function(){var e=this.terminal=new InputTerminal(this,b);e.node=c;e.name=a;$(this).bind("dropstart",function(f){f.dragProxy.terminal.connectors[0].inner_color="#BBFFBB"}).bind("dropend",function(f){f.dragProxy.terminal.connectors[0].inner_color="#FFFFFF"}).bind("drop",function(f){new Connector(f.dragTarget.terminal,f.dropTarget.terminal).redraw()}).bind("hover",function(){if(e.connectors.length>0){var f=$("<div class='callout'></div>").css({display:"none"}).appendTo("body").append($("<div class='buttons'></div>").append($("<img src='../images/delete_icon.png' />").click(function(){$.each(e.connectors,function(h,g){g.destroy()});f.remove()}))).bind("mouseleave",function(){$(this).remove()});f.css({top:$(this).offset().top-2,left:$(this).offset().left-f.width(),"padding-right":$(this).width()}).show()}});c.input_terminals[a]=e})},enable_output_terminal:function(d,a,b){var c=this;$(d).each(function(){var f=this;var e=this.terminal=new OutputTerminal(this,b);e.node=c;e.name=a;$(this).bind("dragstart",function(i){var g=$('<div class="drag-terminal" style="position: absolute;"></div>').appendTo("#canvas-container").get(0);g.terminal=new OutputTerminal(g);var j=new Connector();j.dragging=true;j.connect(this.terminal,g.terminal);$.dropManage({filter:function(h){return this.terminal.can_accept(e)}}).addClass("input-terminal-active");return g}).bind("drag",function(h){var g=function(){var j=$(h.dragProxy).offsetParent().offset(),i=h.offsetX-j.left,k=h.offsetY-j.top;$(h.dragProxy).css({left:i,top:k});h.dragProxy.terminal.redraw()};g();$("#canvas-container").get(0).scroll_panel.test(h,g)}).bind("dragend",function(g){g.dragProxy.terminal.connectors[0].destroy();$(g.dragProxy).remove();$.dropManage().removeClass("input-terminal-active")});c.output_terminals[a]=e})},redraw:function(){$.each(this.input_terminals,function(a,b){b.redraw()});$.each(this.output_terminals,function(a,b){b.redraw()})},destroy:function(){$.each(this.input_terminals,function(a,b){b.destroy()});$.each(this.output_terminals,function(a,b){b.destroy()});workflow.remove_node(this);$(this.element).remove()},make_active:function(){$(this.element).addClass("toolForm-active")},make_inactive:function(){var a=this.element.get(0);(function(b){b.removeChild(a);b.appendChild(a)})(a.parentNode);$(a).removeClass("toolForm-active")},init_field_data:function(e){var d=this.element;if(e.type){this.type=e.type}this.form_html=e.form_html;this.tool_state=e.tool_state;this.tool_errors=e.tool_errors;if(this.tool_errors){d.addClass("tool-node-error")}else{d.removeClass("tool-node-error")}var c=this;var a=d.find(".toolFormBody");a.find("div").remove();var g=$("<div class='inputs'></div>").appendTo(a);$.each(e.data_inputs,function(h,b){var f=$("<div class='terminal input-terminal'></div>");c.enable_input_terminal(f,b.name,b.extensions);g.append($("<div class='form-row dataRow input-data-row' name='"+b.name+"'>"+b.label+"</div>").prepend(f))});if((e.data_inputs.length>0)&&(e.data_outputs.length>0)){a.append($("<div class='rule'></div>"))}$.each(e.data_outputs,function(j,b){var h=$("<div class='terminal output-terminal'></div>");c.enable_output_terminal(h,b.name,b.extension);var f=b.name;if(b.extension!="input"){f=f+" ("+b.extension+")"}a.append($("<div class='form-row dataRow'>"+f+"</div>").append(h))});workflow.node_changed(this)},update_field_data:function(e){var c=$(this.element),d=this;this.tool_state=e.tool_state;this.form_html=e.form_html;this.tool_errors=e.tool_errors;if(this.tool_errors){c.addClass("tool-node-error")}else{c.removeClass("tool-node-error")}var f=c.find("div.inputs");var b=$("<div class='inputs'></div>");var a=f.find("div.input-data-row");$.each(e.data_inputs,function(j,g){var h=$("<div class='terminal input-terminal'></div>");d.enable_input_terminal(h,g.name,g.extensions);f.find("div[name="+g.name+"]").each(function(){$(this).find(".input-terminal").each(function(){var i=this.terminal.connectors[0];if(i){h[0].terminal.connectors[0]=i;i.handle2=h[0].terminal}});$(this).remove()});b.append($("<div class='form-row dataRow input-data-row' name='"+g.name+"'>"+g.label+"</div>").prepend(h))});f.replaceWith(b);f.find("div.input-data-row > .terminal").each(function(){this.terminal.destroy()});this.changed();this.redraw()},error:function(d){var a=$(this.element).find(".toolFormBody");a.find("div").remove();var c="<div style='color: red; text-style: italic;'>"+d+"</div>";this.form_html=c;a.html(c);workflow.node_changed(this)},changed:function(){workflow.node_changed(this)}});function Workflow(){this.id_counter=0;this.nodes={};this.name=null;this.has_changes=false}$.extend(Workflow.prototype,{add_node:function(a){a.id=this.id_counter;a.element.attr("id","wf-node-step-"+a.id);this.id_counter++;this.nodes[a.id]=a;this.has_changes=true;a.workflow=this},remove_node:function(a){if(this.active_node==a){this.clear_active_node()}delete this.nodes[a.id];this.has_changes=true},remove_all:function(){wf=this;$.each(this.nodes,function(b,a){a.destroy();wf.remove_node(a)})},to_simple:function(){var a={};$.each(this.nodes,function(b,d){var e={};$.each(d.input_terminals,function(f,g){e[g.name]=null;$.each(g.connectors,function(h,j){e[g.name]={id:j.handle1.node.id,output_name:j.handle1.name}})});var c={id:d.id,type:d.type,tool_id:d.tool_id,tool_state:d.tool_state,tool_errors:d.tool_errors,input_connections:e,position:$(d.element).position()};a[d.id]=c});return{steps:a}},from_simple:function(a){wf=this;var b=0;wf.name=a.name;$.each(a.steps,function(e,d){var c=prebuild_node("tool",d.name,d.tool_id);c.init_field_data(d);if(d.position){c.element.css({top:d.position.top,left:d.position.left})}c.id=d.id;wf.nodes[c.id]=c;b=Math.max(b,parseInt(e))});wf.id_counter=b+1;$.each(a.steps,function(e,d){var c=wf.nodes[e];$.each(d.input_connections,function(g,f){if(f){var h=wf.nodes[f.id];var i=new Connector();i.connect(h.output_terminals[f.output_name],c.input_terminals[g]);i.redraw()}})})},clear_active_node:function(){if(this.active_node){this.active_node.make_inactive();this.active_node=null}parent.show_form_for_tool("<div>No node selected</div>")},activate_node:function(a){if(this.active_node!=a){this.clear_active_node();parent.show_form_for_tool(a.form_html,a);a.make_active();this.active_node=a}},node_changed:function(a){this.has_changes=true;if(this.active_node==a){parent.show_form_for_tool(a.form_html,a)}}});function prebuild_node(j,h,m){var g=$("<div class='toolForm toolFormInCanvas'></div>");var d=new Node(g);d.type=j;if(j=="tool"){d.tool_id=m}var l=$("<div class='toolFormTitle unselectable'>"+h+"</div>");g.append(l);g.css("left",$(window).scrollLeft()+20);g.css("top",$(window).scrollTop()+20);var k=$("<div class='toolFormBody'></div>");var e="<div><img height='16' align='middle' src='../images/loading_small_white_bg.gif'/> loading tool info...</div>";k.append(e);d.form_html=e;g.append(k);var i=$("<div class='buttons' style='float: right;'></div>");i.append($("<img src='../images/delete_icon.png' />").click(function(b){d.destroy()}).hover(function(){$(this).attr("src","../images/delete_icon_dark.png")},function(){$(this).attr("src","../images/delete_icon.png")}));g.appendTo("#canvas-container");var c=$("#canvas-container").position();g.css({left:(-c.left)+10,top:(-c.top)+10});var a=g.width();i.prependTo(l);a+=(i.width()+10);g.css("width",a);$(g).bind("dragstart",function(){workflow.activate_node(d)}).bind("dragend",function(){workflow.node_changed(this)}).bind("dragclickonly",function(){workflow.activate_node(d)}).bind("drag",function(n){var f=$(this).offsetParent().offset(),b=n.offsetX-f.left,o=n.offsetY-f.top;$(this).css({left:b,top:o});$(this).find(".terminal").each(function(){this.terminal.redraw()})});return d}var ext_to_type=null;var type_to_type=null;function issubtype(b,a){b=ext_to_type[b];a=ext_to_type[a];return(a in type_to_type[b])}function populate_datatype_info(a){ext_to_type=a.ext_to_class_name;type_to_type=a.class_to_classes}function ScrollPanel(a){this.panel=a}$.extend(ScrollPanel.prototype,{test:function(f,c){clearTimeout(this.timeout);var a=f.pageX,g=f.pageY;b=$(this.panel),panel_pos=b.position(),panel_w=b.width(),panel_h=b.height();viewport=b.parent();viewport_w=viewport.width(),viewport_h=viewport.height(),viewport_offset=viewport.offset(),min_x=viewport_offset.left,min_y=viewport_offset.top,max_x=min_x+viewport.width(),max_y=min_y+viewport.height(),p_min_x=-(panel_w-viewport_w),p_min_y=-(panel_h-viewport_h),p_max_x=0,p_max_y=0,moved=false,close_dist=5,nudge=23;if(a-close_dist<min_x){if(panel_pos.left<p_max_x){var d=Math.min(nudge,p_max_x-panel_pos.left);b.css("left",panel_pos.left+d);moved=true}}else{if(a+close_dist>max_x){if(panel_pos.left>p_min_x){var d=Math.min(nudge,panel_pos.left-p_min_x);b.css("left",panel_pos.left-d);moved=true}}else{if(g-close_dist<min_y){if(panel_pos.top<p_max_y){var d=Math.min(nudge,p_max_y-panel_pos.top);b.css("top",panel_pos.top+d);moved=true}}else{if(g+close_dist>max_y){if(panel_pos.top>p_min_y){var d=Math.min(nudge,panel_pos.top-p_min_x);b.css("top",(panel_pos.top-d)+"px");moved=true}}}}}if(moved){c();var b=this;this.timeout=setTimeout(function(){b.test(f,c)},50)}},drag:function(g,h){clearTimeout(this.timeout);var c=g.dragProxy,a=this.panel,b=a.position(),i=a.width(),d=a.height();viewport=a.parent();viewport_w=viewport.width(),viewport_h=viewport.height(),element_w=c.width(),element_h=c.height(),moved=false,close_dist=5,nudge=23,p_min_x=-(i-viewport_w),p_min_y=-(d-viewport_h),p_max_x=0,p_max_y=0,min_vis_x=-b.left,max_vis_x=min_vis_x+viewport_w,min_vis_y=-b.top,max_vis_y=min_vis_y+viewport_h,mouse_x=h.position.left+instance.offset.click.left;mouse_y=h.position.top+instance.offset.click.top;if((b.left<p_max_x)&&(mouse_x-close_dist<min_vis_x)){var j=Math.min(nudge,p_max_x-b.left);a.css("left",b.left+j);moved=true;instance.offset.parent.left+=j;h.position.left-=j}if((!moved)&&(b.left>p_min_x)&&(mouse_x+close_dist>max_vis_x)){var j=Math.min(nudge,b.left-p_min_x);a.css("left",b.left-j);moved=true;instance.offset.parent.left-=j;h.position.left+=j}if((!moved)&&(b.top<p_max_y)&&(mouse_y-close_dist<min_vis_y)){var j=Math.min(nudge,p_max_y-b.top);a.css("top",b.top+j);var f=a.position().top-b.top;instance.offset.parent.top+=f;h.position.top-=f;moved=true}if((!moved)&&(b.top>p_min_y)&&(mouse_y+close_dist>max_vis_y)){var j=Math.min(nudge,b.top-p_min_x);a.css("top",(b.top-j)+"px");var f=b.top-a.position().top;instance.offset.parent.top-=f;h.position.top+=f;moved=true}h.position.left=Math.max(h.position.left,0);h.position.top=Math.max(h.position.top,0);h.position.left=Math.min(h.position.left,i-element_w);h.position.top=Math.min(h.position.top,d-element_h);if(moved){$.ui.ddmanager.prepareOffsets(instance,g)}if(moved){this.timeout=setTimeout(function(){instance.mouseMove(g)},50)}},stop:function(c,b){var a=$(this).data("draggable");clearTimeout(a.timeout)}});