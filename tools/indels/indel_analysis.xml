<tool id="indel_analysis" name="Indel Analysis" version="1.0.0">
  <description></description>
  <command interpreter="python">
    indel_analysis.py
      --input=$input1
      --threshold=$threshold
      --out_ins=$out_ins
      --out_del=$out_del
  </command>
  <inputs>
    <param format="sam" name="input1" type="data" label="Select sam file to analyze" />
    <param name="threshold" type="float" value="0.015" size="5" label="Frequency threshold" help="Cutoff" />
  </inputs>
  <outputs>
    <data format="interval" name="out_del" />
    <data format="interval" name="out_ins" />
  </outputs>
  <tests>
    <test>
      <param name="input1" value="indel_analysis_in1.sam" ftype="sam"/>
      <param name="threshold" value="0.017"/>
      <output name="out_del" file="indel_analysis_out1.interval" ftype="interval"/>
      <output name="out_ins" file="indel_analysis_out2.interval" ftype="interval"/>
    </test>
    <test>
      <param name="input1" value="indel_analysis_in2.sam" ftype="sam"/>
      <param name="threshold" value="0.08"/>
      <output name="out_del" file="indel_analysis_out3.interval" ftype="interval"/>
      <output name="out_ins" file="indel_analysis_out4.interval" ftype="interval"/>
    </test>
  </tests>
  <help>

**What it does**

Given an input sam file, this tool provides analysis of the indels. It filters out matches that do not meet the frequency threshold. The way this frequency of occurence is calculated is different for deletions and insertions. The CIGAR string's "M" can indicate an exact match or a mismatch. For SAM containing the following bits of information (assuming the reference "ACTGCTCGAT")::

 CHROM  POS  CIGAR       SEQ
   ref    3  2M1I3M   TATCTC
   ref    2  3M1D2M    ATGTC
   ref    4  2M2I3M  GTTGAAG
   ref    1  2M2D2M     ACCT
   ref    2  3M1I2M   TCCATC
   ref    7      4M     CTAT
   ref    5      5M    CGTGA

The following totals would be calculated::

 Counts for chromosome "ref", where "-" indicates a deletion and
 "+" an insertion
 ----------------------------------------------------------------
  POS  BASE  NUMREADS  DELPROPCALC  DELPROP  INSPROPCALC  INSPROP
    1     A         1          1/1     1.00           --       --
    2     A         1          1/2     0.50           --       --
          C         1          1/2     0.50           --       --
    3     T         3          3/4     0.75           --       --
         --         1          1/4     0.25           --       --
    4     A         1          1/5     0.20           --       --
          G         2          2/5     0.40           --       --
          C         1          1/5     0.20           --       --
          -         1          1/5     0.20           --       --
    5     C         4          4/5     0.80           --       --
          T         1          1/5     0.20           --       --
         +A         1          ---      ---          1/6     0.17
         +T         1          ---      ---          1/6     0.17
    6     A         1          1/6     0.17           --       --
          C         1          1/6     0.17           --       --
          T         4          4/6     0.67           --       --
        +TG         1          ---      ---          1/7     0.14
    7     A         1          1/6     0.17           --       --
          C         3          3/6     0.50           --       --
          G         1          1/6     0.17           --       --
          T         1          1/6     0.17           --       --
    8     G         2          2/3     0.67           --       --
          T         1          1/3     0.33           --       --
    9     A         2          2/2     1.00           --       --
   10     T         1          1/1     1.00           --       --

Note that the way these are calculated may not be immediately clear. First, the basic total number of reads at a given position is the number of reads with a particular base plus the number of reads with that a deletion at that given position. Note that deletions of two bases and one base would be counted separately. Insertions are not counted in this total, which is used to calculate the proportion of occurrences of each individual base and deletion. For position 4 above, the reference base is G, and there are 2 occurrences of it along with one each of mismatching bases A and C. Also, there is on 1-base deletion. So there are a total of 5 matches/mismatches/deletions, and the proportions for each base are either 1/5 = 0.20 or 2/5 = 0.40, and for the deletion it is 1/5 = 0.20. Insertions are slightly more complicated. Each insertion is regarded individually, and the total number of occurrences of that insertion is divided by the sum of the number of its occurrences and the basic total. So for position 5, there are a total of 5 matches/mismatches/deletions, and two insertions that each occur once, so each has a insertion has a proportion of 1/6 = 0.17.

The DELPROP or INSPROP needs to be greater than the threshold frequency specified by the user.

The output varies for deletions and insertions, though for both, the first three columns are chromosome, start position, and end position.

Columns in the deletions file::

                       Column  Description
 ----------------------------  ------------------------------------------------------------------------------------
  1                     Chrom  Chromosome
  2                     Start  Starting position
  3                       End  Ending position
  4 Number of Deleted Base(s)  The number of bases deleted at Start position
  5      Frequency Percentage  Frequency of this exact deletion (2 and 1 are mutually exclusive), as percentage (%)

Columns in the insertions file::

                  Column  Description
 --------------------------  -------------------------------------------------------------------------------------------------------------
  1                Chrom  Chromosome
  2                Start  Starting position
  3                  End  Ending position (always Start + 1 for insertions)
  4     Inserted Base(s)  The exact base(s) inserted at Start position
  5 Freq. Perc. at Start  Frequency of this exact insertion given Start position ("GG" and "G" are considered distinct), as percentage (%)
  6   Freq. Perc. at End  Frequency of this exact insertion given End position ("GG" and "G" are considered distinct), as percentage (%)

Before using this tool, you probably will want to use the Filter SAM for indels tool to filter out indels on bases with insufficient quality scores, but this is not required.


-----

**Example**

If you set the threshold to 0.0 and have the following SAM file::

 r770     89  ref   6   37    7M1I5M  =  0   0              TGGATCTTCATAG              !0//110AA44/1  XT:A:U  CM:i:2  SM:i:37  AM:i:0       X0:i:1    X1:i:0  XM:i:1  XO:i:1  XG:i:1  MD:Z:22
 r1124   113  ref   4    0       23M  =  0   0    CATCGTTCTGTTAGATCTACGTA    PQRVUMNXYRPUXYXWXSOSZ]M  XT:A:R  CM:i:0   SM:i:0  AM:i:0  X0:i:163148            XM:i:0  XO:i:0  XG:i:0  MD:Z:23
 r1789   177  ref   6    0       17M  =  0   0          TCGATCGCTTAGTTCTC          SQQWZY]]YXTSY]]ZM  XT:A:R  CM:i:0   SM:i:0  AM:i:0  X0:i:163148            XM:i:0  XO:i:0  XG:i:0  MD:Z:23
 r3671   153  ref  10   37    6M1I6M  =  0   0              TCTCTTTAGGTCT              /&lt;&lt;!"0///////  XT:A:U  CM:i:2  SM:i:37  AM:i:0       X0:i:1    X1:i:0  XM:i:1  XO:i:1  XG:i:1  MD:Z:22
 r3824   153  ref   5   37    8M1I7M  =  0   0           ATTGATGTTCTTAGAT           4;6//11!"100110/  XT:A:U  CM:i:2  SM:i:37  AM:i:0       X0:i:1    X1:i:0  XM:i:1  XO:i:1  XG:i:1  MD:Z:22
 r4800    16  ref   7  255    5M2D6M  =  0   0                CGATCTTTGAT                IIIIIIIIIIC  XT:A:U  CM:i:2  SM:i:37  AM:i:0       X0:i:1    X1:i:0  XM:i:1  XO:i:1  XG:i:1  MD:Z:22
 r5612   151  ref   5   37    8M1D9M  =  0   0          ATCTATCTTTTGATCTC          /&lt;&lt;!"0/4/*/7//B0/  XT:A:U  CM:i:2  SM:i:37  AM:i:0       X0:i:1    X1:i:0  XM:i:1  XO:i:1  XG:i:1  MD:Z:22
 r5612   151  ref  11   37   3M1I10M  =  0   0             CTCCTTAGCTCTCC             /&lt;&lt;!"0/4//7//0  XT:A:U  CM:i:2  SM:i:37  AM:i:0       X0:i:1    X1:i:0  XM:i:1  XO:i:1  XG:i:1  MD:Z:22
 r9145   115  ref  11    0       19M  =  0  -1       CTCTTAGCTCTCCGAATTAG        7753:&lt;5#"4!&amp;=9518A&gt;  XT:A:R  CM:i:2   SM:i:0  AM:i:0       X0:i:4  X1:i:137  XM:i:2  XO:i:0  XG:i:0  MD:Z:23
 r11770   89  ref  10   37   10M2I8M  =  0   0       TCTCTTAGATGGCTCCGTAT       00/02!!0/120210AA4/1  XT:A:U  CM:i:2  SM:i:37  AM:i:0       X0:i:1    X1:i:0  XM:i:1  XO:i:1  XG:i:1  MD:Z:22
 r13671  153  ref   1   37  12M1I12M  =  0   0  TCGCATCGATCTCCGTAGATCTCCG  /&lt;""&lt;!"0///////00/!!0121/  XT:A:U  CM:i:2  SM:i:37  AM:i:0       X0:i:1    X1:i:0  XM:i:1  XO:i:1  XG:i:1  MD:Z:22
 r13824  153  ref  13   37    9M1I7M  =  0   0          CATAGATCTACCGGATT          4;6//11!"11100110  XT:A:U  CM:i:2  SM:i:37  AM:i:0       X0:i:1    X1:i:0  XM:i:1  XO:i:1  XG:i:1  MD:Z:22
 r24800   16  ref   3  255   15M2D9M  =  0   0   GCATCTATCTGATAGCTCCGAATT   IIIIIIIII45"CCCIII?IIIII  XT:A:U  CM:i:2  SM:i:37  AM:i:0       X0:i:1    X1:i:0  XM:i:1  XO:i:1  XG:i:1  MD:Z:22
 r25612  151  ref   1   37    9M1D5M  =  0   0             TCGCATCGACTCTT             0/4/*/7//00/1C  XT:A:U  CM:i:2  SM:i:37  AM:i:0       X0:i:1    X1:i:0  XM:i:1  XO:i:1  XG:i:1  MD:Z:22
 r25612  151  ref  21   37    4M1I7M  =  0   0               TGCGTTATTGGG               &lt;!"0/70/BC01  XT:A:U  CM:i:2  SM:i:37  AM:i:0       X0:i:1    X1:i:0  XM:i:1  XO:i:1  XG:i:1  MD:Z:22
 r29962   16  ref  20   37    4M1I7M  =  0   0              CTCCGGTATGAGG              &lt;!"0/70/7BC01  XT:A:U  CM:i:2  SM:i:37  AM:i:0  X0:i:1  X1:i:0  XM:i:1  XO:i:1  XG:i:1  MD:Z:22

The following will be produced (deletions file followed by insertions file)::

 ref   10   11   1   1   9.09
 ref   12   14   2   1   7.69
 ref   13   14   1   1   7.69
 ref   18   20   2   1   8.33

 ref   13   14    C   1    6.25    6.67
 ref   13   14    T   2   12.50   13.33
 ref   14   15    C   1    6.67    7.14
 ref   16   17    T   1    7.14    7.69
 ref   20   21   GG   1    8.33    8.33
 ref   22   23    A   1    8.33   11.11
 ref   24   25    G   1   11.11   12.50
 ref   25   26    T   1   12.50   14.29


  </help>
</tool>
